<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ZANDER</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                /* ==============================================
                   DESIGN SYSTEM TOKENS
                   ============================================== */

                /* Color Palette: Core LCARS colors */
                --lcars-black: #000000;
                --lcars-white: #ffffff;
                --lcars-orange: #ff9900;
                --lcars-purple: #cc99cc;
                --lcars-red: #cc6666;
                --lcars-blue: #9999cc;
                --lcars-beige: #ffcc99;
                --lcars-gray: #999999;

                /* Color Palette: Dark shades for surfaces */
                --lcars-dark-1: #111111;
                --lcars-dark-2: #222222;
                --lcars-dark-3: #444444;

                /* Legacy alias (prefer --lcars-black) */
                --lcars-bg: var(--lcars-black);

                /* Typography */
                --lcars-font: "Antonio", sans-serif;

                /* Spacing */
                --lcars-gutter: 5px;
                --lcars-gap: 10px;

                /* Border Radii */
                --lcars-radius-xs: 5px;
                --lcars-radius-sm: 16px;
                --lcars-radius-md: 20px;
                --lcars-radius-lg: 30px;

                /* Legacy aliases (prefer --lcars-radius-*) */
                --gutter: var(--lcars-gutter);
                --radius: var(--lcars-radius-lg);
                --gap: var(--lcars-gap);

                /* Layout variables */
                --sidebar-width: 160px;
                --header-height: 80px;

                /* Focus system */
                --lcars-focus-outline-width: 3px;
                --lcars-focus-outline-color: var(--lcars-white);
                --lcars-focus-outline-offset: 2px;

                /* ==============================================
                   COMPONENT-LEVEL VARIABLE DOCUMENTATION
                   These are set inline by JS or via component CSS:

                   --cat-color: Category button background (set by JS)
                   --lcars-button-bg: Button background color
                   --lcars-button-fg: Button foreground color
                   --lcars-button-radius: Button border radius
                   --lcars-button-hover-filter: Hover effect filter
                   --lcars-pin-size: Pin/circular button size
                   --lcars-pin-bg: Pin background color
                   --lcars-pin-fg: Pin foreground color
                   --lcars-focus-bar-*: Focus bar positioning vars
                   ============================================== */
            }

            /* ==============================================
               THEME VARIANTS
               Applied via data-theme attribute on <body>
               ============================================== */
            body[data-theme="laan"] {
                --theme-main: #830025;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="data"] {
                --theme-main: #da9706;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="doctor"] {
                --theme-main: #008b8b; /* LCARS-ish teal */
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="chapel"] {
                --theme-main: var(--lcars-white);
                --shape-color: var(--theme-main);
                --theme-secondary: var(--lcars-gray);
            }

            body[data-theme="spock"] {
                --theme-main: #003366;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="seven"] {
                /* LCARS-friendly darker silver main tone */
                --theme-main: #8c8c8c;
                --shape-color: var(--theme-main);
                /* Borg green secondary accent */
                --theme-secondary: #7fff00;
            }

            body[data-theme="mbenga"] {
                --theme-main: #92b7dd;
                --shape-color: var(--theme-main);
                --theme-secondary: var(--lcars-white);
            }

            body[data-theme="shran"] {
                --theme-main: #282b29;
                --shape-color: var(--theme-main);
                --theme-secondary: #78bff5;
            }

            * {
                box-sizing: border-box;
            }

            /* ==============================================
               FOCUS SYSTEM
               Unified to 3px for strong a11y contrast
               ============================================== */

            /* Default focus style for all interactive elements */
            :focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
                box-shadow: none;
            }

            /* Explicit helper class for outline focus (same as default, for clarity) */
            .lcars-focus-outline:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* Focus bar helper: draws a directional bar using ::after pseudo-element */
            .lcars-focus-bar:focus-visible::after {
                content: "";
                position: absolute;

                /* Edge selection via custom properties */
                top: var(--lcars-focus-bar-top, -10px);
                bottom: var(--lcars-focus-bar-bottom, auto);
                left: var(--lcars-focus-bar-left, 0);
                right: var(--lcars-focus-bar-right, 0);

                /* Size + color */
                height: var(--lcars-focus-bar-height, 4px);
                width: var(--lcars-focus-bar-width, auto);
                background-color: var(--lcars-focus-bar-color, var(--lcars-white));
            }

            /* Pill buttons, inputs, and config buttons use outline focus */
            .lcars-pill:focus-visible,
            input:focus-visible,
            select:focus-visible,
            textarea:focus-visible,
            .category-config-btn:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* ==============================================
               BODY: Layout + Theme Variables (merged)
               ============================================== */
            body {
                /* Theme variables (can be overridden by data-theme) */
                --theme-main: #830025; /* default: La'An */
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );

                /* Layout */
                background-color: var(--lcars-black);
                color: var(--lcars-orange);
                font-family: var(--lcars-font);
                margin: 0;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            /* LCARS Layout Grid */
            .lcars-app {
                display: grid;
                grid-template-columns: 1fr 160px; /* Content | Sidebar */
                grid-template-rows: 70px 1fr 70px; /* Header | Main | Footer */
                height: 100%;
                padding: 10px;
                gap: 0; /* Seamless connections */
            }

            /* Header (Left Part)
               - Structural grid container and LCARS frame segment shell
               - Receives LCARS chrome via lcars-frame-segment modifiers */
            .header-bar {
                grid-column: 1;
                grid-row: 1;
                display: flex;
                align-items: stretch;
                justify-content: flex-end;
                padding-right: 0;
                margin-right: -1px;
                height: 40px;
                align-self: start;
            }

            /* LCARS frame segment primitives */
            .lcars-frame-segment {
                background-color: var(--shape-color);
            }

            .lcars-frame-segment--horizontal {
                display: flex;
                align-items: center;
            }

            .lcars-frame-segment--left-rounded {
                border-top-left-radius: var(--radius);
                border-bottom-left-radius: var(--radius);
            }

            .header-fill {
                flex: 1;
                height: 40px;
            }

            .header-end-cap {
                width: 20px;
                background-color: var(--shape-color);
            }

            .app-title {
                color: var(--lcars-orange);
                background-color: var(--lcars-black);
                font-size: 44px;
                line-height: 1;
                font-weight: bold;
                text-transform: uppercase;
                padding: 0 10px;
                margin: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                letter-spacing: -1px;
                border: none;
                cursor: pointer;
            }

            .app-title:focus-visible {
                outline: none;
                box-shadow: none;
                position: relative;
            }

            .app-title:focus-visible::after {
                content: "";
                position: absolute;
                left: 0;
                right: 0;
                bottom: -10px;
                height: 4px;
                background-color: var(--lcars-white);
            }

            /* Sidebar (Full Height Column) */
            .sidebar-container {
                grid-column: 2;
                grid-row: 1 / 4;
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
            }

            /* Generic LCARS elbow component */
            .lcars-elbow {
                height: 70px;
                width: 100%;

                /* Default orientation and radii (can be overridden per use) */
                --elbow-position: bottom left;
                --elbow-radius-top-left: 0;
                --elbow-radius-top-right: 0;
                --elbow-radius-bottom-right: 0;
                --elbow-radius-bottom-left: 0;

                background: radial-gradient(
                    circle at var(--elbow-position),
                    var(--lcars-bg) var(--radius),
                    var(--shape-color) calc(var(--radius) + 0.5px)
                );

                border-top-left-radius: var(--elbow-radius-top-left);
                border-top-right-radius: var(--elbow-radius-top-right);
                border-bottom-right-radius: var(--elbow-radius-bottom-right);
                border-bottom-left-radius: var(--elbow-radius-bottom-left);
            }

            /* Top Elbow Connector (right side, opening downward) */
            .sidebar-top-cap {
                --elbow-position: bottom left;
                --elbow-radius-top-right: var(--radius);
            }

            /* Middle Sidebar Track - now a flex container for scroll buttons + categories */
            .sidebar-track {
                flex: 1;
                min-height: 0; /* Allow flex item to shrink below content size */
                background: none;
                display: flex;
                flex-direction: column;
                gap: 0;
                padding: 0 0 0 31px;
                position: relative; /* Establish positioning context for submenus */
            }

            /* ==============================================
               LCARS SCROLL CONTAINER PRIMITIVE
               A scrollable container with hidden scrollbar.
               Mouse wheel and touch scrolling still work.
               ============================================== */
            .lcars-scroll-container {
                overflow-y: auto;
                /* Note: overflow-x is NOT set to allow child elements (like submenus) to overflow */
                /* Hide scrollbar but keep functionality */
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
            }

            .lcars-scroll-container::-webkit-scrollbar {
                display: none; /* Chrome/Safari/Opera */
            }

            /* ==============================================
               LCARS ARROW BUTTON PRIMITIVE
               A flat directional control with triangle indicator.
               Used for scroll controls, pagination, carousels, etc.
               ============================================== */
            .lcars-arrow-btn {
                --lcars-arrow-btn-height: 24px;
                --lcars-arrow-btn-bg: var(--shape-color);
                --lcars-arrow-btn-bg-hover: var(--lcars-beige);
                --lcars-arrow-btn-bg-focus: var(--shape-color);
                --lcars-arrow-btn-arrow-size: 40px 12px;
                --lcars-arrow-btn-arrow-color: var(--lcars-black);

                display: flex;
                align-items: center;
                justify-content: center;
                height: var(--lcars-arrow-btn-height);
                min-height: var(--lcars-arrow-btn-height);
                background-color: var(--lcars-arrow-btn-bg);
                border: none;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .lcars-arrow-btn:hover {
                background-color: var(--lcars-arrow-btn-bg-hover);
            }

            .lcars-arrow-btn:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: calc(-1 * var(--lcars-focus-outline-width));
                background-color: var(--lcars-arrow-btn-bg-focus);
            }

            .lcars-arrow-btn:disabled {
                cursor: default;
            }

            .lcars-arrow-btn:disabled svg {
                opacity: 0.3;
            }

            .lcars-arrow-btn svg {
                width: 40px;
                height: 12px;
                fill: var(--lcars-arrow-btn-arrow-color);
                transition: fill 0.2s, opacity 0.2s;
            }

            /* ==============================================
               SIDEBAR-SPECIFIC STYLES
               Compose primitives for sidebar scroll navigation
               ============================================== */

            /* Scrollable category container - composes lcars-scroll-container */
            .sidebar-categories {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                gap: 5px;
                padding: 5px 0;
            }

            /* Sidebar scroll buttons - compose lcars-arrow-btn */
            .sidebar-scroll-up {
                width: 100%;
                margin-bottom: 2px;
            }

            .sidebar-scroll-down {
                width: 100%;
                margin-top: 2px;
            }

            /* Bottom Elbow Connector (right side, opening upward) */
            .sidebar-bottom-cap {
                --elbow-position: top left;
                --elbow-radius-bottom-right: var(--radius);
            }

            .footer-bar {
                grid-column: 1;
                grid-row: 3;
                display: flex;
                align-items: center;
                justify-content: flex-start;
                padding-left: 0;
                padding-right: 0;
                gap: 0;
                margin-right: -1px;
                height: 40px;
                align-self: end;
            }

            .footer-bar > .lcars-footer-bar-button,
            .footer-bar > .settings-wrapper > .lcars-footer-bar-button {
                height: 100%;
                border-radius: 0;
                margin: 0;
                border-left: 5px solid var(--lcars-black);
            }

            .footer-bar .settings-wrapper {
                height: 100%;
                display: flex;
            }

            /* Sidebar Buttons (LCARS category actions) */
            .cat-btn {
                /* Rely on lcars-button defaults for most behavior, but keep sidebar-specific layout */
                --lcars-button-bg: var(--cat-color, var(--shape-color));
                --lcars-button-fg: var(--lcars-black);
                --lcars-button-radius: 0px;

                display: inline-flex;
                align-items: center;
                justify-content: flex-end;
                height: 50px;
                width: 100%;

                font-family: var(--lcars-font);
                font-size: 1.1rem;
                font-weight: bold;
                text-transform: uppercase;

                padding-right: 15px;
                text-align: right;

                transition: background-color 0.2s;

                /* Configure LCARS focus bar for left-edge vertical indicator */
                --lcars-focus-bar-top: 0;
                --lcars-focus-bar-bottom: 0;
                --lcars-focus-bar-left: -10px;
                --lcars-focus-bar-right: auto;
                --lcars-focus-bar-width: 4px;
                --lcars-focus-bar-height: 100%;
            }

            .cat-btn:hover,
            .cat-btn.active {
                background-color: var(--lcars-beige);
            }

            .cat-btn:focus-visible {
                outline: none;
            }

            /* Nested Categories */
            .cat-wrapper {
                position: static; /* Allow submenu to escape scroll container */
                width: 100%;
            }

            .cat-submenu {
                display: none;
                position: fixed; /* Fixed position escapes overflow clipping */
                width: 160px; /* Match sidebar width */
                flex-direction: column;
                gap: 5px;
                padding-right: 10px; /* Space between levels */
                z-index: 1000;
                /* Position will be set via JS */
            }

            .cat-wrapper:hover > .cat-submenu,
            .cat-wrapper.submenu-open > .cat-submenu {
                display: flex;
            }

            /* Show submenu on keyboard focus of parent or child buttons */
            .cat-wrapper:has(> .cat-btn:focus-visible) > .cat-submenu,
            .cat-wrapper:has(.cat-submenu .cat-btn:focus-visible) > .cat-submenu {
                display: flex;
            }

            .cat-submenu .cat-btn {
                border-radius: 0;
            }

            /* Main Content */
            .main-content {
                grid-column: 1;
                grid-row: 1 / 4;
                overflow-y: auto;
                padding: 20px;
                border: none;
                border-radius: var(--lcars-radius-lg);
                margin-right: -25px;
                margin-top: 42px;
                margin-bottom: 42px;
            }

            .bookmark-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
            }

            /* ==============================================
               LCARS BREADCRUMB
               Reusable location/path readout component.
               ============================================== */

            .lcars-breadcrumb {
                display: flex;
                align-items: center;
                gap: 8px;

                margin-bottom: 10px;
                font-size: 0.9rem;
                letter-spacing: 1px;

                color: var(--lcars-beige);
                opacity: 0.85;
            }

            .lcars-breadcrumb-label {
                color: var(--lcars-orange);
                text-transform: uppercase;
                font-weight: bold;
            }

            .lcars-breadcrumb-path {
                display: inline-flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 6px;
            }

            .lcars-breadcrumb-segment {
                display: inline-flex;
                align-items: center;
                justify-content: center;

                padding: 2px 6px;
                border-radius: var(--lcars-radius-xs);

                background-color: transparent;
                color: inherit;

                font-size: 0.85rem;
                text-transform: uppercase;
                border: none;
                cursor: default;
                white-space: nowrap;
            }

            .lcars-breadcrumb-segment:not(.is-current) {
                cursor: pointer;
                background-color: rgba(255, 255, 255, 0.04);
            }

            .lcars-breadcrumb-segment:not(.is-current):hover {
                background-color: rgba(255, 255, 255, 0.12);
            }

            .lcars-breadcrumb-segment.is-current {
                font-weight: bold;
                color: var(--lcars-orange);
            }

            .lcars-breadcrumb-segment.is-root {
                border-radius: var(--lcars-radius-sm);
                background-color: rgba(255, 153, 0, 0.18);
            }

            .lcars-breadcrumb-separator {
                opacity: 0.6;
            }

            .lcars-breadcrumb-segment:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* Main view containers */
            .main-view {
                display: none;
            }

            .main-view.active {
                display: block;
            }

            /* Settings / About panels share LCARS framing */
            .settings-panel,
            .about-panel {
                color: var(--lcars-orange);
                max-width: 900px;
                margin: 0 auto;
                text-align: left;
                height: 100%;
            }

            .settings-panel {
                display: grid;
                grid-template-columns: 16px 1fr;
                column-gap: 20px;
                height: 100%;
            }

            .settings-accent {
                grid-row: 1 / span 3;
                background-color: var(--shape-color);
                border-radius: var(--lcars-radius-md);
            }

            /* Settings content: flex column for section layout */
            .settings-content {
                grid-column: 2;
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .settings-panel h1,
            .about-panel h1 {
                font-size: 2rem;
                margin-bottom: 15px;
                letter-spacing: 2px;
            }

            .settings-section {
                margin-top: 20px;
                padding-top: 10px;
                border-top: 2px solid var(--theme-main);
            }

            .settings-content .settings-section:first-of-type {
                /* Category Configuration section takes remaining height */
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
            }

            #settingsCategorySectionMain {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
            }

            #settingsCategorySectionMain .category-config-list {
                flex: 1 1 auto;
            }

            .settings-section h2 {
                font-size: 1.1rem;
                margin: 0 0 10px 0;
                letter-spacing: 1px;
            }

            .about-panel p {
                line-height: 1.5;
                margin: 5px 0;
            }

            .about-meta {
                font-size: 0.9rem;
                opacity: 0.8;
                margin-top: 20px;
            }

            .settings-status {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.8rem;
                opacity: 0.8;
                margin-bottom: 10px;
                letter-spacing: 1px;
            }

            /* Base LCARS button primitive */
            .lcars-button {
                /* Layout */
                display: inline-flex;
                align-items: center;
                justify-content: center;

                /* Box */
                min-height: 32px;
                padding: 0 15px;
                border: none;
                border-radius: var(--lcars-button-radius, 0px);
                background-color: var(--lcars-button-bg, var(--lcars-beige));
                color: var(--lcars-button-fg, var(--lcars-black));

                /* Text */
                font-family: var(--lcars-font);
                font-size: 1.1rem;
                font-weight: bold;
                text-transform: uppercase;
                white-space: normal;
                word-break: break-word;

                /* Behavior */
                cursor: pointer;
                position: relative;
            }

            /* Derived LCARS pill variant (rounded button) */
            .lcars-pill {
                --lcars-button-radius: var(--lcars-radius-md);
            }

            /* Hover behavior (can be disabled per-variant) */
            .lcars-button:hover {
                filter: var(--lcars-button-hover-filter, brightness(1.1));
            }

            /* LCARS color utility classes for buttons */
            .lcars-color-orange {
                --lcars-button-bg: var(--lcars-orange);
                --lcars-button-fg: var(--lcars-black);
            }

            .lcars-color-dark {
                --lcars-button-bg: var(--lcars-dark-3);
                --lcars-button-fg: var(--lcars-beige);
            }

            .lcars-color-danger {
                --lcars-button-bg: var(--lcars-red);
                --lcars-button-fg: var(--lcars-black);
            }

            .lcars-color-beige {
                --lcars-button-bg: var(--lcars-beige);
                --lcars-button-fg: var(--lcars-black);
            }

            /* ==============================================
               LCARS ACTION ROLE HELPERS
               Extension points for context-specific button styling.
               These are intentionally minimal - add overrides as needed.
               ============================================== */
            .lcars-dialog-action {
                /* Extension point: dialog-specific button tweaks */
            }

            .lcars-settings-action {
                /* Extension point: settings panel button tweaks */
            }

            .lcars-footer-action {
                /* Extension point: footer bar button tweaks */
            }

            /* Theme selector layout */
            #themeControlsContainer {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            #themeControlsContainer .lcars-settings-action {
                min-width: 140px;
                justify-content: center;
            }

            #themeControlsContainer .lcars-settings-action.theme-active {
                background-color: var(--theme-main, var(--lcars-beige));
                color: var(--lcars-black);
                box-shadow: 0 0 0 2px var(--lcars-white);
            }



            /* ==============================================
               LCARS CATEGORY TILE
               Reusable component representing a category/folder.
               Designed to sit alongside .bookmark-tile in .bookmark-grid.
               ============================================== */

            .lcars-category-tile {
                display: grid;
                grid-template-columns: 12px 1fr;
                grid-template-rows: auto 1fr;
                min-height: 110px;

                position: relative;
                border-radius: 0;
                border-bottom-right-radius: var(--lcars-radius-lg);
                overflow: hidden;
                cursor: pointer;
                text-decoration: none;

                --lcars-category-bg: var(--cat-color, var(--theme-main));
                --lcars-category-fg: var(--lcars-black);
                --lcars-category-stripe-bg: var(--lcars-category-bg);

                background-color: var(--lcars-category-bg);
                color: var(--lcars-category-fg);

                transition:
                    transform 0.1s ease-out,
                    filter 0.1s ease-out;
            }

            .lcars-category-tile::before {
                content: "";
                grid-row: 1 / -1;
                grid-column: 1;
                background-color: var(--lcars-category-stripe-bg);
            }

            .lcars-category-tile::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: var(--lcars-radius-md);
                height: var(--lcars-radius-md);
                background: radial-gradient(
                    circle at 100% 100%,
                    transparent var(--lcars-radius-md),
                    var(--lcars-black) var(--lcars-radius-md)
                );
                z-index: 1;
            }

            /* ==============================================
               LCARS CATEGORY TILE
               Reusable component representing a category/folder.
               Designed to sit alongside .bookmark-tile in .bookmark-grid.
               ============================================== */

            .lcars-category-tile {
                display: grid;
                grid-template-columns: 12px 1fr;
                grid-template-rows: auto 1fr;
                min-height: 110px;

                position: relative;
                border-radius: 0;
                border-bottom-right-radius: var(--lcars-radius-lg);
                overflow: hidden;
                cursor: pointer;
                text-decoration: none;

                --lcars-category-bg: var(--cat-color, var(--theme-main));
                --lcars-category-fg: var(--lcars-black);
                --lcars-category-stripe-bg: var(--lcars-category-bg);

                background-color: var(--lcars-category-bg);
                color: var(--lcars-category-fg);

                transition:
                    transform 0.1s ease-out,
                    filter 0.1s ease-out;
            }

            .lcars-category-tile::before {
                content: "";
                grid-row: 1 / -1;
                grid-column: 1;
                background-color: var(--lcars-category-stripe-bg);
            }

            .lcars-category-tile::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: var(--lcars-radius-md);
                height: var(--lcars-radius-md);
                background: radial-gradient(
                    circle at 100% 100%,
                    transparent var(--lcars-radius-md),
                    var(--lcars-black) var(--lcars-radius-md)
                );
                z-index: 1;
            }

            .lcars-category-tile:hover {
                filter: brightness(1.1);
                transform: scale(1.02);
            }

            .lcars-category-tile-label {
                grid-column: 1 / -1;
                grid-row: 1;
                padding: 8px 12px 6px 24px;
                font-size: 0.95rem;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--lcars-category-fg);
            }

            .lcars-category-tile-meta {
                grid-column: 2;
                grid-row: 2;
                padding: 8px 12px 10px 8px;
                font-size: 0.75rem;
                line-height: 1.3;
                background-color: var(--lcars-black);
                color: var(--theme-secondary, var(--lcars-gray));
                border-top-left-radius: 14px;

                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                gap: 4px;
            }

            .lcars-category-tile-meta-primary {
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .lcars-category-tile-meta-secondary {
                opacity: 0.85;
            }

            .lcars-category-tile:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            .lcars-category-tile:hover {
                filter: brightness(1.1);
                transform: scale(1.02);
            }

            .lcars-category-tile-label {
                grid-column: 1 / -1;
                grid-row: 1;
                padding: 8px 12px 6px 24px;
                font-size: 0.95rem;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--lcars-category-fg);
            }

            .lcars-category-tile-meta {
                grid-column: 2;
                grid-row: 2;
                padding: 8px 12px 10px 8px;
                font-size: 0.75rem;
                line-height: 1.3;
                background-color: var(--lcars-black);
                color: var(--theme-secondary, var(--lcars-gray));
                border-top-left-radius: 14px;

                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                gap: 4px;
            }

            .lcars-category-tile-meta-primary {
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .lcars-category-tile-meta-secondary {
                opacity: 0.85;
            }

            .lcars-category-tile:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            .bookmark-tile {
                position: relative;
                background-color: var(--theme-main);
                color: var(--lcars-black);
                padding: 0;
                border-radius: 0;
                border-bottom-right-radius: var(--lcars-radius-lg);
                cursor: default;
                text-decoration: none;
                display: grid;
                grid-template-columns: 15px 1fr;
                grid-template-rows: auto 1fr auto;
                min-height: 140px;
                transition:
                    transform 0.1s,
                    filter 0.1s;
                user-select: none;
                overflow: hidden;
            }

            /* Top-left corner cutout - shows body background with LCARS curve */
            .bookmark-tile::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: var(--lcars-radius-md);
                height: var(--lcars-radius-md);
                background: radial-gradient(circle at 100% 100%, transparent var(--lcars-radius-md), var(--lcars-black) var(--lcars-radius-md));
                z-index: 10;
            }

            .bookmark-tile:hover {
                filter: brightness(1.1);
                transform: scale(1.02);
            }

            .bookmark-title {
                grid-column: 1 / -1;
                grid-row: 1;
                font-size: 1rem;
                font-weight: bold;
                line-height: 1.2;
                text-transform: uppercase;
                padding: 10px 15px 8px 25px;
                color: var(--lcars-black);
                background-color: var(--theme-main);
            }

            .bookmark-description {
                grid-column: 2;
                grid-row: 2;
                font-size: 0.78rem;
                line-height: 1.35;
                color: var(--theme-secondary, var(--lcars-gray));
                background-color: var(--lcars-black);
                padding: 10px 15px 10px 10px;
                border-top-left-radius: 15px;
                overflow: hidden;
                word-wrap: break-word;
                word-break: break-word;
                display: -webkit-box;
                -webkit-line-clamp: 4;
                -webkit-box-orient: vertical;
            }

            .bookmark-url-footer {
                grid-column: 2;
                grid-row: 3;
                background-color: var(--lcars-black);
                margin-left: 0;
                z-index: 2;
                padding: 8px 12px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 10px;
            }

            .bookmark-footer-btn {
                /* LCARS pin variant for bookmark footer actions */
                --lcars-pin-size: 18px;

                width: var(--lcars-pin-size);
                height: var(--lcars-pin-size);
                border-radius: 50%;
                border: none;
                padding: 0;

                display: inline-flex;
                align-items: center;
                justify-content: center;

                background-color: var(--lcars-pin-bg, var(--theme-main));
                color: var(--lcars-black);
                cursor: pointer;
                transition: transform 0.2s, filter 0.2s;
            }

            .bookmark-footer-btn:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            .bookmark-footer-btn:hover {
                transform: scale(1.2);
                filter: brightness(1.2);
            }

            .bookmark-url-icon {
                --lcars-pin-bg: var(--theme-main);
            }

            .bookmark-edit-icon {
                --lcars-pin-bg: var(--lcars-orange);
            }

            /* Footer Actions: LCARS buttons with footer-specific layout */
            .lcars-footer-bar-button {
                /* Rely on lcars-button for core shape/typography */
                display: inline-flex;
                align-items: center;
                justify-content: flex-end;
                min-height: 40px;
                padding: 0 15px;
                width: 150px;
                white-space: nowrap;

                /* Footer-specific colors */
                --lcars-button-bg: var(--theme-secondary, color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                ));
                --lcars-button-fg: var(--lcars-black);
                background-color: var(--lcars-button-bg);
                color: var(--lcars-button-fg);

                /* Configure LCARS focus bar: top-edge indicator */
                --lcars-focus-bar-top: -9px;
                --lcars-focus-bar-bottom: auto;
                --lcars-focus-bar-left: 0;
                --lcars-focus-bar-right: 0;
                --lcars-focus-bar-height: 4px;
            }

            .lcars-footer-bar-button:hover {
                background-color: var(--lcars-white);
            }

            .action-btn--small {
                height: 32px;
                font-size: 0.9rem;
                padding: 0 10px;
                width: 100%;
                justify-content: center;
            }

            /* Footer buttons use the LCARS focus bar helper (no outline) */
            .lcars-footer-bar-button:focus-visible {
                outline: none;
            }

            .lcars-footer-bar-button:focus-visible::after {
                /* use lcars-focus-bar helper via variables configured on .lcars-footer-bar-button */
                content: "";
                position: absolute;
                left: 0;
                right: 0;
                top: var(--lcars-focus-bar-top, -9px);
                bottom: var(--lcars-focus-bar-bottom, auto);
                height: var(--lcars-focus-bar-height, 4px);
                background-color: var(--lcars-focus-bar-color, var(--lcars-white));
                border-radius: 0;
            }




            #aboutBtn {
                border-right: 5px solid var(--lcars-black);
            }

            /* Borg green footer buttons when SEVEN OF NINE theme is active */
            body[data-theme="seven"] .action-btn {
                background-color: var(--theme-secondary);
            }

            /* Settings Menu */
            .settings-wrapper {
                display: flex;
                align-items: center;
                height: 40px;
            }

            /* Dialogs */
            dialog {
                background-color: var(--lcars-black);
                color: var(--lcars-orange);
                border: 2px solid var(--shape-color);
                border-radius: var(--lcars-radius-md);
                padding: 0;
                max-width: 540px;
                width: 90%;
            }

            dialog::backdrop {
                background-color: rgba(0, 0, 0, 0.8);
            }

            .lcars-dialog {
                display: flex;
                flex-direction: column;
                border-radius: var(--lcars-radius-md);
                overflow: hidden;
            }

            /* Color picker specific overlay */
            /* Color picker uses slightly larger radius for visual distinction */
            #colorPickerDialog {
                max-width: 520px;
                border-radius: calc(var(--lcars-radius-md) + 6px);
                border-color: var(--shape-color);
            }

            #colorPickerDialog .lcars-dialog-header {
                background-color: var(--shape-color);
                color: var(--lcars-black);
            }

            #colorPickerDialog .lcars-dialog-body {
                padding: 20px;
                background-color: var(--lcars-black);
            }

            #colorPickerDialog .lcars-dialog-footer {
                display: flex;
                justify-content: flex-end;
                padding: 10px 20px 18px 20px;
                background-color: var(--lcars-black);
            }

            .lcars-dialog-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: var(--shape-color);
                color: var(--lcars-black);
                padding: 10px 16px;
            }

            .lcars-dialog-title {
                font-size: 1.2rem;
                font-weight: bold;
                letter-spacing: 1px;
            }

            .lcars-dialog-meta {
                font-size: 0.75rem;
                opacity: 0.8;
                cursor: help;
            }

            .lcars-dialog-body {
                padding: 16px 16px 8px 16px;
                background-color: var(--lcars-black);
            }

            .lcars-dialog-footer {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding: 8px 16px 16px 16px;
                background-color: var(--lcars-black);
            }

            .form-group {
                margin-bottom: 15px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(153, 153, 204, 0.3);
            }

            .form-group:last-of-type {
                border-bottom: none;
                padding-bottom: 0;
            }

            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }

            input,
            select,
            textarea {
                width: 100%;
                padding: 10px;
                background-color: var(--lcars-dark-2);
                border: 1px solid var(--theme-main);
                color: var(--lcars-beige);
                border-radius: var(--lcars-radius-xs);
                border-width: 3px;
                font-family: var(--lcars-font);
            }

            textarea {
                resize: vertical;
                min-height: 60px;
                max-height: 150px;
            }

            /* URL protocol select styled as compact LCARS control */
            #urlProtocol {
                max-width: 140px;
                border-radius: var(--lcars-radius-md);
                text-transform: uppercase;
                font-weight: bold;
                letter-spacing: 1px;
                padding: 8px 12px;
            }

            .dialog-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
            }



            .category-config-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 6px;
                overflow-y: auto;
                border: 1px solid var(--lcars-blue);
                padding: 10px 10px 6px 10px;
                border-radius: 0px;
                border-style: none;
                background-color: var(--lcars-black);
            }

            .category-config-row {
                display: grid;
                grid-template-columns: 70px 1fr 40px 40px 40px 40px;
                gap: 8px;
                align-items: center;
                padding: 6px 8px;
                border-radius: var(--lcars-radius-md);
                background-color: var(--lcars-dark-1);
            }

            .category-color-swatch {
                width: 100%;
                height: 40px;
                border: none;
                border-radius: var(--lcars-radius-md) 0 0 var(--lcars-radius-md);
                cursor: pointer;
                box-shadow: inset 0 0 0 2px var(--lcars-black);
            }

            .color-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
                margin-top: 6px;
            }

            .color-option {
                width: 100%;
                aspect-ratio: 1.3;
                border: none;
                border-radius: var(--lcars-radius-sm);
                cursor: pointer;
                box-shadow: inset 0 0 0 2px var(--lcars-black);
            }

            .color-option:hover {
                filter: brightness(1.15);
                outline: 2px solid var(--lcars-white);
                outline-offset: 2px;
            }

            /* LCARS pin primitive: small circular action control */
            .lcars-pin {
                --lcars-pin-size: 20px;
                --lcars-pin-bg: var(--theme-secondary, var(--lcars-blue));
                --lcars-pin-fg: var(--lcars-black);

                width: var(--lcars-pin-size);
                height: var(--lcars-pin-size);
                border-radius: 50%;
                border: none;
                padding: 0;

                display: inline-flex;
                align-items: center;
                justify-content: center;

                background-color: var(--lcars-pin-bg);
                color: var(--lcars-pin-fg);
                font-family: var(--lcars-font);
                font-weight: bold;
                font-size: 1rem;
                line-height: 1;

                cursor: pointer;
                position: relative;
            }

            .lcars-pin:hover {
                filter: brightness(1.1);
                transform: scale(1.05);
            }

            .lcars-pin:focus-visible {
                outline: var(--lcars-focus-outline-width) solid var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            .category-config-btn {
                /* Category config buttons as LCARS pins */
                --lcars-pin-size: 40px;
                --lcars-pin-bg: var(--theme-secondary, var(--lcars-blue));
                --lcars-pin-fg: var(--lcars-black);

                width: var(--lcars-pin-size);
                height: var(--lcars-pin-size);
                border-radius: 50%;
                border: none;
                padding: 0;

                display: inline-flex;
                align-items: center;
                justify-content: center;

                background-color: var(--lcars-pin-bg);
                color: var(--lcars-pin-fg);
                font-family: var(--lcars-font);
                font-weight: bold;
                font-size: 1.25rem;
                line-height: 1.1;
                letter-spacing: 0.03em;

                cursor: pointer;
                position: relative;
                box-shadow: inset 0 0 0 2px var(--lcars-black);
            }

            .category-config-btn:hover {
                background-color: color-mix(
                    in srgb,
                    var(--lcars-pin-bg, var(--theme-secondary, var(--lcars-blue))) 70%,
                    var(--lcars-white) 30%
                );
            }

            .category-config-btn.delete {
                --lcars-pin-bg: var(--lcars-red);
                background-color: var(--lcars-pin-bg);
            }

            /* Category pin icons (SVG) */
            .category-config-btn svg {
                width: 70%;
                height: 70%;
                display: block;
                margin: auto;
                fill: currentColor;
            }

            .category-config-btn[data-glyph="up"] svg {
                width: 87%;
                height: 87%;
                transform: translateY(-2px);
            }

            .category-config-btn[data-glyph="down"] svg {
                width: 87%;
                height: 87%;
                transform: translateY(2px);
            }

            .category-config-btn[data-glyph="plus"] svg {
                width: 72%;
                height: 72%;
            }

            .category-config-btn[data-glyph="delete"] svg {
                width: 80%;
                height: 80%;
            }

            /* System Status Display */
            .status-display {
                display: flex;
                align-items: center;
                flex: 1;
                padding-left: 15px;
                height: 100%;
            }

            .status-text {
                color: var(--lcars-black);
                font-weight: bold;
                margin-right: 10px;
                font-size: 1.2rem;
            }

            .status-info {
                background-color: var(--lcars-black);
                color: var(--lcars-orange);
                padding: 0 15px;
                height: 100%;
                border-radius: 0;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: bold;
                font-size: 1.1rem;
            }
        </style>
    </head>
    <body>
        <div class="lcars-app">
            <!-- Header Bar (Left) -->
            <div class="header-bar lcars-frame-segment lcars-frame-segment--horizontal lcars-frame-segment--left-rounded">
                <div class="header-fill"></div>
                <button class="app-title" id="homeBtn" aria-label="Home - Bookmarks View">ZANDER</button>
                <div class="header-end-cap"></div>
            </div>

            <!-- Sidebar (Right - Full Height) -->
            <aside class="sidebar-container">
                <!-- Top Elbow -->
                <div class="lcars-elbow sidebar-top-cap"></div>

                <!-- Middle Track with Scroll Buttons -->
                <div class="sidebar-track">
                    <button class="lcars-arrow-btn sidebar-scroll-up" id="sidebarScrollUp" aria-label="Scroll categories up">
                        <svg viewBox="0 0 40 12" aria-hidden="true">
                            <polygon points="20,0 40,12 0,12" />
                        </svg>
                    </button>
                    <div class="lcars-scroll-container sidebar-categories" id="categorySidebar">
                        <!-- Categories injected here -->
                    </div>
                    <button class="lcars-arrow-btn sidebar-scroll-down" id="sidebarScrollDown" aria-label="Scroll categories down">
                        <svg viewBox="0 0 40 12" aria-hidden="true">
                            <polygon points="0,0 40,0 20,12" />
                        </svg>
                    </button>
                </div>

                <!-- Bottom Elbow -->
                <div class="lcars-elbow sidebar-bottom-cap"></div>
            </aside>

            <main class="main-content">
                <div id="bookmarksView" class="main-view active">
                    <div
                        id="bookmarkLocation"
                        class="lcars-breadcrumb"
                        aria-live="polite"
                        aria-label="Current Category Location"
                    >
                        <span class="lcars-breadcrumb-label">LOCATION</span>
                        <nav class="lcars-breadcrumb-path" aria-label="Current location">
                            <!-- Segments injected via JS -->
                        </nav>
                    </div>
                    <div id="bookmarkGrid" class="bookmark-grid" role="list">
                        <!-- Bookmarks injected here -->
                    </div>
                    <div
                        id="emptyState"
                        class="empty-state"
                        style="display: none; text-align: center; padding: 50px"
                        role="status"
                        aria-live="assertive"
                    >
                        NO ENTRIES FOUND
                    </div>
                </div>
                <div
                    id="settingsView"
                    class="main-view"
                    style="padding: 20px; height: 100%"
                    role="region"
                    aria-label="Settings Panel"
                >
                    <div class="settings-panel">
                        <div class="settings-accent"></div>
                        <div class="settings-content">
                            <div class="settings-status">
                                <span>CONFIGURATION MODE</span>
                                <span id="settingsStardate"
                                    >STARDATE 0000000.0000</span
                                >
                            </div>
                            <h1>SYSTEM SETTINGS</h1>

                            <section class="settings-section">
                                <h2>CATEGORY CONFIGURATION</h2>
                                <div id="settingsCategorySectionMain">
                                    <div
                                        id="categoryConfigList"
                                        class="category-config-list"
                                    >
                                        <!-- Rows injected via JS -->
                                    </div>
                                    <button
                                        class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-settings-action action-btn action-btn--small"
                                        id="addCategoryBtnMain"
                                        style="width: 100%; margin-bottom: 20px"
                                    >
                                        ADD CATEGORY
                                    </button>
                                </div>
                            </section>

                            <section class="settings-section">
                                <h2>THEME</h2>
                                <div class="form-group">
                                    <div
                                        id="themeControlsContainer"
                                        style="margin-bottom: 10px"
                                    ></div>
                                    <div
                                        id="themeStatusReadout"
                                        style="
                                            font-size: 0.85rem;
                                            opacity: 0.8;
                                            letter-spacing: 1px;
                                        "
                                    >
                                        ACTIVE THEME: LA'AN
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <h2>DATA MANAGEMENT</h2>
</h2>                                <div id="settingsDataSectionMain">
                                    <div class="form-group">
                                        <button
                                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-settings-action action-btn action-btn--small"
                                            id="exportBtnMain"
                                            style="
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            EXPORT DATABASE
                                        </button>
                                        <button
                                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-settings-action action-btn action-btn--small"
                                            id="importBtnMain"
                                            style="
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            IMPORT DATABASE
                                        </button>
                                        <input
                                            type="file"
                                            id="importInput"
                                            accept=".json"
                                            style="display: none"
                                            aria-label="Import Bookmarks from JSON File"
                                        />
                                    </div>
                                </div>
                            </section>
                            <section class="settings-section">
                                <h2>DANGER ZONE</h2>
</h2>                                <div id="settingsDataSectionMain">
                                    <div class="form-group">
                                        <button
                                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-danger lcars-settings-action reset"
                                            id="resetBtnMain"
                                            style="width: 100%"
                                        >
                                            SYSTEM RESET
                                        </button>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <div id="aboutView" class="main-view" style="padding: 20px" role="region" aria-label="About Zander">
                    <div class="about-panel">
                        <h1>ABOUT ZANDER</h1>
                        <hr />
                        <p>
                            <strong>ZANDER BOOKMARK TECHNOLOGIES</strong><br />
                            UNITED FEDERATION OF PLANETS<br />
                        </p>
                        <hr />
                        <h2>SYSTEM INFO</h2>
                        <p>A SINGLE-FILE, OFFLINE-CAPABLE PERSONAL ARCHIVE.</p>
                        <p class="about-meta">
                            VERSION: v1.0.0
                        </p>
                        <hr />
                        <p class="about-meta">
                            KEYBOARD SHORTCUTS:
                            <ul>
                                <li>ALT+H  HOME (BOOKMARKS VIEW)</li>
                                <li>ALT+N  NEW ENTRY</li>
                                <li>ALT+S  SETTINGS VIEW</li>
                                <li>ALT+C  NEW CATEGORY (IN SETTINGS)</li>
                            </ul>
                        </p>
                    </div>
                </div>
            </main>

            <div class="footer-bar lcars-frame-segment lcars-frame-segment--horizontal lcars-frame-segment--left-rounded">
                <div id="systemStatus" class="status-display"></div>
                <button class="lcars-button lcars-focus-bar lcars-color-orange lcars-footer-bar-button" id="addBtn" aria-label="Add Entry (Alt+N)">ADD ENTRY</button>
                <div class="settings-wrapper">
                    <button class="lcars-button lcars-focus-bar lcars-color-orange lcars-footer-bar-button" id="settingsBtn" aria-label="Settings (Alt+S)">
                        SETTINGS
                    </button>
                </div>
                <button class="lcars-button lcars-focus-bar lcars-color-orange lcars-footer-bar-button" id="aboutBtn" aria-label="About Zander">ABOUT</button>
            </div>
        </div>

        <!-- Bookmark Dialog -->
        <dialog id="bookmarkDialog" aria-label="Bookmark Entry Dialog">
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <h2 class="lcars-dialog-title" id="dialogTitle">
                        NEW ENTRY
                    </h2>
                    <span class="lcars-dialog-meta" id="bookmarkStardate">
                        STARDATE 0000000.0000
                    </span>
                </div>
                <form id="bookmarkForm" method="dialog">
                    <div class="lcars-dialog-body">
                        <input type="hidden" id="bookmarkId" />
                        <div class="form-group">
                            <label for="titleInput">TITLE</label>
                            <input type="text" id="titleInput" required aria-required="true" maxlength="64" />
                        </div>
                        <div class="form-group">
                            <label for="descriptionInput">DESCRIPTION</label>
                            <textarea id="descriptionInput" rows="3" maxlength="512" placeholder="Optional description..." aria-label="Bookmark Description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="urlInput">URL</label>
                            <div style="display: flex; gap: 10px">
                                <label for="urlProtocol" style="display: none;">Protocol</label>
                                <select id="urlProtocol" style="width: 120px" aria-label="URL Protocol">
                                    <option value="https://">HTTPS://</option>
                                    <option value="http://">HTTP://</option>
                                </select>
                                <input
                                    type="text"
                                    id="urlInput"
                                    required
                                    placeholder="example.com"
                                    style="flex: 1"
                                    aria-required="true"
                                />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="categoryInput">CATEGORY</label>
                            <select id="categoryInput" aria-label="Bookmark Category">
                                <!-- Options injected -->
                            </select>
                        </div>
                    </div>
                    <div class="lcars-dialog-footer">
                        <button
                            type="button"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-danger lcars-dialog-action delete"
                            id="deleteBtn"
                            style="display: none"
                            aria-label="Delete Bookmark"
                        >
                            DELETE
                        </button>
                        <button
                            type="button"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-dark lcars-dialog-action"
                            onclick="
                                document
                                    .getElementById('bookmarkDialog')
                                    .close()
                            "
                            aria-label="Cancel"
                        >
                            CANCEL
                        </button>
                        <button type="submit" class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-dialog-action" aria-label="Save Bookmark">
                            MAKE IT SO
                        </button>
                    </div>
                </form>
            </div>
        </dialog>

        <!-- Settings Dialog (no longer used for full settings UI, kept for potential small overlays if needed) -->

        <dialog id="confirmDialog" aria-label="Confirmation Dialog">
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <h2 class="lcars-dialog-title" id="confirmTitle">
                        CONFIRM
                    </h2>
                </div>
                <div class="lcars-dialog-body">
                    <div
                        id="confirmMessage"
                        style="margin: 10px 0 0 0; font-size: 1.2rem"
                        role="alert"
                    >
                        ARE YOU SURE?
                    </div>
                </div>
                <div class="lcars-dialog-footer">
                    <button class="lcars-button lcars-pill lcars-focus-outline lcars-color-dark lcars-dialog-action" id="confirmCancelBtn" aria-label="Cancel">
                        CANCEL
                    </button>
                    <button class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-dialog-action" id="confirmOkBtn" aria-label="Proceed">
                        PROCEED
                    </button>
                </div>
            </div>
        </dialog>

        <dialog id="colorPickerDialog" aria-label="Color Picker Dialog">
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <h2 class="lcars-dialog-title">SELECT COLOR</h2>
                </div>
                <div class="lcars-dialog-body">
                    <div id="colorGrid" class="color-grid" role="group" aria-label="Color Palette"></div>
                </div>
            </div>
        </dialog>

        <script>
            const STORAGE_KEY = "zander-lcars:v1";
            const THEME_STORAGE_KEY = "zander-lcars-theme:v1";

            const THEMES = [
                { id: "laan", label: "LA'AN" },
                { id: "data", label: "DATA" },
                { id: "doctor", label: "THE DOCTOR" },
                { id: "chapel", label: "CHAPEL" },
                { id: "spock", label: "SPOCK" },
                { id: "mbenga", label: "M'BENGA" },
                { id: "seven", label: "SEVEN OF NINE" },
                { id: "shran", label: "SHRAN" },
            ];

            // Default Data
            const DEFAULT_CATEGORIES = [
                {
                    id: "cat-root-startrek",
                    name: "STAR TREK",
                    color: "#ff9900",
                    createdAt: "2025352.1200",
                    children: [
                        {
                            id: "cat-tng",
                            name: "The Next Generation",
                            color: "#ffcc00",
                            createdAt: "2025352.1201",
                            children: [
                                {
                                    id: "cat-tng-s1",
                                    name: "Season 1",
                                    color: "#ffcc99",
                                    createdAt: "2025352.1202",
                                    children: [],
                                },
                                {
                                    id: "cat-tng-s2",
                                    name: "Season 2",
                                    color: "#cc99cc",
                                    createdAt: "2025352.1203",
                                    children: [],
                                },
                            ],
                        },
                        {
                            id: "cat-ds9",
                            name: "Deep Space Nine",
                            color: "#cc9966",
                            createdAt: "2025352.1204",
                            children: [
                                {
                                    id: "cat-ds9-s1",
                                    name: "Season 1",
                                    color: "#9999cc",
                                    createdAt: "2025352.1205",
                                    children: [],
                                },
                                {
                                    id: "cat-ds9-s2",
                                    name: "Season 2",
                                    color: "#99ccff",
                                    createdAt: "2025352.1206",
                                    children: [],
                                },
                            ],
                        },
                    ],
                },
            ];

            const DEFAULT_BOOKMARKS = [
                // TNG Season 1
                {
                    id: "bm-tng-s1-captain",
                    title: "TNG S1  Captain Picard",
                    description: "Captain of the USS Enterprise-D. A skilled diplomat and archaeologist who commands with wisdom and principle.",
                    url: "https://memory-alpha.fandom.com/wiki/Jean-Luc_Picard",
                    categoryId: "cat-tng-s1",
                    createdAt: "2025352.1300",
                },
                {
                    id: "bm-tng-s1-ship",
                    title: "TNG S1  USS Enterprise-D",
                    description: "Galaxy-class starship, registry NCC-1701-D. Flagship of the Federation.",
                    url: "https://memory-alpha.fandom.com/wiki/USS_Enterprise_(NCC-1701-D)",
                    categoryId: "cat-tng-s1",
                    createdAt: "2025352.1301",
                },
                // TNG Season 2
                {
                    id: "bm-tng-s2-captain",
                    title: "TNG S2  Captain Picard",
                    url: "https://example.com/tng/season2/captain",
                    categoryId: "cat-tng-s2",
                    createdAt: "2025352.1302",
                },
                {
                    id: "bm-tng-s2-ship",
                    title: "TNG S2  USS Enterprise-D",
                    url: "https://example.com/tng/season2/ship",
                    categoryId: "cat-tng-s2",
                    createdAt: "2025352.1303",
                },
                // DS9 Season 1
                {
                    id: "bm-ds9-s1-captain",
                    title: "DS9 S1  Commander Sisko",
                    description: "Commanding officer of Deep Space 9 and the Emissary of the Prophets.",
                    url: "https://memory-alpha.fandom.com/wiki/Benjamin_Sisko",
                    categoryId: "cat-ds9-s1",
                    createdAt: "2025352.1304",
                },
                {
                    id: "bm-ds9-s1-ship",
                    title: "DS9 S1  Deep Space 9",
                    description: "Former Cardassian mining station, now a key Federation outpost near the Bajoran wormhole.",
                    url: "https://memory-alpha.fandom.com/wiki/Deep_Space_9",
                    categoryId: "cat-ds9-s1",
                    createdAt: "2025352.1305",
                },
                // DS9 Season 2
                {
                    id: "bm-ds9-s2-captain",
                    title: "DS9 S2  Commander Sisko",
                    url: "https://example.com/ds9/season2/captain",
                    categoryId: "cat-ds9-s2",
                    createdAt: "2025352.1306",
                },
                {
                    id: "bm-ds9-s2-ship",
                    title: "DS9 S2  USS Defiant",
                    url: "https://example.com/ds9/season2/ship",
                    categoryId: "cat-ds9-s2",
                    createdAt: "2025352.1307",
                },
            ];
            const LCARS_PALETTE = [
                "#ff9900",
                "#ffcc00",
                "#ffcc99",
                "#cc9966",
                "#cc99cc",
                "#9999cc",
                "#99ccff",
                "#6699cc",
                "#40e0d0", // turquoise
                "#008080", // teal
                "#cc6666",
                "#ff6666",
                "#ff9966",
                "#ff6699",
                "#66cccc",
                "#999999",
                "#333333",
                "#663399",
                "#0066cc",
                "#ff9933",
            ];

            let state = {
                bookmarks: JSON.parse(JSON.stringify(DEFAULT_BOOKMARKS)),
                categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
                currentCategory: "cat-root-startrek",
            };

            // Theme state is intentionally separate from bookmark/category state
            // so we don't disturb the existing import/export format.
            let currentTheme = "laan";

            const grid = document.getElementById("bookmarkGrid");
            const emptyState = document.getElementById("emptyState");
            const homeBtn = document.getElementById("homeBtn");
            const sidebar = document.getElementById("categorySidebar");
            const bookmarksView = document.getElementById("bookmarksView");
            const settingsView = document.getElementById("settingsView");
            const aboutView = document.getElementById("aboutView");
            const aboutStardateEl = document.getElementById("aboutStardate");
            const settingsStardateEl =
                document.getElementById("settingsStardate");
            const categoryInput = document.getElementById("categoryInput");
            const bookmarkDialog = document.getElementById("bookmarkDialog");
            const bookmarkForm = document.getElementById("bookmarkForm");
            const dialogTitle = document.getElementById("dialogTitle");
            const deleteBtn = document.getElementById("deleteBtn");
            const bookmarkIdInput = document.getElementById("bookmarkId");
            const titleInput = document.getElementById("titleInput");
            const descriptionInput = document.getElementById("descriptionInput");
            const urlProtocolSelect = document.getElementById("urlProtocol");
            const urlInput = document.getElementById("urlInput");
            const categoryConfigList =
                document.getElementById("categoryConfigList");
            const importInput = document.getElementById("importInput");
            const confirmDialog = document.getElementById("confirmDialog");
            const confirmTitle = document.getElementById("confirmTitle");
            const confirmMessage = document.getElementById("confirmMessage");
            const confirmOkBtn = document.getElementById("confirmOkBtn");
            const confirmCancelBtn =
                document.getElementById("confirmCancelBtn");
            const colorPickerDialog =
                document.getElementById("colorPickerDialog");
            const colorGrid = document.getElementById("colorGrid");

            function showConfirm(title, message, onOk) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;

                const handleOk = () => {
                    onOk();
                    cleanup();
                };

                const handleCancel = () => {
                    cleanup();
                };

                const cleanup = () => {
                    confirmOkBtn.removeEventListener("click", handleOk);
                    confirmCancelBtn.removeEventListener("click", handleCancel);
                    confirmDialog.close();
                };

                confirmOkBtn.addEventListener("click", handleOk);
                confirmCancelBtn.addEventListener("click", handleCancel);
                confirmDialog.showModal();
            }

            function openColorPicker(current, onSelect) {
                colorGrid.innerHTML = "";
                LCARS_PALETTE.forEach((color) => {
                    const btn = document.createElement("button");
                    btn.className = "color-option";
                    btn.style.backgroundColor = color;
                    btn.setAttribute("aria-label", `Color ${color}`);
                    if (color === current) {
                        btn.style.outline = "2px solid var(--lcars-white)";
                        btn.setAttribute("aria-current", "true");
                    }
                    btn.onclick = () => {
                        onSelect(color);
                        colorPickerDialog.close();
                    };
                    colorGrid.appendChild(btn);
                });
                colorPickerDialog.showModal();
            }

            function showAlert(title, message) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;

                // For alerts, we present a single-acknowledge LCARS dialog.
                const previousOkLabel = confirmOkBtn.textContent;
                const previousCancelDisplay = confirmCancelBtn.style.display;

                confirmOkBtn.textContent = "ACKNOWLEDGE";
                confirmCancelBtn.style.display = "none";

                const handleOk = () => {
                    confirmOkBtn.removeEventListener("click", handleOk);
                    confirmOkBtn.textContent = previousOkLabel;
                    confirmCancelBtn.style.display = previousCancelDisplay;
                    confirmDialog.close();
                };

                confirmOkBtn.addEventListener("click", handleOk);
                confirmDialog.showModal();
            }

            function init() {
                loadData();
                loadTheme();
                applyTheme(currentTheme);
                renderCategories();
                renderGrid();
                setupEventListeners();
                renderThemeControls();
                updateStardateDisplay(aboutStardateEl);
                updateStardateDisplay(settingsStardateEl);
            }

            function loadData() {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    try {
                        const data = JSON.parse(raw);
                        if (Array.isArray(data.bookmarks)) {
                            state.bookmarks = data.bookmarks;
                        }
                        if (
                            Array.isArray(data.categories) &&
                            data.categories.length > 0
                        ) {
                            state.categories = data.categories;
                        }

                        backfillBookmarkCreatedAt(state.bookmarks);
                        backfillCategoryCreatedAt(state.categories);
                    } catch (e) {
                        console.error("Data corruption detected", e);
                        // If stored data is corrupt, reset to defaults and notify the user.
                        showAlert(
                            "ERROR",
                            "STORED DATA IS CORRUPT. RESETTING TO DEFAULTS.",
                        );
                        const bundle = {
                            bookmarks: JSON.parse(
                                JSON.stringify(DEFAULT_BOOKMARKS),
                            ),
                            categories: JSON.parse(
                                JSON.stringify(DEFAULT_CATEGORIES),
                            ),
                        };
                        applyDataBundle(bundle);
                    }
                }

                // Ensure current category is valid
                if (
                    !state.categories.find(
                        (c) => c.id === state.currentCategory,
                    )
                ) {
                    state.currentCategory =
                        state.categories[0]?.id || "cat-databanks";
                }
            }

            function saveData() {
                localStorage.setItem(
                    STORAGE_KEY,
                    JSON.stringify({
                        bookmarks: state.bookmarks,
                        categories: state.categories,
                    }),
                );
            }

            function backfillBookmarkCreatedAt(bookmarks) {
                bookmarks.forEach((b) => {
                    if (!b.createdAt) {
                        b.createdAt = calculateStardate();
                    }
                });
            }

            function backfillCategoryCreatedAt(categories) {
                categories.forEach((c) => {
                    if (!c.createdAt) {
                        c.createdAt = calculateStardate();
                    }
                    if (Array.isArray(c.children) && c.children.length > 0) {
                        backfillCategoryCreatedAt(c.children);
                    }
                });
            }

            function setTheme(themeId) {
                const theme =
                    THEMES.find((t) => t.id === themeId) ||
                    THEMES.find((t) => t.id === "laan");
                currentTheme = theme.id;
                document.body.setAttribute("data-theme", currentTheme);
                localStorage.setItem(THEME_STORAGE_KEY, currentTheme);
                updateThemeStatus();
            }

            function loadTheme() {
                const stored = localStorage.getItem(THEME_STORAGE_KEY);
                if (stored && THEMES.some((t) => t.id === stored)) {
                    setTheme(stored);
                } else {
                    setTheme("laan");
                }
            }

            function applyTheme(themeId) {
                setTheme(themeId);
            }

            function renderCategories() {
                sidebar.innerHTML = "";

                function createCategoryButton(cat, level) {
                    const wrapper = document.createElement("div");
                    wrapper.className = "cat-wrapper";

                    const btn = document.createElement("button");
                    btn.className = `lcars-button lcars-focus-bar cat-btn ${state.currentCategory === cat.id ? "active" : ""}`;
                    btn.textContent = cat.name;
                    btn.style.setProperty("--cat-color", cat.color);
                    btn.dataset.id = cat.id;
                    btn.setAttribute("aria-label", `Category: ${cat.name}`);
                    if (state.currentCategory === cat.id) {
                        btn.setAttribute("aria-current", "page");
                    }

                    wrapper.appendChild(btn);

                    if (cat.children && cat.children.length > 0 && level < 3) {
                        const submenu = document.createElement("div");
                        submenu.className = "cat-submenu";
                        submenu.setAttribute("role", "group");
                        submenu.setAttribute("aria-label", `Subcategories of ${cat.name}`);

                        cat.children.forEach((child) => {
                            submenu.appendChild(
                                createCategoryButton(child, level + 1),
                            );
                        });

                        wrapper.appendChild(submenu);

                        // Position submenu on hover using fixed positioning
                        const positionSubmenu = () => {
                            const btnRect = btn.getBoundingClientRect();
                            submenu.style.top = `${btnRect.top}px`;
                            submenu.style.left = `${btnRect.left - 160 - 10}px`; // 160px width + 10px gap
                        };

                        wrapper.addEventListener("mouseenter", positionSubmenu);
                        btn.addEventListener("focus", positionSubmenu);
                    }

                    return wrapper;
                }

                state.categories.forEach((cat) => {
                    sidebar.appendChild(createCategoryButton(cat, 1));
                });

                // Update select in dialog
                categoryInput.innerHTML = "";

                walkCategories(state.categories, (cat, parent, depth, index, siblings) => {
                        const level = depth + 1;
                        const opt = document.createElement("option");
                        opt.value = cat.id;
                        let prefix = "";
                        for (let i = 1; i < level; i++)
                            prefix += "\u00A0\u00A0"; // Non-breaking spaces
                        if (level > 1) prefix += " ";
                        opt.textContent = prefix + cat.name;
                        opt.setAttribute("aria-label", `${cat.name}${level > 1 ? " (subcategory)" : ""}`);
                        categoryInput.appendChild(opt);
                    });

                updateSystemStatus();
                updateBookmarkLocation();
            }

            function createCategoryTile(category) {
                const tile = document.createElement("button");
                tile.type = "button";
                tile.className = "lcars-category-tile";
                tile.dataset.id = category.id;

                const color = category.color || "var(--theme-main)";
                tile.style.setProperty("--cat-color", color);

                let childCount = 0;
                if (Array.isArray(category.children)) {
                    childCount = category.children.length;
                }
                const bookmarkCount = state.bookmarks.filter(
                    (b) => b.categoryId === category.id,
                ).length;

                const primaryMetaParts = [];
                if (childCount > 0) {
                    primaryMetaParts.push(
                        `${childCount} FOLDER${childCount > 1 ? "S" : ""}`,
                    );
                }
                if (bookmarkCount > 0) {
                    primaryMetaParts.push(
                        `${bookmarkCount} LINK${bookmarkCount > 1 ? "S" : ""}`,
                    );
                }
                const primaryMeta =
                    primaryMetaParts.length > 0
                        ? primaryMetaParts.join("  ")
                        : "EMPTY";

                const createdAtLabel = category.createdAt
                    ? `CREATED ST: ${category.createdAt}`
                    : "";

                tile.innerHTML = `
        <div class="lcars-category-tile-label">${escapeHtml(category.name)}</div>
        <div class="lcars-category-tile-meta">
            <div class="lcars-category-tile-meta-primary">${primaryMeta}</div>
            <div class="lcars-category-tile-meta-secondary">${escapeHtml(createdAtLabel)}</div>
        </div>
    `;

                tile.setAttribute(
                    "aria-label",
                    `Category ${category.name}. ${primaryMeta}${
                        createdAtLabel ? ". " + createdAtLabel : ""
                    }`,
                );

                // Click behavior will be wired when we change the navigation model
                return tile;
            }

            function createBookmarkTile(bookmark) {
                const tile = document.createElement("div");
                tile.className = "bookmark-tile";
                tile.dataset.id = bookmark.id;
                tile.setAttribute("role", "listitem");

                // Use category color for tile if available
                const cat = state.categories.find(
                    (c) => c.id === bookmark.categoryId,
                );
                const catColor = cat ? cat.color : "var(--lcars-orange)";

                tile.style.setProperty("--cat-color", catColor);

                const descriptionHtml = bookmark.description
                    ? `<div class="bookmark-description">${escapeHtml(bookmark.description)}</div>`
                    : '<div class="bookmark-description"></div>';

                tile.innerHTML = `
                    <div class="bookmark-title">${escapeHtml(bookmark.title)}</div>
                    ${descriptionHtml}
                    <div class="bookmark-url-footer">
                        <button class="bookmark-footer-btn bookmark-edit-icon" type="button" title="Edit Bookmark" aria-label="Edit Bookmark"></button>
                        <button class="bookmark-footer-btn bookmark-url-icon" type="button" title="${escapeHtml(bookmark.url)}" aria-label="Open Bookmark URL"></button>
                    </div>
                `;

                // Bookmark tiles are visual containers; open/edit via footer pins only
                tile.setAttribute("role", "group");
                tile.setAttribute(
                    "aria-label",
                    `Bookmark: ${escapeHtml(bookmark.title)} - ${escapeHtml(bookmark.url)}`
                );

                return tile;
            }

            function createCategoryTile(category) {
                const tile = document.createElement("button");
                tile.type = "button";
                tile.className = "lcars-category-tile";
                tile.dataset.id = category.id;

                const color = category.color || "var(--theme-main)";
                tile.style.setProperty("--cat-color", color);

                let childCount = 0;
                if (Array.isArray(category.children)) {
                    childCount = category.children.length;
                }
                const bookmarkCount = state.bookmarks.filter(
                    (b) => b.categoryId === category.id,
                ).length;

                const primaryMetaParts = [];
                if (childCount > 0) {
                    primaryMetaParts.push(
                        `${childCount} FOLDER${childCount > 1 ? "S" : ""}`,
                    );
                }
                if (bookmarkCount > 0) {
                    primaryMetaParts.push(
                        `${bookmarkCount} LINK${bookmarkCount > 1 ? "S" : ""}`,
                    );
                }

                const primaryMeta =
                    primaryMetaParts.length > 0
                        ? primaryMetaParts.join("  ")
                        : "EMPTY";

                const createdAtLabel = category.createdAt
                    ? `CREATED ST: ${category.createdAt}`
                    : "";

                tile.innerHTML = `
        <div class="lcars-category-tile-label">${escapeHtml(category.name)}</div>
        <div class="lcars-category-tile-meta">
            <div class="lcars-category-tile-meta-primary">${primaryMeta}</div>
            <div class="lcars-category-tile-meta-secondary">${escapeHtml(createdAtLabel)}</div>
        </div>
    `;

                tile.setAttribute(
                    "aria-label",
                    `Category ${category.name}. ${primaryMeta}${
                        createdAtLabel ? ". " + createdAtLabel : ""
                    }`,
                );

                return tile;
            }

            function renderGrid() {
                grid.innerHTML = "";
                const filtered = state.bookmarks.filter(
                    (b) => b.categoryId === state.currentCategory,
                );

                if (filtered.length === 0) {
                    emptyState.style.display = "block";
                } else {
                    emptyState.style.display = "none";
                    filtered.forEach((b) => {
                        const tile = createBookmarkTile(b);
                        grid.appendChild(tile);
                    });
                }
                updateSystemStatus();
                updateBookmarkLocation();
            }

            function formatCurrentStardateDisplay() {
                const sd = calculateStardate();
                const date = parseStardate(sd);
                return {
                    stardate: sd,
                    label: `STARDATE ${sd}`,
                    tooltip: date ? date.toLocaleString() : "",
                };
            }

            function updateStardateDisplay(el) {
                if (!el) return;
                const info = formatCurrentStardateDisplay();
                el.textContent = info.label;
                el.title = info.tooltip;
            }

            function updateSystemStatus() {
                const statusEl = document.getElementById("systemStatus");
                if (statusEl) {
                    let catCount = 0;
                    walkCategories(state.categories, () => {
                        catCount++;
                    });
                    const bmCount = state.bookmarks.length;
                    statusEl.innerHTML = `
                        <span class="status-text">STATUS:</span>
                        <div class="status-info" aria-live="polite" aria-label="System Status">
                            <span>CT: ${catCount}</span>
                            <span></span>
                            <span>BM: ${bmCount}</span>
                        </div>
                    `;
                }
            }

            function updateThemeStatus() {
                const themeStatusEl =
                    document.getElementById("themeStatusReadout");
                if (!themeStatusEl) return;
                const current =
                    THEMES.find((t) => t.id === currentTheme) ||
                    THEMES[0];
                themeStatusEl.textContent = `ACTIVE THEME: ${current.label}`;
            }

            function calculateStardate(date = new Date()) {
                const start = new Date(date.getFullYear(), 0, 0);
                const diff = date - start;
                const oneDay = 1000 * 60 * 60 * 24;
                const day = Math.floor(diff / oneDay);
                const minutes = date.getHours() * 60 + date.getMinutes();

                // Format: YYYYDDD.MMMM (Year + DayOfYear . TotalMinutes)
                return `${date.getFullYear()}${day.toString().padStart(3, "0")}.${minutes.toString().padStart(4, "0")}`;
            }

            function parseStardate(stardate) {
                if (!stardate || typeof stardate !== "string") return null;
                const year = parseInt(stardate.substring(0, 4));
                const dayOfYear = parseInt(stardate.substring(4, 7));
                const minutes = parseInt(stardate.substring(8));

                if (isNaN(year) || isNaN(dayOfYear) || isNaN(minutes))
                    return null;

                const date = new Date(year, 0, dayOfYear);
                date.setHours(Math.floor(minutes / 60));
                date.setMinutes(minutes % 60);
                return date;
            }

            // Generic category tree walker used by config, lookups, etc.
            // visitor(cat, parent, depth, index, siblings) can return a non-undefined
            // value to short-circuit traversal with that value.
            function walkCategories(rootCategories, visitor, parent = null, depth = 0) {
                for (let i = 0; i < rootCategories.length; i++) {
                    const cat = rootCategories[i];
                    const result = visitor(cat, parent, depth, i, rootCategories);
                    if (result !== undefined) {
                        return result;
                    }
                    if (cat.children && cat.children.length > 0) {
                        const childResult = walkCategories(
                            cat.children,
                            visitor,
                            cat,
                            depth + 1,
                        );
                        if (childResult !== undefined) {
                            return childResult;
                        }
                    }
                }
                return undefined;
            }

            function getCategoryPath(id, cats) {
                // Returns an array of category objects from root to the category with the given id,
                // or null if no such category exists.
                function helper(nodes, path) {
                    for (const cat of nodes) {
                        const newPath = [...path, cat];
                        if (cat.id === id) {
                            return newPath;
                        }
                        if (cat.children && cat.children.length > 0) {
                            const childPath = helper(cat.children, newPath);
                            if (childPath) return childPath;
                        }
                    }
                    return null;
                }
                return helper(cats, []);
            }

            function updateBookmarkLocation() {
                const container = document.getElementById("bookmarkLocation");
                if (!container) return;

                const pathEl = container.querySelector(
                    ".lcars-breadcrumb-path",
                );
                if (!pathEl) return;

                pathEl.innerHTML = "";

                if (!state.currentCategory) {
                    const seg = document.createElement("span");
                    seg.className = "lcars-breadcrumb-segment is-current";
                    seg.textContent = "ALL BOOKMARKS";
                    seg.setAttribute("aria-current", "location");
                    pathEl.appendChild(seg);
                    return;
                }

                const path = getCategoryPath(
                    state.currentCategory,
                    state.categories,
                );
                if (!path || path.length === 0) {
                    const seg = document.createElement("span");
                    seg.className = "lcars-breadcrumb-segment is-current";
                    seg.textContent = "UNKNOWN";
                    seg.setAttribute("aria-current", "location");
                    pathEl.appendChild(seg);
                    return;
                }

                path.forEach((cat, index) => {
                    const isLast = index === path.length - 1;
                    const isFirst = index === 0;

                    if (index > 0) {
                        const sep = document.createElement("span");
                        sep.className = "lcars-breadcrumb-separator";
                        sep.textContent = "";
                        pathEl.appendChild(sep);
                    }

                    if (isLast) {
                        const span = document.createElement("span");
                        span.className = "lcars-breadcrumb-segment is-current";
                        span.textContent = cat.name;
                        span.setAttribute("aria-current", "location");
                        pathEl.appendChild(span);
                    } else {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "lcars-breadcrumb-segment";
                        if (isFirst) btn.classList.add("is-root");
                        btn.textContent = cat.name;
                        btn.dataset.categoryId = cat.id;
                        btn.addEventListener("click", () => {
                            state.currentCategory = cat.id;
                            saveData();
                            renderGrid();
                            renderCategories();
                        });
                        pathEl.appendChild(btn);
                    }
                });
            }

            function generateUUID() {
                if (typeof crypto !== "undefined" && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                    /[xy]/g,
                    function (c) {
                        var r = (Math.random() * 16) | 0,
                            v = c == "x" ? r : (r & 0x3) | 0x8;
                        return v.toString(16);
                    },
                );
            }

            function escapeHtml(str) {
                if (!str) return "";
                return str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function normalizeUrl(s, defaultProtocol = "https://") {
                const trimmed = String(s || "").trim();
                if (!trimmed) return "";
                // If it doesn't start with a scheme like http:, https:, ftp:, mailto:, etc.,
                // assume the provided default protocol (normally https:// or http://)
                if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmed)) {
                    // Strip any leading slashes so we don't end up with https:////example.com
                    const withoutSlashes = trimmed.replace(/^\/+/, "");
                    return `${defaultProtocol}${withoutSlashes}`;
                }
                return trimmed;
            }

            function isProbablyUrl(s) {
                try {
                    const url = new URL(s);
                    if (!["http:", "https:"].includes(url.protocol)) return false;

                    const host = url.hostname;
                    if (!host) return false;

                    // Allow localhost explicitly
                    if (host === "localhost") return true;

                    // Allow IPv4 addresses
                    if (/^\d{1,3}(\.\d{1,3}){3}$/.test(host)) return true;

                    // Require at least one dot for normal hostnames (e.g., example.com)
                    if (host.includes(".")) return true;

                    return false;
                } catch {
                    return false;
                }
            }

            function openAddDialog() {
                dialogTitle.textContent = "ADD ENTRY";

                const stardateEl = document.getElementById("bookmarkStardate");
                const info = formatCurrentStardateDisplay();
                stardateEl.textContent = info.label;
                stardateEl.title = info.tooltip;

                bookmarkForm.reset();
                bookmarkIdInput.value = "";
                urlProtocolSelect.value = "https://";
                categoryInput.value = state.currentCategory;
                deleteBtn.style.display = "none";
                bookmarkDialog.showModal();
            }

            function openEditDialog(bookmark) {
                dialogTitle.textContent = "EDIT ENTRY";

                const stardateEl = document.getElementById("bookmarkStardate");
                if (bookmark.createdAt) {
                    stardateEl.textContent = `STARDATE ${bookmark.createdAt}`;
                    const date = parseStardate(bookmark.createdAt);
                    stardateEl.title = date ? date.toLocaleString() : "";
                } else {
                    stardateEl.textContent = "";
                    stardateEl.title = "";
                }

                bookmarkIdInput.value = bookmark.id;
                titleInput.value = bookmark.title;
                descriptionInput.value = bookmark.description || "";

                let url = bookmark.url;
                let protocol = "https://";
                if (url.startsWith("http://")) {
                    protocol = "http://";
                    url = url.substring(7);
                } else if (url.startsWith("https://")) {
                    protocol = "https://";
                    url = url.substring(8);
                }

                urlProtocolSelect.value = protocol;
                urlInput.value = url;

                categoryInput.value =
                    bookmark.categoryId || state.categories[0].id;
                deleteBtn.style.display = "inline-block";
                deleteBtn.onclick = () => deleteBookmark(bookmark.id);
                bookmarkDialog.showModal();
            }

            function saveBookmark(e) {
                e.preventDefault(); // Prevent default form submission

                const id = bookmarkIdInput.value;
                const title = titleInput.value;
                const description = descriptionInput.value.trim();
                const protocol = urlProtocolSelect.value;
                const rawUrl = urlInput.value.trim();
                const categoryId = categoryInput.value;

                if (!title.trim()) {
                    showAlert("ERROR", "TITLE IS REQUIRED.");
                    return;
                }

                if (!rawUrl) {
                    showAlert("ERROR", "URL IS REQUIRED.");
                    return;
                }

                // Normalize URL using selected protocol as default, but still respect
                // full URLs the user may have pasted (http/https and other schemes)
                const url = normalizeUrl(rawUrl, protocol);

                if (!isProbablyUrl(url)) {
                    showAlert(
                        "ERROR",
                        "URL DOES NOT APPEAR TO BE VALID (MUST BE HTTP OR HTTPS).",
                    );
                    return;
                }

                if (id) {
                    // Edit
                    const idx = state.bookmarks.findIndex((b) => b.id === id);
                    if (idx !== -1) {
                        state.bookmarks[idx].title = title;
                        state.bookmarks[idx].description = description;
                        state.bookmarks[idx].url = url;
                        state.bookmarks[idx].categoryId = categoryId;
                    }
                } else {
                    // Add
                    const newBookmark = {
                        id: generateUUID(),
                        title,
                        description,
                        url,
                        categoryId,
                        createdAt: calculateStardate(),
                    };
                    state.bookmarks.push(newBookmark);
                }

                saveData();
                renderGrid();
                bookmarkDialog.close();
            }

            function deleteBookmark(id) {
                showConfirm("DELETE ENTRY", "CONFIRM DELETION?", () => {
                    state.bookmarks = state.bookmarks.filter(
                        (b) => b.id !== id,
                    );
                    saveData();
                    renderGrid();
                    bookmarkDialog.close();
                });
            }

            // --- Category Management ---

            function findCategoryAndParent(id, cats, parent) {
                return walkCategories(
                    cats,
                    (cat, parentNode, depth, index, siblings) => {
                        if (cat.id === id) {
                            return {
                                category: cat,
                                parent: parentNode,
                                siblings,
                                index,
                            };
                        }
                        return undefined;
                    },
                    parent,
                ) || null;
            }

            function renderCategoryConfig() {
                categoryConfigList.innerHTML = "";

                function renderConfigRow(cat, parent, index, siblings, level) {
                    const row = document.createElement("div");
                    row.className = "category-config-row";
                    // Indent
                    row.style.paddingLeft = `${(level - 1) * 40}px`;

                    // Color Picker
                    const colorBtn = document.createElement("button");
                    colorBtn.className = "category-color-swatch";
                    colorBtn.style.backgroundColor = cat.color;
                    colorBtn.setAttribute("aria-label", `Change color for ${cat.name} category`);
                    colorBtn.onclick = () => {
                        openColorPicker(cat.color, (newColor) => {
                            cat.color = newColor;
                            saveData();
                            renderCategories();
                            renderGrid();
                            renderCategoryConfig();
                        });
                    };

                    // Name Input
                    const nameInput = document.createElement("input");
                    nameInput.type = "text";
                    nameInput.value = cat.name;
                    nameInput.style.width = "100%";
                    nameInput.style.backgroundColor = "var(--lcars-dark-2)";
                    nameInput.style.border = "1px solid var(--lcars-blue)";
                    nameInput.style.color = "var(--lcars-beige)";
                    nameInput.style.borderRadius = "var(--lcars-radius-md)";
                    nameInput.style.padding = "8px 12px";
                    nameInput.setAttribute("aria-label", `Edit name for ${cat.name} category`);
                    nameInput.onchange = (e) => {
                        cat.name = e.target.value.toUpperCase();
                        saveData();
                        renderCategories();
                    };

                    // Move Up
                    const upBtn = document.createElement("button");
                    upBtn.className = "category-config-btn";
                    upBtn.dataset.glyph = "up";
                    upBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <polygon points="12,6 6,18 18,18" />
                        </svg>
                    `;
                    upBtn.setAttribute("aria-label", `Move ${cat.name} category up`);
                    upBtn.disabled = index === 0;
                    if (index === 0) upBtn.style.opacity = "0.5";
                    upBtn.onclick = () => moveCategory(cat.id, -1);

                    // Move Down
                    const downBtn = document.createElement("button");
                    downBtn.className = "category-config-btn";
                    downBtn.dataset.glyph = "down";
                    downBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <polygon points="6,6 18,6 12,18" />
                        </svg>
                    `;
                    downBtn.setAttribute("aria-label", `Move ${cat.name} category down`);
                    downBtn.disabled = index === siblings.length - 1;
                    if (index === siblings.length - 1)
                        downBtn.style.opacity = "0.5";
                    downBtn.onclick = () => moveCategory(cat.id, 1);

                    // Add Subcategory (New)
                    const addBtn = document.createElement("button");
                    addBtn.className = "category-config-btn";
                    addBtn.dataset.glyph = "plus";
                    addBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <rect x="11" y="5" width="2" height="14" />
                            <rect x="5" y="11" width="14" height="2" />
                        </svg>
                    `;
                    addBtn.setAttribute("aria-label", `Add subcategory to ${cat.name}`);
                    if (level >= 3) {
                        addBtn.disabled = true;
                        addBtn.style.opacity = "0.5";
                    }
                    addBtn.onclick = () => addCategory(cat.id);

                    // Delete
                    const delBtn = document.createElement("button");
                    delBtn.className = "category-config-btn delete";
                    delBtn.dataset.glyph = "delete";
                    delBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <rect x="6" y="11" width="12" height="2" transform="rotate(45 12 12)" />
                            <rect x="6" y="11" width="12" height="2" transform="rotate(-45 12 12)" />
                        </svg>
                    `;
                    delBtn.setAttribute("aria-label", `Delete ${cat.name} category`);
                    delBtn.onclick = () => deleteCategory(cat.id);

                    row.appendChild(colorBtn);
                    row.appendChild(nameInput);
                    row.appendChild(upBtn);
                    row.appendChild(downBtn);
                    row.appendChild(addBtn);
                    row.appendChild(delBtn);

                    categoryConfigList.appendChild(row);
                }

                walkCategories(state.categories, (cat, parent, depth, index, siblings) => {
                    // depth is 0-based from root; config UI levels start at 1
                    const level = depth + 1;
                    renderConfigRow(cat, parent, index, siblings, level);
                    return undefined;
                });
            }

            function addCategory(parentId = null) {
                const newCat = {
                    id: generateUUID(),
                    name: "NEW CATEGORY",
                    color: LCARS_PALETTE[
                        Math.floor(Math.random() * LCARS_PALETTE.length)
                    ],
                    createdAt: calculateStardate(),
                    children: [],
                };

                if (parentId) {
                    const result = findCategoryAndParent(
                        parentId,
                        state.categories,
                        null,
                    );
                    if (result) {
                        if (!result.category.children)
                            result.category.children = [];
                        result.category.children.push(newCat);
                    }
                } else {
                    state.categories.push(newCat);
                }

                saveData();
                renderCategories();
                renderCategoryConfig();
            }

            function moveCategory(id, direction) {
                const result = findCategoryAndParent(
                    id,
                    state.categories,
                    null,
                );
                if (!result) return;

                const { siblings, index } = result;
                const newIndex = index + direction;

                if (newIndex >= 0 && newIndex < siblings.length) {
                    const temp = siblings[index];
                    siblings[index] = siblings[newIndex];
                    siblings[newIndex] = temp;
                    saveData();
                    renderCategories();
                    renderCategoryConfig();
                }
            }

            function deleteCategory(id) {
                const result = findCategoryAndParent(
                    id,
                    state.categories,
                    null,
                );
                if (!result) return;

                const cat = result.category;

                // Collect full subtree for accurate counts and deletion
                const subtreeCategories = [];
                walkCategories([cat], (node) => {
                    subtreeCategories.push(node);
                    return undefined;
                });

                const subtreeIds = new Set(subtreeCategories.map((c) => c.id));

                // Count bookmarks across entire subtree
                const totalBookmarksInSubtree = state.bookmarks.filter((b) =>
                    subtreeIds.has(b.categoryId),
                ).length;

                const subCategoryCount = subtreeCategories.length - 1; // exclude root

                let msg = `Delete category "${cat.name}"?`;
                if (totalBookmarksInSubtree > 0) {
                    msg += `\nThis will delete ${totalBookmarksInSubtree} bookmark(s).`;
                }
                if (subCategoryCount > 0) {
                    msg += `\nThis will delete ${subCategoryCount} sub-categories.`;
                }

                showConfirm("DELETE CATEGORY", msg, () => {
                    // Remove all bookmarks in the subtree in a single pass
                    state.bookmarks = state.bookmarks.filter(
                        (b) => !subtreeIds.has(b.categoryId),
                    );

                    // Remove category
                    const { siblings, index } = result;
                    siblings.splice(index, 1);

                    // If current category was deleted or inside deleted tree, reset to first available
                    const currentExists = findCategoryAndParent(
                        state.currentCategory,
                        state.categories,
                        null,
                    );
                    if (!currentExists && state.categories.length > 0) {
                        state.currentCategory = state.categories[0].id;
                    } else if (state.categories.length === 0) {
                        // Create default if all deleted
                        state.categories.push({
                            id: "cat-default",
                            name: "DEFAULT",
                            color: "#ff9900",
                            createdAt: calculateStardate(),
                            children: [],
                        });
                        state.currentCategory = "cat-default";
                    }

                    saveData();
                    renderCategories();
                    renderGrid();
                    renderCategoryConfig();
                });
            }

            function getDataBundle() {
                return {
                    bookmarks: state.bookmarks,
                    categories: state.categories,
                };
            }

            function getDefaultCategoryColor() {
                const theme = document.body.getAttribute('data-theme') || 'pickard';

                // Map themes to preferred LCARS_PALETTE entries, falling back safely
                const colorByTheme = {
                    pickard: "#ff9900", // classic LCARS orange
                    data: "#9999cc", // cooler operations/science tone
                    doctor: "#ffcc99", // clinical beige
                    spock: "#9999cc", // science blue
                    seven: "#40e0d0", // turquoise / Borg-adjacent accent
                };

                const preferred = colorByTheme[theme] || colorByTheme.pickard;

                // If the preferred color isn't in the palette (future edits), fall back
                if (Array.isArray(LCARS_PALETTE) && LCARS_PALETTE.includes(preferred)) {
                    return preferred;
                }

                // Last resort: first palette color or a safe orange
                if (Array.isArray(LCARS_PALETTE) && LCARS_PALETTE.length > 0) {
                    return LCARS_PALETTE[0];
                }

                return "#ff9900";
            }

            function applyDataBundle(bundle) {
                const originalBookmarkCount = Array.isArray(bundle.bookmarks)
                    ? bundle.bookmarks.length
                    : 0;
                const originalCategoryCount = Array.isArray(bundle.categories)
                    ? bundle.categories.length
                    : 0;

                // Validate and filter bookmarks: ensure URLs and required fields are valid
                const validBookmarks = Array.isArray(bundle.bookmarks)
                    ? bundle.bookmarks.filter(b => {
                        if (!b || typeof b !== 'object') return false;
                        if (typeof b.url !== 'string' || !b.url.trim()) return false;
                        if (typeof b.id !== 'string' || !b.id.trim()) return false;
                        if (typeof b.title !== 'string' || !b.title.trim()) return false;

                        const normalized = normalizeUrl(b.url);
                        return isProbablyUrl(normalized);
                    })
                    : [];
                const failedBookmarks = originalBookmarkCount - validBookmarks.length;

                // Categories: keep structurally valid categories, override bad colors to theme default
                const defaultColor = getDefaultCategoryColor();
                let overriddenColorCount = 0;

                function normalizeCategoryTree(nodes) {
                    if (!Array.isArray(nodes)) return [];

                    return nodes
                        .filter(c => {
                            if (!c || typeof c !== 'object') return false;
                            if (typeof c.id !== 'string' || !c.id.trim()) return false;
                            if (typeof c.name !== 'string' || !c.name.trim()) return false;
                            return true;
                        })
                        .map(c => {
                            const clone = { ...c };

                            if (
                                typeof clone.color !== 'string' ||
                                !clone.color.trim() ||
                                !LCARS_PALETTE.includes(clone.color)
                            ) {
                                clone.color = defaultColor;
                                overriddenColorCount++;
                            }

                            clone.children = normalizeCategoryTree(clone.children || []);

                            return clone;
                        });
                }

                const normalizedCategories = normalizeCategoryTree(
                    Array.isArray(bundle.categories) ? bundle.categories : [],
                );
                const failedCategories = originalCategoryCount - normalizedCategories.length;

                state.bookmarks = validBookmarks;
                state.categories = normalizedCategories;

                // Backfill createdAt fields on imported data
                backfillBookmarkCreatedAt(state.bookmarks);
                backfillCategoryCreatedAt(state.categories);

                saveData();
                renderCategories();
                renderGrid();
                updateStardateDisplay(aboutStardateEl);
                updateStardateDisplay(settingsStardateEl);

                const lines = [];
                lines.push(
                    `IMPORTED ${validBookmarks.length} / ${originalBookmarkCount} BOOKMARK(S).`,
                );
                lines.push(
                    `IMPORTED ${normalizedCategories.length} / ${originalCategoryCount} CATEGOR(IES).`,
                );

                if (failedBookmarks > 0 || failedCategories > 0) {
                    lines.push(
                        `DISCARDED ${failedBookmarks} BOOKMARK(S) AND ${failedCategories} CATEGOR(IES) WITH INVALID OR MISSING REQUIRED FIELDS.`,
                    );
                }

                if (overriddenColorCount > 0) {
                    lines.push(
                        `RESET ${overriddenColorCount} CATEGORY COLOR(S) TO THE CURRENT THEME DEFAULT.`,
                    );
                }

                showAlert('IMPORT RESULT', lines.join(' '));
            }

            function exportData() {
                const dataStr = JSON.stringify(getDataBundle(), null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `lcars-bookmarks-${new Date().toISOString().split("T")[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function triggerImport() {
                importInput.click();
            }

            function handleImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Basic structure validation
                        if (typeof data !== "object" || data === null) {
                            showAlert("ERROR", "INVALID DATA FORMAT (expected an object).");
                            return;
                        }

                        const bookmarks = Array.isArray(data.bookmarks)
                            ? data.bookmarks
                            : [];
                        const categories = Array.isArray(data.categories)
                            ? data.categories
                            : [];

                        if (!Array.isArray(data.bookmarks) && !Array.isArray(data.categories)) {
                            showAlert(
                                "ERROR",
                                "INVALID DATA FORMAT (missing bookmarks and categories arrays).",
                            );
                            return;
                        }

                        const count = bookmarks.length;

                        showConfirm(
                            "IMPORT DATA",
                            `IMPORT ${count} ENTRIES? THIS WILL OVERWRITE CURRENT DATA.`,
                            () => {
                                const bundle = {
                                    bookmarks,
                                    categories,
                                };
                                applyDataBundle(bundle);
                            },
                        );
                    } catch (err) {
                        showAlert("ERROR", "INVALID DATA FORMAT (could not parse JSON).");
                    }
                };
                reader.readAsText(file);
                e.target.value = ""; // Reset
            }

            function resetSystem() {
                showConfirm(
                    "SYSTEM RESET",
                    "WARNING: SYSTEM RESET WILL ERASE ALL DATA. PROCEED?",
                    () => {
                        localStorage.removeItem(STORAGE_KEY);
                        const bundle = {
                            bookmarks: JSON.parse(
                                JSON.stringify(DEFAULT_BOOKMARKS),
                            ),
                            categories: JSON.parse(
                                JSON.stringify(DEFAULT_CATEGORIES),
                            ),
                        };
                        applyDataBundle(bundle);
                        // Do not reset theme on system reset; theme is a UI preference.
                    },
                );
            }

            function renderThemeControls() {
                const container = document.getElementById(
                    "themeControlsContainer",
                );
                if (!container) return;
                container.innerHTML = "";

                THEMES.forEach((theme) => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className =
                        "lcars-button lcars-pill lcars-focus-outline lcars-color-dark lcars-settings-action";
                    if (theme.id === currentTheme) {
                        btn.classList.add("theme-active");
                    }
                    btn.textContent = theme.label;
                    btn.onclick = () => {
                        applyTheme(theme.id);
                        renderThemeControls();
                    };
                    container.appendChild(btn);
                });

                updateThemeStatus();
            }

            function onClick(id, handler) {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("click", handler);
                }
            }

            function onChange(id, handler) {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("change", handler);
                }
            }

            // --- Event Listeners ---
            // Sidebar scroll button functionality
            const sidebarScrollUp = document.getElementById("sidebarScrollUp");
            const sidebarScrollDown = document.getElementById("sidebarScrollDown");
            const sidebarCategories = document.getElementById("categorySidebar");

            function updateScrollButtons() {
                if (!sidebarCategories) return;
                const { scrollTop, scrollHeight, clientHeight } = sidebarCategories;
                const canScrollUp = scrollTop > 0;
                const canScrollDown = scrollTop + clientHeight < scrollHeight - 1;

                if (sidebarScrollUp) sidebarScrollUp.disabled = !canScrollUp;
                if (sidebarScrollDown) sidebarScrollDown.disabled = !canScrollDown;
            }

            function scrollSidebar(direction) {
                if (!sidebarCategories) return;
                const scrollAmount = 55; // Approximate height of one category button
                sidebarCategories.scrollBy({
                    top: direction * scrollAmount,
                    behavior: "smooth"
                });
            }

            if (sidebarScrollUp) {
                sidebarScrollUp.addEventListener("click", () => scrollSidebar(-1));
            }
            if (sidebarScrollDown) {
                sidebarScrollDown.addEventListener("click", () => scrollSidebar(1));
            }
            if (sidebarCategories) {
                sidebarCategories.addEventListener("scroll", updateScrollButtons);
                // Initial state
                updateScrollButtons();
                // Update after categories render
                const observer = new MutationObserver(updateScrollButtons);
                observer.observe(sidebarCategories, { childList: true, subtree: true });

                // Keyboard arrow navigation for category buttons
                sidebarCategories.addEventListener("keydown", (e) => {
                    if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;

                    const focusedBtn = document.activeElement;
                    if (!focusedBtn || !focusedBtn.classList.contains("cat-btn")) return;

                    e.preventDefault();

                    // Get all visible category buttons (flattened)
                    const allButtons = Array.from(sidebarCategories.querySelectorAll(".cat-btn"));
                    const currentIndex = allButtons.indexOf(focusedBtn);

                    let nextIndex;
                    if (e.key === "ArrowUp") {
                        nextIndex = currentIndex <= 0 ? allButtons.length - 1 : currentIndex - 1;
                    } else {
                        nextIndex = currentIndex >= allButtons.length - 1 ? 0 : currentIndex + 1;
                    }

                    const nextBtn = allButtons[nextIndex];
                    if (nextBtn) {
                        nextBtn.focus();
                        // Scroll the button into view
                        nextBtn.scrollIntoView({ block: "nearest", behavior: "smooth" });
                    }
                });
            }

            function setupEventListeners() {
                // Category Sidebar Delegation
                if (sidebar) {
                    sidebar.addEventListener("click", (e) => {
                        const btn = e.target.closest(".cat-btn");
                        if (btn && btn.dataset.id) {
                            // Ensure main view is bookmarks when switching category
                            bookmarksView.classList.add("active");
                            settingsView.classList.remove("active");
                            aboutView.classList.remove("active");

                            state.currentCategory = btn.dataset.id;
                            renderCategories();
                            renderGrid();
                        }
                    });
                }

                // Bookmark Grid Delegation
                if (grid) {
                    grid.addEventListener("click", (e) => {
                        const tile = e.target.closest(".bookmark-tile");
                        if (!tile) return;

                        // Check if edit pin was clicked
                        if (e.target.closest(".bookmark-edit-icon")) {
                            e.preventDefault();
                            e.stopPropagation();
                            const id = tile.dataset.id;
                            const bookmark = state.bookmarks.find((b) => b.id === id);
                            if (bookmark) openEditDialog(bookmark);
                            return;
                        }

                        // Check if URL pin was clicked
                        if (e.target.closest(".bookmark-url-icon")) {
                            e.preventDefault();
                            e.stopPropagation();
                            const id = tile.dataset.id;
                            const bookmark = state.bookmarks.find((b) => b.id === id);
                            if (bookmark?.url) {
                                window.open(bookmark.url, "_blank", "noopener,noreferrer");
                            }
                            return;
                        }

                        // Clicks on the tile body do not trigger open/edit; pins are the only controls
                    });

                }

                if (homeBtn) {
                    homeBtn.addEventListener("click", () => {
                        bookmarksView.classList.add("active");
                        settingsView.classList.remove("active");
                        aboutView.classList.remove("active");
                    });
                }

                onClick("settingsBtn", () => {
                    // Switch to settings main view
                    bookmarksView.classList.remove("active");
                    aboutView.classList.remove("active");
                    settingsView.classList.add("active");
                    renderCategoryConfig();
                    updateStardateDisplay(settingsStardateEl);
                });

                onClick("addBtn", () => {
                    // Ensure main view is bookmarks when adding an entry
                    bookmarksView.classList.add("active");
                    settingsView.classList.remove("active");
                    aboutView.classList.remove("active");
                    openAddDialog();
                });

                onClick("aboutBtn", () => {
                    bookmarksView.classList.remove("active");
                    settingsView.classList.remove("active");
                    aboutView.classList.add("active");
                    updateStardateDisplay(aboutStardateEl);
                });

                bookmarkForm.addEventListener("submit", saveBookmark);

                // Keyboard Shortcuts
                document.addEventListener("keydown", (e) => {
                    if (e.altKey) {
                        switch (e.key.toLowerCase()) {
                            case "n":
                                e.preventDefault();
                                // Switch back to bookmarks view on New Entry
                                bookmarksView.classList.add("active");
                                settingsView.classList.remove("active");
                                aboutView.classList.remove("active");
                                openAddDialog();
                                break;
                            case "s":
                                e.preventDefault();
                                // Switch to settings main view via keyboard
                                bookmarksView.classList.remove("active");
                                aboutView.classList.remove("active");
                                settingsView.classList.add("active");
                                renderCategoryConfig();
                                updateStardateDisplay(settingsStardateEl);
                                break;
                            case "c":
                                e.preventDefault();
                                // Alt+C: new category while in settings
                                if (settingsView.classList.contains("active")) {
                                    addCategory(null);
                                    renderCategoryConfig();
                                }
                                break;
                            case "h":
                                e.preventDefault();
                                // Alt+H: go Home (Bookmarks view)
                                bookmarksView.classList.add("active");
                                settingsView.classList.remove("active");
                                aboutView.classList.remove("active");
                                break;
                        }
                    }
                });

                // Settings data actions
                onClick("exportBtnMain", exportData);
                onClick("importBtnMain", triggerImport);
                onClick("resetBtnMain", resetSystem);
                onClick("addCategoryBtnMain", () => {
                    addCategory(null);
                    renderCategoryConfig();
                });
                onChange("importInput", handleImport);

                // Theme controls
                renderThemeControls();

                // Dialog close on ESC
                bookmarkDialog.addEventListener("cancel", (e) => {
                    e.preventDefault();
                    bookmarkDialog.close();
                });
            }

            // Start
            init();
        </script>
    </body>
</html>
