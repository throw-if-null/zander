<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ZANDER</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --lcars-bg: #000000;
                --lcars-orange: #ff9900;
                --lcars-purple: #cc99cc;
                --lcars-red: #cc6666;
                --lcars-blue: #9999cc;
                --lcars-beige: #ffcc99;
                --lcars-gray: #999999;
                --lcars-font: "Antonio", sans-serif;
                --gutter: 5px;
                --radius: 30px;

                /* Layout variables */
                --sidebar-width: 160px;
                --header-height: 80px;
                --gap: 10px;
            }

            /* THEME VARIABLES
               - Defined on body so per-theme overrides always apply
               - --theme-main drives the LCARS frame & primary accents
               - --shape-color derives from --theme-main
               - --theme-secondary drives bookmark body accents
               - Background (black) and base text color remain fixed */
            body {
                --theme-main: #830025; /* default: pickard */
                --shape-color: var(--theme-main);
                /* Secondary color used for bookmark body & footer buttons */
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    #ffffff 70%
                );
            }

            /* Theme variants applied on the <body> element via data-theme */
            body[data-theme="pickard"] {
                --theme-main: #830025;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    #ffffff 70%
                );
            }

            body[data-theme="data"] {
                --theme-main: #da9706;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    #ffffff 70%
                );
            }

            body[data-theme="doctor"] {
                --theme-main: #008b8b; /* LCARS-ish teal */
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    #ffffff 70%
                );
            }

            body[data-theme="spock"] {
                --theme-main: #003366;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    #ffffff 70%
                );
            }

            body[data-theme="seven"] {
                /* LCARS-friendly darker silver main tone */
                --theme-main: #8c8c8c;
                --shape-color: var(--theme-main);
                /* Borg green secondary accent computed to match footer/buttons */
                --theme-secondary: #7fff00;
            }

            * {
                box-sizing: border-box;
            }

            :focus-visible {
                outline: 2px solid #fff;
                outline-offset: 2px;
            }

            body {
                background-color: #000;
                color: var(--lcars-orange);
                font-family: var(--lcars-font);
                margin: 0;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            /* LCARS Layout Grid */
            .lcars-app {
                display: grid;
                grid-template-columns: 1fr 160px; /* Content | Sidebar */
                grid-template-rows: 70px 1fr 70px; /* Header | Main | Footer */
                height: 100%;
                padding: 10px;
                gap: 0; /* Seamless connections */
            }

            /* Header (Left Part) */
            .header-bar {
                grid-column: 1;
                grid-row: 1;
                display: flex;
                align-items: stretch;
                justify-content: flex-end;
                padding-right: 0;
                margin-right: -1px;
                height: 40px;
                align-self: start;
            }

            .header-fill {
                flex: 1;
                background-color: var(--shape-color);
                border-top-left-radius: var(--radius);
                border-bottom-left-radius: var(--radius);
            }

            .header-end-cap {
                width: 20px;
                background-color: var(--shape-color);
            }

            .app-title {
                color: var(--lcars-orange);
                background-color: #000;
                font-size: 44px;
                line-height: 40px;
                font-weight: bold;
                text-transform: uppercase;
                padding: 0 10px;
                margin: 0;
                display: flex;
                align-items: center;
                letter-spacing: -1px;
                transform: translateY(-3px);
            }

            /* Sidebar (Full Height Column) */
            .sidebar-container {
                grid-column: 2;
                grid-row: 1 / 4;
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
            }

            /* Top Elbow Connector */
            .sidebar-top-cap {
                height: 70px;
                width: 100%;
                background: radial-gradient(
                    circle at bottom left,
                    var(--lcars-bg) 30px,
                    var(--shape-color) 30.5px
                );
                border-top-right-radius: var(--radius);
            }

            /* Middle Sidebar Track */
            .sidebar-track {
                flex: 1;
                background: none;
                display: flex;
                flex-direction: column;
                gap: 5px;
                padding: 5px 0 0 30px;
            }

            /* Bottom Elbow Connector */
            .sidebar-filler {
                flex: 1;
                background-color: var(--shape-color);
                width: 100%;
            }

            .sidebar-bottom-cap {
                height: 70px;
                width: 100%;
                background: radial-gradient(
                    circle at top left,
                    var(--lcars-bg) 30px,
                    var(--shape-color) 30.5px
                );
                border-bottom-right-radius: var(--radius);
            }

            .footer-bar {
                grid-column: 1;
                grid-row: 3;
                background-color: var(--shape-color);
                border-top-left-radius: var(--radius);
                border-bottom-left-radius: var(--radius);
                display: flex;
                align-items: center;
                padding-left: 0;
                padding-right: 0;
                gap: 0;
                margin-right: -1px;
                height: 40px;
                align-self: end;
            }

            .footer-bar > .action-btn,
            .footer-bar > .settings-wrapper > .action-btn {
                height: 100%;
                border-radius: 0;
                margin: 0;
                border-left: 5px solid #000;
            }

            .footer-bar .settings-wrapper {
                height: 100%;
                display: flex;
            }

            /* Sidebar Buttons */
            .cat-btn {
                background-color: var(--cat-color, var(--shape-color));
                color: #000;
                border: none;
                height: 50px;
                width: 100%;
                font-family: var(--lcars-font);
                font-size: 1.2rem;
                font-weight: bold;
                text-transform: uppercase;
                text-align: right;
                padding-right: 15px;
                cursor: pointer;
                transition: background-color 0.2s;
                position: relative;
            }

            .cat-btn:hover,
            .cat-btn.active {
                background-color: var(--lcars-beige);
            }

            .cat-btn:focus-visible {
                outline: none;
            }

            .cat-btn:focus-visible::after {
                content: "";
                position: absolute;
                left: -9px;
                top: 0;
                bottom: 0;
                width: 4px;
                background-color: #ffffff;
            }

            /* Nested Categories */
            .cat-wrapper {
                position: relative;
                width: 100%;
            }

            .cat-submenu {
                display: none;
                position: absolute;
                right: 100%; /* Move to the left of the parent */
                top: 0;
                width: 160px; /* Match sidebar width */
                flex-direction: column;
                gap: 5px;
                padding-right: 10px; /* Space between levels */
                z-index: 100;
            }

            .cat-wrapper:hover > .cat-submenu {
                display: flex;
            }

            .cat-submenu .cat-btn {
                border-radius: 0;
            }

            /* Main Content */
            .main-content {
                grid-column: 1;
                grid-row: 1 / 4;
                overflow-y: auto;
                padding: 20px;
                border: none;
                border-radius: 30px;
                margin-right: -25px;
                margin-top: 42px;
                margin-bottom: 42px;
            }

            .bookmark-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
            }

            .bookmark-location {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
                font-size: 0.9rem;
                letter-spacing: 1px;
                color: var(--lcars-beige);
                opacity: 0.85;
            }

            .bookmark-location-label {
                color: var(--lcars-orange);
                margin-right: 8px;
            }

            .bookmark-location-path {
                display: inline-flex;
                gap: 6px;
                align-items: center;
                flex-wrap: wrap;
            }

            .bookmark-location-path span {
                white-space: nowrap;
            }

            .bookmark-location-separator {
                opacity: 0.6;
            }

            /* Main view containers */
            .main-view {
                display: none;
            }

            .main-view.active {
                display: block;
            }

            /* Settings / About panels share LCARS framing */
            .settings-panel,
            .about-panel {
                color: var(--lcars-orange);
                max-width: 900px;
                margin: 0 auto;
                text-align: left;
                height: 100%;
            }

            .settings-panel {
                display: grid;
                grid-template-columns: 16px 1fr;
                column-gap: 20px;
                height: 100%;
            }

            .settings-accent {
                grid-row: 1 / span 3;
                background-color: var(--shape-color);
                border-radius: 20px;
            }

            .settings-content {
                grid-column: 2;
            }

            .settings-panel h1,
            .about-panel h1 {
                font-size: 2rem;
                margin-bottom: 15px;
                letter-spacing: 2px;
            }

            .settings-section {
                margin-top: 20px;
                padding-top: 10px;
                border-top: 2px solid var(--lcars-blue);
            }

            /* Layout for settings content: top section grows, bottom sticks near bottom */
            .settings-content {
                grid-column: 2;
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .settings-content .settings-section:first-of-type {
                /* Category Configuration section takes remaining height */
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
            }

            #settingsCategorySectionMain {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
            }

            #settingsCategorySectionMain .category-config-list {
                flex: 1 1 auto;
            }

            .settings-section h2 {
                font-size: 1.1rem;
                margin: 0 0 10px 0;
                letter-spacing: 1px;
            }

            .about-panel p {
                line-height: 1.5;
                margin: 5px 0;
            }

            .about-meta {
                font-size: 0.9rem;
                opacity: 0.8;
                margin-top: 20px;
            }

            .settings-status {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.8rem;
                opacity: 0.8;
                margin-bottom: 10px;
                letter-spacing: 1px;
            }

            /* Shared LCARS button base style */
            .lcars-btn {
                background-color: var(--lcars-beige);
                color: #000;
                border: none;
                padding: 0 15px;
                height: 40px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-family: var(--lcars-font);
                font-size: 1.1rem;
                font-weight: bold;
                text-transform: uppercase;
                border-radius: 20px;
                cursor: pointer;
                position: relative;
                white-space: nowrap;
            }

            .lcars-btn-primary {
                background-color: var(--lcars-orange);
                color: #000;
            }

            .lcars-btn-secondary {
                background-color: #444;
                color: var(--lcars-beige);
            }

            /* Settings buttons use LCARS control-tab style */
            .settings-panel .btn-primary,
            .settings-panel .btn-secondary {
                background-color: var(--lcars-beige);
                color: #000;
                border: none;
                padding: 0 15px;
                height: 40px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-family: var(--lcars-font);
                font-size: 1.1rem;
                font-weight: bold;
                text-transform: uppercase;
                border-radius: 20px;
                cursor: pointer;
                position: relative;
                white-space: nowrap;
            }

            /* Generic LCARS dialog buttons (used by bookmark & confirm dialogs) */
            .lcars-dialog-footer .btn-primary,
            .lcars-dialog-footer .btn-secondary {
                background-color: var(--lcars-beige);
                color: #000;
                border: none;
                padding: 0 15px;
                height: 40px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-family: var(--lcars-font);
                font-size: 1.1rem;
                font-weight: bold;
                text-transform: uppercase;
                border-radius: 20px;
                cursor: pointer;
                position: relative;
                white-space: nowrap;
            }

            .lcars-dialog-footer .btn-primary {
                background-color: var(--lcars-orange);
            }

            .lcars-dialog-footer .btn-secondary {
                background-color: #444;
                color: var(--lcars-beige);
            }

            .lcars-dialog-footer .btn-secondary.delete {
                background-color: var(--lcars-red);
                color: #000;
            }

            .lcars-dialog-footer .btn-primary:hover,
            .lcars-dialog-footer .btn-secondary:hover {
                filter: brightness(1.1);
            }

            .lcars-dialog-footer .btn-primary:focus-visible,
            .lcars-dialog-footer .btn-secondary:focus-visible {
                outline: none;
            }

            .lcars-dialog-footer .btn-primary:focus-visible::after,
            .lcars-dialog-footer .btn-secondary:focus-visible::after {
                content: "";
                position: absolute;
                top: -9px;
                left: 0;
                right: 0;
                height: 4px;
                background-color: #ffffff;
            }

            /* Theme selector layout */
            #themeControlsContainer {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            #themeControlsContainer .btn-secondary {
                min-width: 140px;
                justify-content: center;
            }

            .settings-panel .btn-secondary.reset {
                background-color: var(--lcars-red);
                color: #000;
            }

            .settings-panel .btn-primary:focus-visible,
            .settings-panel .btn-secondary:focus-visible {
                outline: none;
            }

            .settings-panel .btn-primary:focus-visible::after,
            .settings-panel .btn-secondary:focus-visible::after {
                content: "";
                position: absolute;
                top: -9px;
                left: 0;
                right: 0;
                height: 4px;
                background-color: #ffffff;
            }

            .bookmark-tile {
                position: relative;
                background-color: var(--cat-color, var(--lcars-orange));
                color: #fff;
                padding: 0;
                border-radius: 20px 0 0 0;
                border-bottom-right-radius: 30px;
                cursor: pointer;
                text-decoration: none;
                display: grid;
                grid-template-columns: 15px 1fr;
                grid-template-rows: auto 1fr;
                height: 140px;
                transition:
                    transform 0.1s,
                    filter 0.1s;
                user-select: none;
                overflow: hidden;
            }

            .bookmark-tile::after {
                content: "";
                grid-column: 2;
                grid-row: 2;
                background-color: #000;
                border-top-left-radius: 25px;
                z-index: 1;
            }

            .bookmark-tile:hover {
                filter: brightness(1.1);
                transform: scale(1.02);
            }

            .bookmark-title {
                grid-column: 2;
                grid-row: 1;
                font-size: 1.2rem;
                font-weight: bold;
                line-height: 1.1;
                text-transform: uppercase;
                padding: 15px;
                padding-right: 40px;
                color: #000;
            }

            .bookmark-url {
                grid-column: 2;
                grid-row: 2;
                /* Match footer button color */
                background-color: var(--theme-secondary, #444);
                border-top-left-radius: 20px;
                margin-top: 5px;
                margin-left: 5px;
                z-index: 2;
                font-size: 0.8rem;
                opacity: 0.7;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                padding: 15px;
                align-self: stretch;
                display: flex;
                align-items: flex-end;
                color: #000;
            }

            .bookmark-edit-icon {
                position: absolute;
                top: 10px;
                right: 10px;
                width: 24px;
                height: 24px;
                background-color: rgba(0, 0, 0, 0.2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.2s;
                font-size: 14px;
                color: #000;
            }

            .bookmark-tile:hover .bookmark-edit-icon {
                opacity: 1;
            }

            /* Footer Actions */
            .action-btn {
                /* Uses theme secondary so bookmarks & footer buttons match */
                background-color: var(--theme-secondary, color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    #ffffff 70%
                ));
                color: #000;
                border: none;
                padding: 0 15px;
                height: 40px;
                width: 150px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                font-family: var(--lcars-font);
                font-size: 1.2rem;
                font-weight: bold;
                text-transform: uppercase;
                cursor: pointer;
                position: relative;
            }

            .action-btn:hover {
                background-color: #fff;
            }

            .action-btn:focus-visible {
                outline: none;
            }

            .action-btn:focus-visible::after {
                content: "";
                position: absolute;
                top: -9px;
                left: 0;
                right: 0;
                height: 4px;
                background-color: #ffffff;
            }

            #aboutBtn {
                border-right: 5px solid #000;
            }

            /* Borg green footer buttons when SEVEN OF NINE theme is active */
            body[data-theme="seven"] .action-btn {
                background-color: var(--theme-secondary);
            }

            /* Settings Menu */
            .settings-wrapper {
                display: flex;
                align-items: center;
                height: 40px;
            }

            /* Dialogs */
            dialog {
                background-color: #000;
                color: var(--lcars-orange);
                border: 2px solid var(--shape-color);
                border-radius: 20px;
                padding: 0;
                max-width: 540px;
                width: 90%;
            }

            dialog::backdrop {
                background-color: rgba(0, 0, 0, 0.8);
            }

            .lcars-dialog {
                display: flex;
                flex-direction: column;
                border-radius: 20px;
                overflow: hidden;
            }

            /* Color picker specific overlay */
            #colorPickerDialog {
                max-width: 520px;
                border-radius: 26px;
                border-color: var(--shape-color);
            }

            #colorPickerDialog .lcars-dialog-header {
                background-color: var(--shape-color);
                color: #000;
            }

            #colorPickerDialog .lcars-dialog-body {
                padding: 20px;
                background-color: #000;
            }

            #colorPickerDialog .lcars-dialog-footer {
                display: flex;
                justify-content: flex-end;
                padding: 10px 20px 18px 20px;
                background-color: #000;
            }

            .lcars-dialog-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: var(--shape-color);
                color: #000;
                padding: 10px 16px;
            }

            .lcars-dialog-title {
                font-size: 1.2rem;
                font-weight: bold;
                letter-spacing: 1px;
            }

            .lcars-dialog-meta {
                font-size: 0.75rem;
                opacity: 0.8;
                cursor: help;
            }

            .lcars-dialog-body {
                padding: 16px 16px 8px 16px;
                background-color: #000;
            }

            .lcars-dialog-footer {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding: 8px 16px 16px 16px;
                background-color: #000;
            }

            .form-group {
                margin-bottom: 15px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(153, 153, 204, 0.3);
            }

            .form-group:last-of-type {
                border-bottom: none;
                padding-bottom: 0;
            }

            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }

            input,
            select {
                width: 100%;
                padding: 10px;
                background-color: #222;
                border: 1px solid var(--lcars-blue);
                color: var(--lcars-beige);
                border-radius: 5px;
                font-family: var(--lcars-font);
            }

            /* URL protocol select styled as compact LCARS control */
            #urlProtocol {
                max-width: 140px;
                border-radius: 20px;
                text-transform: uppercase;
                font-weight: bold;
                letter-spacing: 1px;
                padding: 8px 12px;
            }

            .dialog-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
            }

            /* Bookmark dialog buttons use generic LCARS dialog button style */
            #bookmarkDialog .btn-primary,
            #bookmarkDialog .btn-secondary {
                display: inline-flex;
                justify-content: center;
            }

            .category-config-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 6px;
                overflow-y: auto;
                border: 1px solid var(--lcars-blue);
                padding: 10px 10px 6px 10px;
                border-radius: 0px;
                border-style: none;
                background-color: #000;
            }

            .category-config-row {
                display: grid;
                grid-template-columns: 70px 1fr 40px 40px 40px 40px;
                gap: 8px;
                align-items: center;
                padding: 6px 8px;
                border-radius: 20px;
                background-color: #111;
            }

            .category-color-swatch {
                width: 100%;
                height: 40px;
                border: none;
                border-radius: 20px 0 0 20px;
                cursor: pointer;
                box-shadow: inset 0 0 0 2px #000;
            }

            .color-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
                margin-top: 6px;
            }

            .color-option {
                width: 100%;
                aspect-ratio: 1.3;
                border: none;
                border-radius: 16px;
                cursor: pointer;
                box-shadow: inset 0 0 0 2px #000;
            }

            .color-option:hover {
                filter: brightness(1.15);
                outline: 2px solid #fff;
                outline-offset: 2px;
            }

            .category-config-btn {
                background-color: var(--lcars-blue);
                color: #000;
                border: none;
                height: 40px;
                border-radius: 20px;
                cursor: pointer;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                box-shadow: inset 0 0 0 2px #000;
            }

            .category-config-btn:hover {
                background-color: var(--lcars-beige);
            }

            .category-config-btn.delete {
                background-color: var(--lcars-red);
            }

            /* System Status Display */
            .status-display {
                display: flex;
                align-items: center;
                flex: 1;
                padding-left: 15px;
                height: 100%;
            }

            .status-text {
                color: #000;
                font-weight: bold;
                margin-right: 10px;
                font-size: 1.2rem;
            }

            .status-info {
                background-color: #000;
                color: var(--lcars-orange);
                padding: 0 15px;
                height: 100%;
                border-radius: 0;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: bold;
                font-size: 1.1rem;
            }
        </style>
    </head>
    <body>
        <div class="lcars-app">
            <!-- Header Bar (Left) -->
            <div class="header-bar">
                <div class="header-fill"></div>
                <div class="app-title">ZANDER</div>
                <div class="header-end-cap"></div>
            </div>

            <!-- Sidebar (Right - Full Height) -->
            <aside class="sidebar-container">
                <!-- Top Elbow -->
                <div class="sidebar-top-cap"></div>

                <!-- Middle Track -->
                <div class="sidebar-track" id="categorySidebar">
                    <!-- Categories injected here -->
                </div>

                <!-- Bottom Elbow -->
                <div class="sidebar-bottom-cap"></div>
            </aside>

            <main class="main-content">
                <div id="bookmarksView" class="main-view active">
                    <div id="bookmarkLocation" class="bookmark-location"></div>
                    <div id="bookmarkGrid" class="bookmark-grid">
                        <!-- Bookmarks injected here -->
                    </div>
                    <div
                        id="emptyState"
                        class="empty-state"
                        style="display: none; text-align: center; padding: 50px"
                    >
                        NO ENTRIES FOUND
                    </div>
                </div>
                <div
                    id="settingsView"
                    class="main-view"
                    style="padding: 20px; height: 100%"
                >
                    <div class="settings-panel">
                        <div class="settings-accent"></div>
                        <div class="settings-content">
                            <div class="settings-status">
                                <span>CONFIGURATION MODE</span>
                                <span id="settingsStardate"
                                    >STARDATE 0000000.0000</span
                                >
                            </div>
                            <h1>SYSTEM SETTINGS</h1>

                            <section class="settings-section">
                                <h2>CATEGORY CONFIGURATION</h2>
                                <div id="settingsCategorySectionMain">
                                    <div
                                        id="categoryConfigList"
                                        class="category-config-list"
                                    >
                                        <!-- Rows injected via JS -->
                                    </div>
                                    <button
                                        class="btn-primary"
                                        id="addCategoryBtnMain"
                                        style="width: 100%; margin-bottom: 20px"
                                    >
                                        ADD CATEGORY
                                    </button>
                                </div>
                            </section>

                            <section class="settings-section">
                                <h2>THEME</h2>
                                <div class="form-group">
                                    <div
                                        id="themeControlsContainer"
                                        style="margin-bottom: 10px"
                                    ></div>
                                    <div
                                        id="themeStatusReadout"
                                        style="
                                            font-size: 0.85rem;
                                            opacity: 0.8;
                                            letter-spacing: 1px;
                                        "
                                    >
                                        ACTIVE THEME: PICKARD
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <h2>DATA MANAGEMENT</h2>
</h2>                                <div id="settingsDataSectionMain">
                                    <div class="form-group">
                                        <button
                                            class="btn-primary"
                                            id="exportBtnMain"
                                            style="
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            EXPORT DATABASE
                                        </button>
                                        <button
                                            class="btn-primary"
                                            id="importBtnMain"
                                            style="
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            IMPORT DATABASE
                                        </button>
                                        <input
                                            type="file"
                                            id="importInput"
                                            accept=".json"
                                            style="display: none"
                                        />
                                        <button
                                            class="btn-secondary reset"
                                            id="resetBtnMain"
                                            style="width: 100%"
                                        >
                                            SYSTEM RESET
                                        </button>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <div id="aboutView" class="main-view" style="padding: 20px">
                    <div class="about-panel">
                        <h1>ABOUT ZANDER</h1>
                        <p>
                            <strong>ZANDER BOOKMARK TECHNOLOGIES</strong><br />
                            UNITED FEDERATION OF PLANETS<br />
                            <span id="aboutStardate"
                                >STARDATE 0000000.0000</span
                            >
                        </p>
                        <p>A SINGLE-FILE, OFFLINE-CAPABLE PERSONAL ARCHIVE.</p>
                        <p class="about-meta">
                            DATA PERSISTENCE: LOCAL STORAGE<br />
                            NETWORK STATUS: OFFLINE MODE AVAILABLE
                        </p>
                    </div>
                </div>
            </main>

            <div class="footer-bar">
                <div id="systemStatus" class="status-display"></div>
                <button class="action-btn" id="addBtn">ADD ENTRY</button>
                <div class="settings-wrapper">
                    <button class="action-btn" id="settingsBtn">
                        SETTINGS
                    </button>
                </div>
                <button class="action-btn" id="aboutBtn">ABOUT</button>
            </div>
        </div>

        <!-- Bookmark Dialog -->
        <dialog id="bookmarkDialog">
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <span class="lcars-dialog-title" id="dialogTitle">
                        NEW ENTRY
                    </span>
                    <span class="lcars-dialog-meta" id="bookmarkStardate">
                        STARDATE 0000000.0000
                    </span>
                </div>
                <form id="bookmarkForm" method="dialog">
                    <div class="lcars-dialog-body">
                        <input type="hidden" id="bookmarkId" />
                        <div class="form-group">
                            <label for="titleInput">TITLE</label>
                            <input type="text" id="titleInput" required />
                        </div>
                        <div class="form-group">
                            <label for="urlInput">URL</label>
                            <div style="display: flex; gap: 10px">
                                <select id="urlProtocol" style="width: 120px">
                                    <option value="https://">HTTPS://</option>
                                    <option value="http://">HTTP://</option>
                                </select>
                                <input
                                    type="text"
                                    id="urlInput"
                                    required
                                    placeholder="example.com"
                                    style="flex: 1"
                                />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="categoryInput">CATEGORY</label>
                            <select id="categoryInput">
                                <!-- Options injected -->
                            </select>
                        </div>
                    </div>
                    <div class="lcars-dialog-footer">
                        <button
                            type="button"
                            class="btn-secondary delete"
                            id="deleteBtn"
                            style="display: none"
                        >
                            DELETE
                        </button>
                        <button
                            type="button"
                            class="btn-secondary"
                            onclick="
                                document
                                    .getElementById('bookmarkDialog')
                                    .close()
                            "
                        >
                            CANCEL
                        </button>
                        <button type="submit" class="btn-primary">
                            ENGAGE
                        </button>
                    </div>
                </form>
            </div>
        </dialog>

        <!-- Settings Dialog (no longer used for full settings UI, kept for potential small overlays if needed) -->

        <dialog id="confirmDialog">
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <span class="lcars-dialog-title" id="confirmTitle">
                        CONFIRM
                    </span>
                </div>
                <div class="lcars-dialog-body">
                    <div
                        id="confirmMessage"
                        style="margin: 10px 0 0 0; font-size: 1.2rem"
                    >
                        ARE YOU SURE?
                    </div>
                </div>
                <div class="lcars-dialog-footer">
                    <button class="btn-secondary" id="confirmCancelBtn">
                        CANCEL
                    </button>
                    <button class="btn-primary" id="confirmOkBtn">
                        PROCEED
                    </button>
                </div>
            </div>
        </dialog>

        <dialog id="colorPickerDialog">
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <span class="lcars-dialog-title">SELECT COLOR</span>
                </div>
                <div class="lcars-dialog-body">
                    <div id="colorGrid" class="color-grid"></div>
                </div>
            </div>
        </dialog>

        <script>
            const STORAGE_KEY = "zander-lcars:v1";
            const THEME_STORAGE_KEY = "zander-lcars-theme:v1";

            const THEMES = [
                { id: "pickard", label: "PICKARD" },
                { id: "data", label: "DATA" },
                { id: "doctor", label: "DOCTOR" },
                { id: "spock", label: "SPOCK" },
                { id: "seven", label: "SEVEN OF NINE" },
            ];

            // Default Data
            const DEFAULT_CATEGORIES = [
                {
                    id: "cat-databanks",
                    name: "DATABANKS",
                    color: "#ff9900",
                    createdAt: "2025352.1200",
                    children: [],
                },
            ];

            const DEFAULT_BOOKMARKS = [
                {
                    id: "bm-lcars",
                    title: "LCARS INTERFACE",
                    url: "https://www.thelcars.com",
                    categoryId: "cat-databanks",
                    createdAt: "2025352.1200",
                },
            ];
            const LCARS_PALETTE = [
                "#ff9900",
                "#ffcc00",
                "#ffcc99",
                "#cc9966",
                "#cc99cc",
                "#9999cc",
                "#99ccff",
                "#6699cc",
                "#40e0d0", // turquoise
                "#008080", // teal
                "#cc6666",
                "#ff6666",
                "#ff9966",
                "#ff6699",
                "#66cccc",
                "#999999",
                "#333333",
                "#663399",
                "#0066cc",
                "#ff9933",
            ];

            let state = {
                bookmarks: JSON.parse(JSON.stringify(DEFAULT_BOOKMARKS)),
                categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
                currentCategory: "cat-databanks",
            };

            // Theme state is intentionally separate from bookmark/category state
            // so we don't disturb the existing import/export format.
            let currentTheme = "pickard";

            const grid = document.getElementById("bookmarkGrid");
            const emptyState = document.getElementById("emptyState");
            const sidebar = document.getElementById("categorySidebar");
            const bookmarksView = document.getElementById("bookmarksView");
            const settingsView = document.getElementById("settingsView");
            const aboutView = document.getElementById("aboutView");
            const aboutStardateEl = document.getElementById("aboutStardate");
            const settingsStardateEl =
                document.getElementById("settingsStardate");
            const categoryInput = document.getElementById("categoryInput");
            const bookmarkDialog = document.getElementById("bookmarkDialog");
            const bookmarkForm = document.getElementById("bookmarkForm");
            const dialogTitle = document.getElementById("dialogTitle");
            const deleteBtn = document.getElementById("deleteBtn");
            const bookmarkIdInput = document.getElementById("bookmarkId");
            const titleInput = document.getElementById("titleInput");
            const urlProtocolSelect = document.getElementById("urlProtocol");
            const urlInput = document.getElementById("urlInput");
            const categoryConfigList =
                document.getElementById("categoryConfigList");
            const importInput = document.getElementById("importInput");
            const confirmDialog = document.getElementById("confirmDialog");
            const confirmTitle = document.getElementById("confirmTitle");
            const confirmMessage = document.getElementById("confirmMessage");
            const confirmOkBtn = document.getElementById("confirmOkBtn");
            const confirmCancelBtn =
                document.getElementById("confirmCancelBtn");
            const colorPickerDialog =
                document.getElementById("colorPickerDialog");
            const colorGrid = document.getElementById("colorGrid");

            function showConfirm(title, message, onOk) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;

                const handleOk = () => {
                    onOk();
                    cleanup();
                };

                const handleCancel = () => {
                    cleanup();
                };

                const cleanup = () => {
                    confirmOkBtn.removeEventListener("click", handleOk);
                    confirmCancelBtn.removeEventListener("click", handleCancel);
                    confirmDialog.close();
                };

                confirmOkBtn.addEventListener("click", handleOk);
                confirmCancelBtn.addEventListener("click", handleCancel);
                confirmDialog.showModal();
            }

            function openColorPicker(current, onSelect) {
                colorGrid.innerHTML = "";
                LCARS_PALETTE.forEach((color) => {
                    const btn = document.createElement("button");
                    btn.className = "color-option";
                    btn.style.backgroundColor = color;
                    if (color === current) {
                        btn.style.outline = "2px solid #fff";
                    }
                    btn.onclick = () => {
                        onSelect(color);
                        colorPickerDialog.close();
                    };
                    colorGrid.appendChild(btn);
                });
                colorPickerDialog.showModal();
            }

            function showAlert(title, message) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;

                // For alerts, we present a single-acknowledge LCARS dialog.
                const previousOkLabel = confirmOkBtn.textContent;
                const previousCancelDisplay = confirmCancelBtn.style.display;

                confirmOkBtn.textContent = "ACKNOWLEDGE";
                confirmCancelBtn.style.display = "none";

                const handleOk = () => {
                    confirmOkBtn.removeEventListener("click", handleOk);
                    confirmOkBtn.textContent = previousOkLabel;
                    confirmCancelBtn.style.display = previousCancelDisplay;
                    confirmDialog.close();
                };

                confirmOkBtn.addEventListener("click", handleOk);
                confirmDialog.showModal();
            }

            function init() {
                loadData();
                loadTheme();
                applyTheme(currentTheme);
                renderCategories();
                renderGrid();
                setupEventListeners();
                renderThemeControls();
                updateAboutStardate();
                updateSettingsStardate();
            }

            function loadData() {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    try {
                        const data = JSON.parse(raw);
                        if (Array.isArray(data.bookmarks)) {
                            state.bookmarks = data.bookmarks;
                        }
                        if (
                            Array.isArray(data.categories) &&
                            data.categories.length > 0
                        ) {
                            state.categories = data.categories;
                        }

                        backfillBookmarkCreatedAt(state.bookmarks);
                        backfillCategoryCreatedAt(state.categories);
                    } catch (e) {
                        console.error("Data corruption detected", e);
                    }
                }

                // Ensure current category is valid
                if (
                    !state.categories.find(
                        (c) => c.id === state.currentCategory,
                    )
                ) {
                    state.currentCategory =
                        state.categories[0]?.id || "cat-databanks";
                }
            }

            function saveData() {
                localStorage.setItem(
                    STORAGE_KEY,
                    JSON.stringify({
                        bookmarks: state.bookmarks,
                        categories: state.categories,
                    }),
                );
            }

            function backfillBookmarkCreatedAt(bookmarks) {
                bookmarks.forEach((b) => {
                    if (!b.createdAt) {
                        b.createdAt = calculateStardate();
                    }
                });
            }

            function backfillCategoryCreatedAt(categories) {
                categories.forEach((c) => {
                    if (!c.createdAt) {
                        c.createdAt = calculateStardate();
                    }
                    if (Array.isArray(c.children) && c.children.length > 0) {
                        backfillCategoryCreatedAt(c.children);
                    }
                });
            }

            function setTheme(themeId) {
                const theme =
                    THEMES.find((t) => t.id === themeId) ||
                    THEMES.find((t) => t.id === "pickard");
                currentTheme = theme.id;
                document.body.setAttribute("data-theme", currentTheme);
                localStorage.setItem(THEME_STORAGE_KEY, currentTheme);
                updateThemeStatus();
            }

            function loadTheme() {
                const stored = localStorage.getItem(THEME_STORAGE_KEY);
                if (stored && THEMES.some((t) => t.id === stored)) {
                    setTheme(stored);
                } else {
                    setTheme("pickard");
                }
            }

            function applyTheme(themeId) {
                setTheme(themeId);
            }

            function renderCategories() {
                sidebar.innerHTML = "";

                function createCategoryButton(cat, level) {
                    const wrapper = document.createElement("div");
                    wrapper.className = "cat-wrapper";

                    const btn = document.createElement("button");
                    btn.className = `cat-btn ${state.currentCategory === cat.id ? "active" : ""}`;
                    btn.textContent = cat.name;
                    btn.style.setProperty("--cat-color", cat.color);

                    btn.onclick = (e) => {
                        // Ensure main view is bookmarks when switching category
                        bookmarksView.classList.add("active");
                        settingsView.classList.remove("active");
                        aboutView.classList.remove("active");
                        e.stopPropagation();
                        state.currentCategory = cat.id;
                        renderCategories();
                        renderGrid();
                    };

                    wrapper.appendChild(btn);

                    if (cat.children && cat.children.length > 0 && level < 3) {
                        const submenu = document.createElement("div");
                        submenu.className = "cat-submenu";

                        cat.children.forEach((child) => {
                            submenu.appendChild(
                                createCategoryButton(child, level + 1),
                            );
                        });

                        wrapper.appendChild(submenu);
                    }

                    return wrapper;
                }

                state.categories.forEach((cat) => {
                    sidebar.appendChild(createCategoryButton(cat, 1));
                });

                const filler = document.createElement("div");
                filler.className = "sidebar-filler";
                sidebar.appendChild(filler);

                // Update select in dialog
                categoryInput.innerHTML = "";

                function addOptions(cats, level) {
                    cats.forEach((cat) => {
                        const opt = document.createElement("option");
                        opt.value = cat.id;
                        let prefix = "";
                        for (let i = 1; i < level; i++)
                            prefix += "\u00A0\u00A0"; // Non-breaking spaces
                        if (level > 1) prefix += " ";
                        opt.textContent = prefix + cat.name;
                        categoryInput.appendChild(opt);

                        if (cat.children) {
                            addOptions(cat.children, level + 1);
                        }
                    });
                }
                addOptions(state.categories, 1);

                updateSystemStatus();
                updateBookmarkLocation();
            }

            function createBookmarkTile(bookmark) {
                const tile = document.createElement("a");
                tile.className = "bookmark-tile";

                // Use category color for tile if available
                const cat = state.categories.find(
                    (c) => c.id === bookmark.categoryId,
                );
                const catColor = cat ? cat.color : "var(--lcars-orange)";

                tile.style.setProperty("--cat-color", catColor);

                tile.innerHTML = `
                    <div class="bookmark-title">${escapeHtml(bookmark.title)}</div>
                    <div class="bookmark-url">${escapeHtml(bookmark.url)}</div>
                    <div class="bookmark-edit-icon" title="Edit"></div>
                `;

                // Left click opens
                tile.href = bookmark.url;
                tile.target = "_blank";
                tile.rel = "noopener noreferrer";

                // Edit button click
                const editIcon = tile.querySelector(".bookmark-edit-icon");
                editIcon.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    openEditDialog(bookmark);
                };



                // Right click (context menu) or long press to edit
                tile.oncontextmenu = (e) => {
                    e.preventDefault();
                    openEditDialog(bookmark);
                };

                return tile;
            }

            function renderGrid() {
                grid.innerHTML = "";
                const filtered = state.bookmarks.filter(
                    (b) => b.categoryId === state.currentCategory,
                );

                if (filtered.length === 0) {
                    emptyState.style.display = "block";
                } else {
                    emptyState.style.display = "none";
                    filtered.forEach((b) => {
                        const tile = createBookmarkTile(b);
                        grid.appendChild(tile);
                    });
                }
                updateSystemStatus();
                updateBookmarkLocation();
            }

            function formatCurrentStardateDisplay() {
                const sd = calculateStardate();
                const date = parseStardate(sd);
                return {
                    stardate: sd,
                    label: `STARDATE ${sd}`,
                    tooltip: date ? date.toLocaleString() : "",
                };
            }

            function updateAboutStardate() {
                if (!aboutStardateEl) return;
                const info = formatCurrentStardateDisplay();
                aboutStardateEl.textContent = info.label;
                aboutStardateEl.title = info.tooltip;
            }

            function updateSettingsStardate() {
                if (!settingsStardateEl) return;
                const info = formatCurrentStardateDisplay();
                settingsStardateEl.textContent = info.label;
                settingsStardateEl.title = info.tooltip;
            }

            function updateSystemStatus() {
                const statusEl = document.getElementById("systemStatus");
                if (statusEl) {
                    const catCount = state.categories.length;
                    const bmCount = state.bookmarks.length;
                    statusEl.innerHTML = `
                        <span class="status-text">STATUS:</span>
                        <div class="status-info">
                            <span>CT: ${catCount}</span>
                            <span></span>
                            <span>BM: ${bmCount}</span>
                        </div>
                    `;
                }
            }

            function updateThemeStatus() {
                const themeStatusEl =
                    document.getElementById("themeStatusReadout");
                if (!themeStatusEl) return;
                const current =
                    THEMES.find((t) => t.id === currentTheme) ||
                    THEMES[0];
                themeStatusEl.textContent = `ACTIVE THEME: ${current.label}`;
            }

            function calculateStardate(date = new Date()) {
                const start = new Date(date.getFullYear(), 0, 0);
                const diff = date - start;
                const oneDay = 1000 * 60 * 60 * 24;
                const day = Math.floor(diff / oneDay);
                const minutes = date.getHours() * 60 + date.getMinutes();

                // Format: YYYYDDD.MMMM (Year + DayOfYear . TotalMinutes)
                return `${date.getFullYear()}${day.toString().padStart(3, "0")}.${minutes.toString().padStart(4, "0")}`;
            }

            function parseStardate(stardate) {
                if (!stardate || typeof stardate !== "string") return null;
                const year = parseInt(stardate.substring(0, 4));
                const dayOfYear = parseInt(stardate.substring(4, 7));
                const minutes = parseInt(stardate.substring(8));

                if (isNaN(year) || isNaN(dayOfYear) || isNaN(minutes))
                    return null;

                const date = new Date(year, 0, dayOfYear);
                date.setHours(Math.floor(minutes / 60));
                date.setMinutes(minutes % 60);
                return date;
            }

            // Generic category tree walker used by config, lookups, etc.
            // visitor(cat, parent, depth, index, siblings) can return a non-undefined
            // value to short-circuit traversal with that value.
            function walkCategories(rootCategories, visitor, parent = null, depth = 0) {
                for (let i = 0; i < rootCategories.length; i++) {
                    const cat = rootCategories[i];
                    const result = visitor(cat, parent, depth, i, rootCategories);
                    if (result !== undefined) {
                        return result;
                    }
                    if (cat.children && cat.children.length > 0) {
                        const childResult = walkCategories(
                            cat.children,
                            visitor,
                            cat,
                            depth + 1,
                        );
                        if (childResult !== undefined) {
                            return childResult;
                        }
                    }
                }
                return undefined;
            }

            function getCategoryPath(id, cats) {
                // Returns an array of category objects from root to the category with the given id,
                // or null if no such category exists.
                function helper(nodes, path) {
                    for (const cat of nodes) {
                        const newPath = [...path, cat];
                        if (cat.id === id) {
                            return newPath;
                        }
                        if (cat.children && cat.children.length > 0) {
                            const childPath = helper(cat.children, newPath);
                            if (childPath) return childPath;
                        }
                    }
                    return null;
                }
                return helper(cats, []);
            }

            function updateBookmarkLocation() {
                const locEl = document.getElementById("bookmarkLocation");
                if (!locEl) return;

                if (!state.currentCategory) {
                    locEl.innerHTML = "";
                    return;
                }

                const path = getCategoryPath(
                    state.currentCategory,
                    state.categories,
                );
                if (!path || path.length === 0) {
                    locEl.innerHTML = "";
                    return;
                }

                const parts = path
                    .map((cat) => `<span>${escapeHtml(cat.name)}</span>`)
                    .join('<span class="bookmark-location-separator"></span>');

                locEl.innerHTML = `
                    <span class="bookmark-location-label">LOCATION:</span>
                    <span class="bookmark-location-path">
                        ${parts}
                    </span>
                `;
            }

            function generateUUID() {
                if (typeof crypto !== "undefined" && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                    /[xy]/g,
                    function (c) {
                        var r = (Math.random() * 16) | 0,
                            v = c == "x" ? r : (r & 0x3) | 0x8;
                        return v.toString(16);
                    },
                );
            }

            function escapeHtml(str) {
                if (!str) return "";
                return str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function normalizeUrl(s, defaultProtocol = "https://") {
                const trimmed = String(s || "").trim();
                if (!trimmed) return "";
                // If it doesn't start with a scheme like http:, https:, ftp:, mailto:, etc.,
                // assume the provided default protocol (normally https:// or http://)
                if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmed)) {
                    // Strip any leading slashes so we don't end up with https:////example.com
                    const withoutSlashes = trimmed.replace(/^\/+/, "");
                    return `${defaultProtocol}${withoutSlashes}`;
                }
                return trimmed;
            }

            function isProbablyUrl(s) {
                try {
                    const url = new URL(s);
                    return ["http:", "https:"].includes(url.protocol);
                } catch {
                    return false;
                }
            }

            function openAddDialog() {
                dialogTitle.textContent = "ADD ENTRY";

                const stardateEl = document.getElementById("bookmarkStardate");
                const info = formatCurrentStardateDisplay();
                stardateEl.textContent = info.label;
                stardateEl.title = info.tooltip;

                bookmarkForm.reset();
                bookmarkIdInput.value = "";
                urlProtocolSelect.value = "https://";
                categoryInput.value = state.currentCategory;
                deleteBtn.style.display = "none";
                bookmarkDialog.showModal();
            }

            function openEditDialog(bookmark) {
                dialogTitle.textContent = "EDIT ENTRY";

                const stardateEl = document.getElementById("bookmarkStardate");
                if (bookmark.createdAt) {
                    stardateEl.textContent = `STARDATE ${bookmark.createdAt}`;
                    const date = parseStardate(bookmark.createdAt);
                    stardateEl.title = date ? date.toLocaleString() : "";
                } else {
                    stardateEl.textContent = "";
                    stardateEl.title = "";
                }

                bookmarkIdInput.value = bookmark.id;
                titleInput.value = bookmark.title;

                let url = bookmark.url;
                let protocol = "https://";
                if (url.startsWith("http://")) {
                    protocol = "http://";
                    url = url.substring(7);
                } else if (url.startsWith("https://")) {
                    protocol = "https://";
                    url = url.substring(8);
                }

                urlProtocolSelect.value = protocol;
                urlInput.value = url;

                categoryInput.value =
                    bookmark.categoryId || state.categories[0].id;
                deleteBtn.style.display = "inline-block";
                deleteBtn.onclick = () => deleteBookmark(bookmark.id);
                bookmarkDialog.showModal();
            }

            function saveBookmark(e) {
                e.preventDefault(); // Prevent default form submission

                const id = bookmarkIdInput.value;
                const title = titleInput.value;
                const protocol = urlProtocolSelect.value;
                const rawUrl = urlInput.value.trim();
                const categoryId = categoryInput.value;

                // Normalize URL using selected protocol as default, but still respect
                // full URLs the user may have pasted (http/https and other schemes)
                const url = normalizeUrl(rawUrl, protocol);

                if (id) {
                    // Edit
                    const idx = state.bookmarks.findIndex((b) => b.id === id);
                    if (idx !== -1) {
                        state.bookmarks[idx].title = title;
                        state.bookmarks[idx].url = url;
                        state.bookmarks[idx].categoryId = categoryId;
                    }
                } else {
                    // Add
                    const newBookmark = {
                        id: generateUUID(),
                        title,
                        url,
                        categoryId,
                        createdAt: calculateStardate(),
                    };
                    state.bookmarks.push(newBookmark);
                }

                saveData();
                renderGrid();
                bookmarkDialog.close();
            }

            function deleteBookmark(id) {
                showConfirm("DELETE ENTRY", "CONFIRM DELETION?", () => {
                    state.bookmarks = state.bookmarks.filter(
                        (b) => b.id !== id,
                    );
                    saveData();
                    renderGrid();
                    bookmarkDialog.close();
                });
            }

            // --- Category Management ---

            function findCategoryAndParent(id, cats, parent) {
                return walkCategories(
                    cats,
                    (cat, parentNode, depth, index, siblings) => {
                        if (cat.id === id) {
                            return {
                                category: cat,
                                parent: parentNode,
                                siblings,
                                index,
                            };
                        }
                        return undefined;
                    },
                    parent,
                ) || null;
            }

            function renderCategoryConfig() {
                categoryConfigList.innerHTML = "";

                function renderConfigRow(cat, parent, index, siblings, level) {
                    const row = document.createElement("div");
                    row.className = "category-config-row";
                    // Indent
                    row.style.paddingLeft = `${(level - 1) * 40}px`;

                    // Color Picker
                    const colorBtn = document.createElement("button");
                    colorBtn.className = "category-color-swatch";
                    colorBtn.style.backgroundColor = cat.color;
                    colorBtn.onclick = () => {
                        openColorPicker(cat.color, (newColor) => {
                            cat.color = newColor;
                            saveData();
                            renderCategories();
                            renderGrid();
                            renderCategoryConfig();
                        });
                    };

                    // Name Input
                    const nameInput = document.createElement("input");
                    nameInput.type = "text";
                    nameInput.value = cat.name;
                    nameInput.style.width = "100%";
                    nameInput.style.backgroundColor = "#222";
                    nameInput.style.border = "1px solid var(--lcars-blue)";
                    nameInput.style.color = "var(--lcars-beige)";
                    nameInput.style.borderRadius = "20px";
                    nameInput.style.padding = "8px 12px";
                    nameInput.onchange = (e) => {
                        cat.name = e.target.value.toUpperCase();
                        saveData();
                        renderCategories();
                    };

                    // Move Up
                    const upBtn = document.createElement("button");
                    upBtn.className = "category-config-btn";
                    upBtn.innerHTML = "";
                    upBtn.disabled = index === 0;
                    if (index === 0) upBtn.style.opacity = "0.5";
                    upBtn.onclick = () => moveCategory(cat.id, -1);

                    // Move Down
                    const downBtn = document.createElement("button");
                    downBtn.className = "category-config-btn";
                    downBtn.innerHTML = "";
                    downBtn.disabled = index === siblings.length - 1;
                    if (index === siblings.length - 1)
                        downBtn.style.opacity = "0.5";
                    downBtn.onclick = () => moveCategory(cat.id, 1);

                    // Add Subcategory (New)
                    const addBtn = document.createElement("button");
                    addBtn.className = "category-config-btn";
                    addBtn.innerHTML = "+";
                    addBtn.title = "Add Subcategory";
                    if (level >= 3) {
                        addBtn.disabled = true;
                        addBtn.style.opacity = "0.5";
                    }
                    addBtn.onclick = () => addCategory(cat.id);

                    // Delete
                    const delBtn = document.createElement("button");
                    delBtn.className = "category-config-btn delete";
                    delBtn.innerHTML = "";
                    delBtn.onclick = () => deleteCategory(cat.id);

                    row.appendChild(colorBtn);
                    row.appendChild(nameInput);
                    row.appendChild(upBtn);
                    row.appendChild(downBtn);
                    row.appendChild(addBtn);
                    row.appendChild(delBtn);

                    categoryConfigList.appendChild(row);
                }

                walkCategories(state.categories, (cat, parent, depth, index, siblings) => {
                    // depth is 0-based from root; config UI levels start at 1
                    const level = depth + 1;
                    renderConfigRow(cat, parent, index, siblings, level);
                    return undefined;
                });
            }

            function addCategory(parentId = null) {
                const newCat = {
                    id: generateUUID(),
                    name: "NEW CATEGORY",
                    color: LCARS_PALETTE[
                        Math.floor(Math.random() * LCARS_PALETTE.length)
                    ],
                    createdAt: calculateStardate(),
                    children: [],
                };

                if (parentId) {
                    const result = findCategoryAndParent(
                        parentId,
                        state.categories,
                        null,
                    );
                    if (result) {
                        if (!result.category.children)
                            result.category.children = [];
                        result.category.children.push(newCat);
                    }
                } else {
                    state.categories.push(newCat);
                }

                saveData();
                renderCategories();
                renderCategoryConfig();
            }

            function moveCategory(id, direction) {
                const result = findCategoryAndParent(
                    id,
                    state.categories,
                    null,
                );
                if (!result) return;

                const { siblings, index } = result;
                const newIndex = index + direction;

                if (newIndex >= 0 && newIndex < siblings.length) {
                    const temp = siblings[index];
                    siblings[index] = siblings[newIndex];
                    siblings[newIndex] = temp;
                    saveData();
                    renderCategories();
                    renderCategoryConfig();
                }
            }

            function deleteCategory(id) {
                const result = findCategoryAndParent(
                    id,
                    state.categories,
                    null,
                );
                if (!result) return;

                const cat = result.category;

                // Collect full subtree for accurate counts and deletion
                const subtreeCategories = [];
                walkCategories([cat], (node) => {
                    subtreeCategories.push(node);
                    return undefined;
                });

                const subtreeIds = new Set(subtreeCategories.map((c) => c.id));

                // Count bookmarks across entire subtree
                const totalBookmarksInSubtree = state.bookmarks.filter((b) =>
                    subtreeIds.has(b.categoryId),
                ).length;

                const subCategoryCount = subtreeCategories.length - 1; // exclude root

                let msg = `Delete category "${cat.name}"?`;
                if (totalBookmarksInSubtree > 0) {
                    msg += `\nThis will delete ${totalBookmarksInSubtree} bookmark(s).`;
                }
                if (subCategoryCount > 0) {
                    msg += `\nThis will delete ${subCategoryCount} sub-categories.`;
                }

                showConfirm("DELETE CATEGORY", msg, () => {
                    // Remove all bookmarks in the subtree in a single pass
                    state.bookmarks = state.bookmarks.filter(
                        (b) => !subtreeIds.has(b.categoryId),
                    );

                    // Remove category
                    const { siblings, index } = result;
                    siblings.splice(index, 1);

                    // If current category was deleted or inside deleted tree, reset to first available
                    const currentExists = findCategoryAndParent(
                        state.currentCategory,
                        state.categories,
                        null,
                    );
                    if (!currentExists && state.categories.length > 0) {
                        state.currentCategory = state.categories[0].id;
                    } else if (state.categories.length === 0) {
                        // Create default if all deleted
                        state.categories.push({
                            id: "cat-default",
                            name: "DEFAULT",
                            color: "#ff9900",
                            createdAt: calculateStardate(),
                            children: [],
                        });
                        state.currentCategory = "cat-default";
                    }

                    saveData();
                    renderCategories();
                    renderGrid();
                    renderCategoryConfig();
                });
            }

            function getDataBundle() {
                return {
                    bookmarks: state.bookmarks,
                    categories: state.categories,
                };
            }

            function applyDataBundle(bundle) {
                state.bookmarks = Array.isArray(bundle.bookmarks)
                    ? bundle.bookmarks
                    : [];
                state.categories = Array.isArray(bundle.categories)
                    ? bundle.categories
                    : [];

                // Backfill createdAt fields on imported data
                backfillBookmarkCreatedAt(state.bookmarks);
                backfillCategoryCreatedAt(state.categories);

                saveData();
                renderCategories();
                renderGrid();
            }

            function exportData() {
                const dataStr = JSON.stringify(getDataBundle(), null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `lcars-bookmarks-${new Date().toISOString().split("T")[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function triggerImport() {
                importInput.click();
            }

            function handleImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Basic structure validation
                        if (typeof data !== "object" || data === null) {
                            showAlert("ERROR", "INVALID DATA FORMAT (expected an object).");
                            return;
                        }

                        const bookmarks = Array.isArray(data.bookmarks)
                            ? data.bookmarks
                            : [];
                        const categories = Array.isArray(data.categories)
                            ? data.categories
                            : [];

                        if (!Array.isArray(data.bookmarks) && !Array.isArray(data.categories)) {
                            showAlert(
                                "ERROR",
                                "INVALID DATA FORMAT (missing bookmarks and categories arrays).",
                            );
                            return;
                        }

                        const count = bookmarks.length;

                        showConfirm(
                            "IMPORT DATA",
                            `IMPORT ${count} ENTRIES? THIS WILL OVERWRITE CURRENT DATA.`,
                            () => {
                                const bundle = {
                                    bookmarks,
                                    categories,
                                };
                                applyDataBundle(bundle);
                            },
                        );
                    } catch (err) {
                        showAlert("ERROR", "INVALID DATA FORMAT (could not parse JSON).");
                    }
                };
                reader.readAsText(file);
                e.target.value = ""; // Reset
            }

            function resetSystem() {
                showConfirm(
                    "SYSTEM RESET",
                    "WARNING: SYSTEM RESET WILL ERASE ALL DATA. PROCEED?",
                    () => {
                        localStorage.removeItem(STORAGE_KEY);
                        const bundle = {
                            bookmarks: JSON.parse(
                                JSON.stringify(DEFAULT_BOOKMARKS),
                            ),
                            categories: JSON.parse(
                                JSON.stringify(DEFAULT_CATEGORIES),
                            ),
                        };
                        applyDataBundle(bundle);
                        // Do not reset theme on system reset; theme is a UI preference.
                    },
                );
            }

            function renderThemeControls() {
                const container = document.getElementById(
                    "themeControlsContainer",
                );
                if (!container) return;
                container.innerHTML = "";

                THEMES.forEach((theme) => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "btn-secondary";
                    btn.textContent = theme.label;
                    btn.onclick = () => applyTheme(theme.id);
                    container.appendChild(btn);
                });

                updateThemeStatus();
            }

            function onClick(id, handler) {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("click", handler);
                }
            }

            function onChange(id, handler) {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("change", handler);
                }
            }

            // --- Event Listeners ---
            function setupEventListeners() {
                onClick("settingsBtn", () => {
                    // Switch to settings main view
                    bookmarksView.classList.remove("active");
                    aboutView.classList.remove("active");
                    settingsView.classList.add("active");
                    renderCategoryConfig();
                    updateSettingsStardate();
                });

                onClick("addBtn", () => {
                    // Ensure main view is bookmarks when adding an entry
                    bookmarksView.classList.add("active");
                    settingsView.classList.remove("active");
                    aboutView.classList.remove("active");
                    openAddDialog();
                });

                onClick("aboutBtn", () => {
                    bookmarksView.classList.remove("active");
                    settingsView.classList.remove("active");
                    aboutView.classList.add("active");
                    updateAboutStardate();
                });

                bookmarkForm.addEventListener("submit", saveBookmark);

                // Keyboard Shortcuts
                document.addEventListener("keydown", (e) => {
                    if (e.altKey) {
                        switch (e.key.toLowerCase()) {
                            case "n":
                                e.preventDefault();
                                // Switch back to bookmarks view on New Entry
                                bookmarksView.classList.add("active");
                                settingsView.classList.remove("active");
                                aboutView.classList.remove("active");
                                openAddDialog();
                                break;
                            case "s":
                                e.preventDefault();
                                // Switch to settings main view via keyboard
                                bookmarksView.classList.remove("active");
                                aboutView.classList.remove("active");
                                settingsView.classList.add("active");
                                renderCategoryConfig();
                                updateSettingsStardate();
                                break;
                            case "c":
                                e.preventDefault();
                                // Alt+C: new category while in settings
                                if (settingsView.classList.contains("active")) {
                                    addCategory(null);
                                    renderCategoryConfig();
                                }
                                break;
                        }
                    }
                });

                // Settings data actions
                onClick("exportBtnMain", exportData);
                onClick("importBtnMain", triggerImport);
                onClick("resetBtnMain", resetSystem);
                onClick("addCategoryBtnMain", () => {
                    addCategory(null);
                    renderCategoryConfig();
                });
                onChange("importInput", handleImport);

                // Theme controls
                renderThemeControls();

                // Dialog close on ESC
                bookmarkDialog.addEventListener("cancel", (e) => {
                    e.preventDefault();
                    bookmarkDialog.close();
                });
            }

            // Start
            init();
        </script>
    </body>
</html>
