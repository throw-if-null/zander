<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ZANDER</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                /* ==============================================
                   DESIGN SYSTEM TOKENS
                   ============================================== */

                /* Color Palette: Core LCARS colors */
                --lcars-black: #000000;
                --lcars-white: #ffffff;
                --lcars-orange: #ff9900;
                --lcars-purple: #cc99cc;
                --lcars-red: #cc6666;
                --lcars-blue: #9999cc;
                --lcars-beige: #ffcc99;
                --lcars-gray: #999999;

                /* Color Palette: Dark shades for surfaces */
                --lcars-dark-1: #111111;
                --lcars-dark-2: #222222;
                --lcars-dark-3: #444444;

                /* Typography */
                --lcars-font: "Antonio", sans-serif;

                /* Spacing */
                --lcars-gutter: 5px;
                --lcars-gap: 10px;

                /* Border Radii */
                --lcars-radius-xs: 5px;
                --lcars-radius-sm: 14px;
                --lcars-radius-md: 20px;
                --lcars-radius-lg: 30px;

                /* Tile Tokens */
                --lcars-tile-stripe-width: 12px;
                --lcars-tile-stripe-width-lg: 15px;
                --lcars-tile-min-height: 110px;
                --lcars-tile-min-height-lg: 140px;

                /* Layout variables */
                --sidebar-width: 160px;
                --header-height: 80px;

                /* Focus system */
                --lcars-focus-outline-width: 3px;
                --lcars-focus-outline-color: var(--lcars-white);
                --lcars-focus-outline-offset: 2px;

                /* Z-index scale */
                --lcars-z-index-dropdown: 1000;
                --lcars-z-index-dialog: 2000;
                --lcars-z-index-tooltip: 3000;

                /* Transition timing */
                --lcars-transition-fast: 0.1s ease-out;
                --lcars-transition-normal: 0.2s ease-out;

                /* Spacing scale */
                --lcars-spacing-xs: 5px;
                --lcars-spacing-sm: 8px;
                --lcars-spacing-md: 15px;
                --lcars-spacing-lg: 20px;
                --lcars-spacing-xl: 30px;

                /* ==============================================
                   COMPONENT-LEVEL VARIABLE DOCUMENTATION
                   These are set inline by JS or via component CSS:

                   --cat-color: Category button background (set by JS)
                   --lcars-button-bg: Button background color
                   --lcars-button-fg: Button foreground color
                   --lcars-button-radius: Button border radius
                   --lcars-button-hover-filter: Hover effect filter
                   --lcars-pin-size: Pin/circular button size
                   --lcars-pin-bg: Pin background color
                   --lcars-pin-fg: Pin foreground color
                   ============================================== */
            }

            /* ==============================================
               THEME VARIANTS
               Applied via data-theme attribute on <body>
               ============================================== */
            body[data-theme="laan"] {
                --theme-main: #830025;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="data"] {
                --theme-main: #da9706;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="doctor"] {
                --theme-main: #008b8b; /* LCARS-ish teal */
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="chapel"] {
                --theme-main: var(--lcars-white);
                --shape-color: var(--theme-main);
                --theme-secondary: var(--lcars-gray);
            }

            body[data-theme="spock"] {
                --theme-main: #003366;
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );
            }

            body[data-theme="seven"] {
                /* LCARS-friendly darker silver main tone */
                --theme-main: #8c8c8c;
                --shape-color: var(--theme-main);
                /* Borg green secondary accent */
                --theme-secondary: #7fff00;
            }

            body[data-theme="mbenga"] {
                --theme-main: #92b7dd;
                --shape-color: var(--theme-main);
                --theme-secondary: var(--lcars-white);
            }

            body[data-theme="shran"] {
                --theme-main: #282b29;
                --shape-color: var(--theme-main);
                --theme-secondary: #78bff5;
            }

            /* ==============================================
               SCOPED RESET
               Box-sizing scoped to LCARS app and dialogs to avoid affecting host pages
               ============================================== */
            .lcars-app,
            .lcars-app *,
            .lcars-app *::before,
            .lcars-app *::after,
            .lcars-dialog-container,
            .lcars-dialog-container *,
            .lcars-dialog-container *::before,
            .lcars-dialog-container *::after {
                box-sizing: border-box;
            }

            /* ==============================================
               FOCUS SYSTEM
               Unified to 3px for strong a11y contrast
               Scoped to .lcars-app and dialogs to avoid leaking into host pages
               ============================================== */

            /* Default focus style for interactive elements within LCARS app and dialogs */
            .lcars-app :focus-visible,
            .lcars-dialog-container :focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
                box-shadow: none;
            }

            /* Explicit helper class for outline focus (same as default, for clarity) */
            .lcars-focus-outline:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* Pill buttons, inputs, and config buttons use outline focus */
            .lcars-pill:focus-visible,
            .lcars-input:focus-visible,
            .lcars-select:focus-visible,
            .lcars-textarea:focus-visible,
            .category-config-btn:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* ==============================================
               BODY: Theme Variables
               Theme variables live on body so data-theme can override them.
               Visual styles are scoped to .lcars-app for embedding flexibility.
               ============================================== */
            body {
                /* Theme variables (can be overridden by data-theme) */
                --theme-main: #830025; /* default: La'An */

                /* --shape-color: Controls the LCARS frame color (header, footer, sidebar, elbows).
                   By default it inherits from --theme-main, but can be overridden independently
                   to allow frame color customization without changing the entire theme.
                   Used by: .lcars-frame-segment, .lcars-header-bar, .lcars-footer-bar,
                   .lcars-sidebar-bar-*, .lcars-elbow, dialog borders, and other frame elements. */
                --shape-color: var(--theme-main);
                --theme-secondary: color-mix(
                    in srgb,
                    var(--shape-color) 30%,
                    var(--lcars-white) 70%
                );

                /* Minimal body reset - only what's needed for full-page ZANDER */
                margin: 0;
            }

            /* ==============================================
               LCARS APP CONTAINER
               All visual styles scoped here for embedding flexibility.
               When used as full-page app, add .lcars-app--fullpage modifier.
               ============================================== */
            .lcars-app {
                /* Visual styling scoped to the component */
                background-color: var(--lcars-black);
                color: var(--lcars-orange);
                font-family: var(--lcars-font);

                /* Layout Grid */
                display: grid;
                grid-template-columns: 1fr 160px; /* Content | Sidebar */
                grid-template-rows: 70px 1fr 70px; /* Header | Main | Footer */
                height: 100%;
                padding: 10px;
                gap: 0; /* Seamless connections */
            }

            /* Full-page modifier for standalone ZANDER app */
            .lcars-app--fullpage {
                height: 100vh;
                overflow: hidden;
            }

            /* LCARS frame segment primitives */
            .lcars-frame-segment {
                background-color: var(--shape-color);
            }

            .lcars-frame-segment--horizontal {
                display: flex;
                align-items: center;
            }

            .lcars-frame-segment--left-rounded {
                border-top-left-radius: var(--lcars-radius-lg);
                border-bottom-left-radius: var(--lcars-radius-lg);
            }

            /* ==============================================
               LCARS SHELL BAR PRIMITIVES
               Reusable header, footer, and sidebar bars
               ============================================== */

            /* --- LCARS Header Bar --- */
            .lcars-header-bar {
                --lcars-header-bar-height: 40px;
                --lcars-header-bar-gap: 0;

                /* Grid positioning when used in lcars-app */
                grid-column: 1;
                grid-row: 1;
                align-self: start;
                margin-right: -1px;

                display: flex;
                align-items: stretch;
                justify-content: flex-start;
                padding-left: var(--lcars-header-bar-gap);
                padding-right: 0;
                height: var(--lcars-header-bar-height);
                background-color: var(--shape-color);
                border-top-left-radius: var(--lcars-radius-lg);
                border-bottom-left-radius: var(--lcars-radius-lg);
            }

            .lcars-header-bar-home {
                color: var(--lcars-orange);
                background-color: var(--lcars-black);
                font-size: 44px;
                line-height: 1;
                font-weight: bold;
                text-transform: uppercase;
                padding: 0 10px;
                margin: 0;
                margin-left: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                letter-spacing: -1px;
                border: none;
                cursor: pointer;
                position: relative;
            }

            .lcars-header-bar-home:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
                box-shadow: none;
            }

            .lcars-header-bar-fill {
                flex: 1;
                height: var(--lcars-header-bar-height, 40px);
            }

            .lcars-header-bar-end-cap {
                width: 20px;
                background-color: var(--shape-color);
            }

            /* --- LCARS Footer Bar --- */
            .lcars-footer-bar {
                --lcars-footer-bar-height: 40px;

                display: flex;
                align-items: center;
                justify-content: flex-start;
                padding-left: 0;
                padding-right: 0;
                gap: 0;
                height: var(--lcars-footer-bar-height);
                background-color: var(--shape-color);
                border-top-left-radius: var(--lcars-radius-lg);
                border-bottom-left-radius: var(--lcars-radius-lg);
            }

            .lcars-footer-bar-status {
                display: flex;
                align-items: center;
                flex: 1;
                padding-left: 15px;
                height: 100%;
            }

            .lcars-footer-bar-actions {
                display: flex;
                align-items: center;
                height: 100%;
                gap: 0;
            }

            /* --- LCARS Sidebar Bar --- */
            .lcars-sidebar-bar {
                --lcars-sidebar-bar-width: var(--sidebar-width, 110px);
                --lcars-sidebar-bar-elbow-height: 70px;

                display: flex;
                flex-direction: column;
                width: var(--lcars-sidebar-bar-width);
                height: 100%;
            }

            .lcars-sidebar-bar-top-cap {
                height: var(--lcars-sidebar-bar-elbow-height);
                width: 100%;
                --elbow-position: bottom left;
                --elbow-radius-top-right: var(--lcars-radius-lg);
                background: radial-gradient(
                    circle at var(--elbow-position),
                    var(--lcars-black) var(--lcars-radius-lg),
                    var(--shape-color) calc(var(--lcars-radius-lg) + 0.5px)
                );
                border-top-right-radius: var(--lcars-radius-lg);
            }

            .lcars-sidebar-bar-track {
                flex: 1;
                min-height: 0;
                background: none;
                display: flex;
                flex-direction: column;
                gap: 0;
                padding: 0 0 0 calc(var(--lcars-radius-lg) + 0.5px);
                position: relative;
            }

            .lcars-sidebar-bar-filler {
                flex: 1;
                background-color: var(--shape-color);
            }

            .lcars-sidebar-bar-bottom-cap {
                height: var(--lcars-sidebar-bar-elbow-height);
                width: 100%;
                --elbow-position: top left;
                --elbow-radius-bottom-right: var(--lcars-radius-lg);
                background: radial-gradient(
                    circle at var(--elbow-position),
                    var(--lcars-black) var(--lcars-radius-lg),
                    var(--shape-color) calc(var(--lcars-radius-lg) + 0.5px)
                );
                border-bottom-right-radius: var(--lcars-radius-lg);
            }

            /* Decorative variant - just a visual bar */
            .lcars-sidebar-bar--decorative .lcars-sidebar-bar-track {
                background-color: var(--shape-color);
            }

            /* --- LCARS Status Display --- */
            .lcars-status-display {
                --lcars-status-label-bg: var(--theme-secondary);
                --lcars-status-label-color: var(--lcars-black);
                --lcars-status-value-bg: var(--lcars-black);
                --lcars-status-value-color: var(--lcars-orange);

                display: flex;
                align-items: center;
                height: 100%;
                flex: 1;
                padding-left: 15px;
            }

            .lcars-status-text {
                color: var(--lcars-black);
                font-weight: bold;
                margin-right: 10px;
                font-size: 1.2rem;
            }

            .lcars-status-info {
                background-color: var(--lcars-status-value-bg);
                color: var(--lcars-status-value-color);
                padding: 0 15px;
                height: 100%;
                border-radius: 0;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: bold;
                font-size: 1.1rem;
            }

            .lcars-status-label {
                background-color: var(--lcars-status-label-bg);
                color: var(--lcars-status-label-color);
                padding: 2px 6px;
                font-size: 0.9rem;
                font-weight: bold;
            }

            .lcars-status-value {
                color: var(--lcars-status-value-color);
                font-weight: bold;
            }

            /* ==============================================
               END LCARS SHELL BAR PRIMITIVES
               ============================================== */

            .header-fill {
                flex: 1;
                height: 40px;
            }

            .header-end-cap {
                width: 20px;
                background-color: var(--shape-color);
            }

            /* Sidebar (Full Height Column) */
            .lcars-sidebar-bar {
                grid-column: 2;
                grid-row: 1 / 4;
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
            }

            /* Generic LCARS elbow component */
            .lcars-elbow {
                height: 70px;
                width: 100%;

                /* Default orientation and radii (can be overridden per use) */
                --elbow-position: bottom left;
                --elbow-radius-top-left: 0;
                --elbow-radius-top-right: 0;
                --elbow-radius-bottom-right: 0;
                --elbow-radius-bottom-left: 0;

                background: radial-gradient(
                    circle at var(--elbow-position),
                    var(--lcars-black) var(--lcars-radius-lg),
                    var(--shape-color) calc(var(--lcars-radius-lg) + 0.5px)
                );

                border-top-left-radius: var(--elbow-radius-top-left);
                border-top-right-radius: var(--elbow-radius-top-right);
                border-bottom-right-radius: var(--elbow-radius-bottom-right);
                border-bottom-left-radius: var(--elbow-radius-bottom-left);
            }

            /* Top Elbow Connector (right side, opening downward) */
            .lcars-sidebar-bar-top-cap {
                --elbow-position: bottom left;
                --elbow-radius-top-right: var(--lcars-radius-lg);
            }

            /* Middle Sidebar Track - now a flex container for scroll buttons + categories */
            .lcars-sidebar-bar-track {
                flex: 1;
                min-height: 0; /* Allow flex item to shrink below content size */
                background: none;
                display: flex;
                flex-direction: column;
                gap: 0;
                padding: 0 0 0 calc(var(--lcars-radius-lg) + 0.5px);
                position: relative; /* Establish positioning context for submenus */
            }

            /* ==============================================
               LCARS SCROLL CONTAINER PRIMITIVE
               A scrollable container with hidden scrollbar.
               Mouse wheel and touch scrolling still work.
               ============================================== */
            .lcars-scroll-container {
                overflow-y: auto;
                /* Note: overflow-x is NOT set to allow child elements (like submenus) to overflow */
                /* Hide scrollbar but keep functionality */
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
            }

            .lcars-scroll-container::-webkit-scrollbar {
                display: none; /* Chrome/Safari/Opera */
            }

            /* ==============================================
               LCARS ARROW BUTTON PRIMITIVE
               A flat directional control with triangle indicator.
               Used for scroll controls, pagination, carousels, etc.
               ============================================== */
            .lcars-arrow-btn {
                --lcars-arrow-btn-height: 24px;
                --lcars-arrow-btn-bg: var(--shape-color);
                --lcars-arrow-btn-bg-hover: var(--lcars-beige);
                --lcars-arrow-btn-bg-focus: var(--shape-color);
                --lcars-arrow-btn-arrow-size: 40px 12px;
                --lcars-arrow-btn-arrow-color: var(--lcars-black);

                display: flex;
                align-items: center;
                justify-content: center;
                height: var(--lcars-arrow-btn-height);
                min-height: var(--lcars-arrow-btn-height);
                background-color: var(--lcars-arrow-btn-bg);
                border: none;
                cursor: pointer;
                transition: background-color var(--lcars-transition-normal);
            }

            .lcars-arrow-btn:hover {
                background-color: var(--lcars-arrow-btn-bg-hover);
            }

            .lcars-arrow-btn:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: calc(-1 * var(--lcars-focus-outline-width));
                background-color: var(--lcars-arrow-btn-bg-focus);
            }

            .lcars-arrow-btn:disabled,
            .lcars-arrow-btn.disabled {
                cursor: default;
                pointer-events: none;
            }

            .lcars-arrow-btn:disabled svg,
            .lcars-arrow-btn.disabled svg {
                opacity: 0.3;
            }

            .lcars-arrow-btn svg {
                width: 40px;
                height: 12px;
                fill: var(--lcars-arrow-btn-arrow-color);
                transition:
                    fill var(--lcars-transition-normal),
                    opacity var(--lcars-transition-normal);
            }

            /* ==============================================
               SIDEBAR-SPECIFIC STYLES
               Compose primitives for sidebar scroll navigation
               ============================================== */

            /* Scrollable category container - composes lcars-scroll-container */
            .lcars-sidebar-bar-track .lcars-scroll-container {
                flex: 0 1 auto;
                min-height: 0;
                display: flex;
                flex-direction: column;
                gap: 5px;
                padding: 5px 0;
            }

            /* Sidebar filler - fills remaining space with theme color */
            .lcars-sidebar-bar-filler {
                flex: 1;
                min-height: var(--lcars-gap);
                background-color: var(--shape-color);
            }

            /* Sidebar scroll buttons - compose lcars-arrow-btn */
            .sidebar-scroll-up,
            .lcars-sidebar-bar-track .sidebar-scroll-up {
                width: 100%;
                margin-bottom: 2px;
            }

            .sidebar-scroll-down,
            .lcars-sidebar-bar-track .sidebar-scroll-down {
                width: 100%;
                margin-top: 2px;
            }

            /* Bottom Elbow Connector (right side, opening upward) */
            .lcars-sidebar-bar-bottom-cap {
                --elbow-position: top left;
                --elbow-radius-bottom-right: var(--lcars-radius-lg);
            }

            .lcars-footer-bar {
                grid-column: 1;
                grid-row: 3;
                display: flex;
                align-items: center;
                justify-content: flex-start;
                padding-left: 0;
                padding-right: 0;
                gap: 0;
                margin-right: -1px;
                height: 40px;
                align-self: end;
            }

            .lcars-footer-bar > .lcars-footer-bar-button,
            .lcars-footer-bar
                > .lcars-settings-wrapper
                > .lcars-footer-bar-button,
            .lcars-footer-bar > .lcars-expandable > .lcars-footer-bar-button {
                height: 100%;
                border-radius: 0;
                margin: 0;
                border-left: 5px solid var(--lcars-black);
            }

            .lcars-footer-bar .lcars-settings-wrapper,
            .lcars-footer-bar .lcars-expandable {
                height: 100%;
                display: flex;
            }

            /* ==============================================
               LCARS EXPANDABLE PRIMITIVE
               Unified dropdown/popup menu component.
               Replaces: .add-wrapper, .add-menu, .add-menu-item
               ============================================== */

            .lcars-expandable {
                /* Configurable properties */
                --lcars-expandable-gap: 5px;
                --lcars-expandable-offset: 5px;
                --lcars-expandable-item-width: 150px;
                --lcars-expandable-item-height: 40px;

                position: relative;
                display: inline-flex;
            }

            .lcars-expandable-menu {
                position: absolute;
                left: 0;
                min-width: var(--lcars-expandable-item-width);
                display: none;
                flex-direction: column;
                gap: var(--lcars-expandable-gap);
                z-index: var(--lcars-z-index-dropdown);
            }

            /* Direction: up (default) - menu appears above trigger */
            .lcars-expandable-menu,
            .lcars-expandable--up .lcars-expandable-menu {
                bottom: 100%;
                padding-bottom: var(--lcars-expandable-offset);
            }

            /* Direction: down - menu appears below trigger */
            .lcars-expandable--down .lcars-expandable-menu {
                bottom: auto;
                top: 100%;
                padding-bottom: 0;
                padding-top: var(--lcars-expandable-offset);
            }

            /* Show menu on hover or when explicitly opened via JS */
            .lcars-expandable:hover .lcars-expandable-menu,
            .lcars-expandable.is-open .lcars-expandable-menu {
                display: flex;
            }

            .lcars-expandable-item {
                position: relative;
                display: inline-flex;
                align-items: center;
                justify-content: flex-end;
                width: var(--lcars-expandable-item-width);
                min-height: var(--lcars-expandable-item-height);
                padding: 0 15px;
                font-size: 1rem;
                border-radius: 0;
                background-color: var(
                    --theme-secondary,
                    color-mix(
                        in srgb,
                        var(--shape-color) 30%,
                        var(--lcars-white) 70%
                    )
                );
                color: var(--lcars-black);
                border: none;
                border-left: 5px solid var(--lcars-black);
                font-family: var(--lcars-font);
                font-weight: bold;
                cursor: pointer;
                white-space: nowrap;
            }

            .lcars-expandable-item:hover {
                background-color: var(--lcars-white);
            }

            .lcars-expandable-item:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* Sidebar Buttons (LCARS category actions) */
            .lcars-sidebar-btn {
                /* Rely on lcars-button defaults for most behavior, but keep sidebar-specific layout */
                --lcars-button-bg: var(--cat-color, var(--shape-color));
                --lcars-button-fg: var(--lcars-black);
                --lcars-button-radius: 0px;

                display: inline-flex;
                align-items: center;
                justify-content: flex-end;
                height: 50px;
                min-height: 50px;
                flex-shrink: 0;
                width: 100%;

                font-family: var(--lcars-font);
                font-size: 1.1rem;
                font-weight: bold;
                text-transform: uppercase;

                padding-right: 15px;
                text-align: right;

                transition: background-color var(--lcars-transition-normal);
            }

            .lcars-sidebar-btn:hover,
            .lcars-sidebar-btn.active {
                background-color: var(--lcars-beige);
            }

            .lcars-sidebar-btn:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* Nested Categories */
            .lcars-sidebar-item {
                position: static; /* Allow submenu to escape scroll container */
                width: 100%;
                flex-shrink: 0;
            }

            .lcars-sidebar-submenu {
                display: none;
                position: fixed; /* Fixed position escapes overflow clipping */
                width: 160px; /* Match sidebar width */
                flex-direction: column;
                gap: 5px;
                padding-right: 10px; /* Space between levels */
                z-index: var(--lcars-z-index-dropdown);
                /* Position will be set via JS */
            }

            .lcars-sidebar-item:hover > .lcars-sidebar-submenu,
            .lcars-sidebar-item.submenu-open > .lcars-sidebar-submenu {
                display: flex;
            }

            /* Show submenu on keyboard focus of parent or child buttons */
            .lcars-sidebar-item:has(> .lcars-sidebar-btn:focus-visible)
                > .lcars-sidebar-submenu,
            .lcars-sidebar-item:has(
                    .lcars-sidebar-submenu .lcars-sidebar-btn:focus-visible
                )
                > .lcars-sidebar-submenu {
                display: flex;
            }

            .lcars-sidebar-submenu .lcars-sidebar-btn {
                border-radius: 0;
            }

            /* Main Content */
            .main-content {
                grid-column: 1;
                grid-row: 1 / 4;
                overflow-y: auto;
                padding: 20px;
                border: none;
                border-radius: var(--lcars-radius-lg);
                margin-right: -25px;
                margin-top: 42px;
                margin-bottom: 42px;
            }

            .bookmark-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
                list-style: none;
                padding-left: 0;
                margin: 0;
            }

            /* ==============================================
               LCARS BREADCRUMB PRIMITIVE
               Unified location/path readout component.
               Replaces: .lcars-breadcrumb, .settings-breadcrumb
               ============================================== */

            .lcars-breadcrumb {
                /* Configurable properties */
                --lcars-breadcrumb-margin: 10px;
                --lcars-breadcrumb-segment-bg: rgba(255, 153, 0, 0.18);
                --lcars-breadcrumb-segment-bg-hover: rgba(255, 153, 0, 0.3);
                --lcars-breadcrumb-segment-color: var(--lcars-orange);

                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: var(--lcars-breadcrumb-margin);
                font-size: 0.9rem;
                letter-spacing: 1px;
                color: var(--lcars-beige);
                opacity: 0.85;
            }

            .lcars-breadcrumb-label {
                color: var(--lcars-orange);
                text-transform: uppercase;
                font-weight: bold;
            }

            .lcars-breadcrumb-path {
                display: inline-flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 6px;
            }

            .lcars-breadcrumb-segment {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 2px 6px;
                border-radius: var(--lcars-radius-sm);
                background-color: var(--lcars-breadcrumb-segment-bg);
                color: var(--lcars-breadcrumb-segment-color);
                font-size: 0.85rem;
                font-family: var(--lcars-font);
                text-transform: uppercase;
                border: none;
                cursor: default;
                white-space: nowrap;
            }

            .lcars-breadcrumb-segment:not(.is-current) {
                cursor: pointer;
            }

            .lcars-breadcrumb-segment:not(.is-current):hover {
                background-color: var(--lcars-breadcrumb-segment-bg-hover);
            }

            .lcars-breadcrumb-segment.is-current {
                font-weight: bold;
            }

            .lcars-breadcrumb-separator {
                opacity: 0.6;
            }

            .lcars-breadcrumb-segment:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* --- Breadcrumb Variants --- */

            /* Settings variant: different margin and segment styling */
            .lcars-breadcrumb--settings {
                --lcars-breadcrumb-margin: 15px;
                --lcars-breadcrumb-segment-bg: rgba(255, 255, 255, 0.04);
                --lcars-breadcrumb-segment-bg-hover: rgba(255, 255, 255, 0.12);
                --lcars-breadcrumb-segment-color: inherit;
            }

            .lcars-breadcrumb--settings .lcars-breadcrumb-segment.is-current {
                color: var(--lcars-orange);
            }

            .lcars-breadcrumb--settings .lcars-breadcrumb-segment.is-root {
                --lcars-breadcrumb-segment-bg: rgba(255, 153, 0, 0.18);
                border-radius: var(--lcars-radius-sm);
            }

            /* Main view containers */
            .main-view {
                display: none;
            }

            .main-view.active {
                display: block;
            }

            /* Settings / About panels share LCARS framing */
            .settings-panel,
            .about-panel {
                color: var(--lcars-orange);
                max-width: 900px;
                margin: 0 auto;
                text-align: left;
                height: 100%;
            }

            .settings-panel {
                display: grid;
                grid-template-columns: 16px 1fr;
                column-gap: 20px;
                height: 100%;
            }

            .settings-accent {
                grid-row: 1 / span 3;
                background-color: var(--shape-color);
                border-radius: var(--lcars-radius-md);
            }

            /* Settings content: flex column for section layout */
            .settings-content {
                grid-column: 2;
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .settings-panel h1,
            .about-panel h1 {
                font-size: 2rem;
                margin-bottom: 15px;
                letter-spacing: 2px;
            }

            .settings-section {
                margin-top: 20px;
                padding-top: 10px;
                border-top: 2px solid var(--theme-main);
            }

            .settings-content .settings-section:first-of-type {
                /* Category Configuration section takes remaining height */
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
            }

            .js-settings-category-section-main {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
            }

            .js-settings-category-section-main .category-config-list {
                flex: 1 1 auto;
            }

            .settings-section h2 {
                font-size: 1.1rem;
                margin: 0 0 10px 0;
                letter-spacing: 1px;
            }

            .about-panel p {
                line-height: 1.5;
                margin: 5px 0;
            }

            .about-meta {
                font-size: 0.9rem;
                opacity: 0.8;
                margin-top: 20px;
            }

            .settings-status {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.8rem;
                opacity: 0.8;
                margin-bottom: 10px;
                letter-spacing: 1px;
            }

            /* Base LCARS button primitive */
            .lcars-button {
                /* Layout */
                display: inline-flex;
                align-items: center;
                justify-content: center;

                /* Box */
                min-height: 32px;
                padding: 0 15px;
                border: none;
                border-radius: var(--lcars-button-radius, 0px);
                background-color: var(--lcars-button-bg, var(--lcars-beige));
                color: var(--lcars-button-fg, var(--lcars-black));

                /* Text */
                font-family: var(--lcars-font);
                font-size: 1.1rem;
                font-weight: bold;
                text-transform: uppercase;
                white-space: normal;
                word-break: break-word;

                /* Behavior */
                cursor: pointer;
                position: relative;
            }

            /* Derived LCARS pill variant (rounded button) */
            .lcars-pill {
                --lcars-button-radius: var(--lcars-radius-md);
            }

            /* Hover behavior (can be disabled per-variant) */
            .lcars-button:hover {
                filter: var(--lcars-button-hover-filter, brightness(1.1));
            }

            /* LCARS color utility classes for buttons */
            .lcars-color-orange {
                --lcars-button-bg: var(--lcars-orange);
                --lcars-button-fg: var(--lcars-black);
            }

            .lcars-color-dark {
                --lcars-button-bg: var(--lcars-dark-3);
                --lcars-button-fg: var(--lcars-beige);
            }

            .lcars-color-danger {
                --lcars-button-bg: var(--lcars-red);
                --lcars-button-fg: var(--lcars-black);
            }

            .lcars-color-beige {
                --lcars-button-bg: var(--lcars-beige);
                --lcars-button-fg: var(--lcars-black);
            }

            /* ==============================================
               LCARS ACTION ROLE HELPERS
               Semantic class hooks for context-specific button styling.
               These base classes are intentionally empty - they serve as
               extension points for scoped overrides (e.g., .js-theme-controls-container .lcars-settings-action).
               Add styles here only if ALL buttons in that context need them.
               ============================================== */
            .lcars-dialog-action {
                /* Semantic hook for dialog action buttons (Cancel, Save, Delete) */
            }

            .lcars-settings-action {
                /* Semantic hook for settings panel action buttons */
            }

            /* ==============================================
               SETTINGS TILE
               Tile component for settings navigation
               ============================================== */
            .settings-tile-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .settings-tile-group {
                margin-bottom: 30px;
            }

            .settings-tile-group-label {
                font-size: 0.85rem;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--lcars-orange);
                margin-bottom: 12px;
                opacity: 0.9;
            }

            /* ==============================================
               LCARS TILE PRIMITIVE
               Unified tile component with configurable variants.
               Replaces: .bookmark-tile, .lcars-category-tile, .settings-tile
               ============================================== */

            .lcars-tile {
                /* Configurable properties with defaults */
                --lcars-tile-bg: var(--tile-color, var(--theme-main));
                --lcars-tile-fg: var(--lcars-black);
                --lcars-tile-stripe-bg: var(--lcars-tile-bg);

                display: grid;
                grid-template-columns: var(--lcars-tile-stripe-width) 1fr;
                grid-template-rows: auto 1fr;
                min-height: var(--lcars-tile-min-height);

                position: relative;
                border-radius: 0;
                border-bottom-right-radius: var(--lcars-radius-lg);
                overflow: hidden;
                cursor: pointer;
                text-decoration: none;

                background-color: var(--lcars-tile-bg);
                color: var(--lcars-tile-fg);

                transition:
                    transform var(--lcars-transition-fast),
                    filter var(--lcars-transition-fast);
            }

            /* Stripe column */
            .lcars-tile::before {
                content: "";
                grid-row: 1 / -1;
                grid-column: 1;
                background-color: var(--lcars-tile-stripe-bg);
            }

            /* Corner cutout */
            .lcars-tile::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: var(--lcars-radius-md);
                height: var(--lcars-radius-md);
                background: radial-gradient(
                    circle at 100% 100%,
                    transparent var(--lcars-radius-md),
                    var(--lcars-black) var(--lcars-radius-md)
                );
                z-index: 1;
            }

            .lcars-tile:hover {
                filter: brightness(1.1);
                transform: scale(1.02);
            }

            .lcars-tile:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* --- Tile Variants --- */

            /* Bookmark variant: larger with footer row */
            .lcars-tile--bookmark {
                --lcars-tile-stripe-width: var(--lcars-tile-stripe-width-lg);
                --lcars-tile-min-height: var(--lcars-tile-min-height-lg);
                grid-template-rows: auto 1fr auto;
                user-select: none;
                cursor: default;
            }

            /* Category variant: uses --tile-color from JS, includes footer */
            .lcars-tile--category {
                --lcars-tile-bg: var(--tile-color, var(--theme-main));
                grid-template-rows: auto 1fr auto;
                user-select: none;
                cursor: default;
            }

            /* Settings variant: button element styling */
            .lcars-tile--settings {
                border: none;
                text-align: left;
                font-family: var(--lcars-font);
            }

            /* Danger variant: red background */
            .lcars-tile--danger {
                --lcars-tile-bg: var(--lcars-red);
            }

            /* --- Tile Sub-components --- */

            /* Label: spans full width at top */
            .lcars-tile-label {
                grid-column: 1 / -1;
                grid-row: 1;
                padding: 8px 12px 6px 24px;
                font-size: 0.95rem;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--lcars-tile-fg);
            }

            /* Bookmark label: slightly larger */
            .lcars-tile-label--bookmark {
                font-size: 1rem;
                line-height: 1.2;
                padding: 10px 15px 8px 25px;
                background-color: var(--lcars-tile-bg);
            }

            /* Meta area: black background with rounded corner */
            .lcars-tile-meta {
                grid-column: 2;
                grid-row: 2;
                padding: 8px 12px 10px 8px;
                font-size: 0.75rem;
                line-height: 1.3;
                background-color: var(--lcars-black);
                color: var(--theme-secondary, var(--lcars-gray));
                border-top-left-radius: var(--lcars-radius-sm);

                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                gap: 4px;
            }

            /* Bookmark meta: description styling with line clamping */
            .lcars-tile-meta--bookmark {
                font-size: 0.78rem;
                line-height: 1.35;
                padding: 10px 15px 10px 10px;
                overflow: hidden;
                word-wrap: break-word;
                word-break: break-word;
                display: -webkit-box;
                -webkit-line-clamp: 4;
                -webkit-box-orient: vertical;
            }

            .lcars-tile-meta-primary {
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .lcars-tile-meta-secondary {
                opacity: 0.85;
            }

            /* Footer: for bookmark action buttons */
            .lcars-tile-footer {
                grid-column: 2;
                grid-row: 3;
                background-color: var(--lcars-black);
                margin-left: 0;
                z-index: 2;
                padding: 8px 12px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 10px;
            }

            /* Pin positioning within tiles (only for pins outside footer) */
            .lcars-tile > .lcars-pin {
                position: absolute;
                bottom: 8px;
                right: 12px;
                z-index: 10;
            }

            /* Settings sub-page container */
            .settings-subpage {
                display: none;
            }

            .settings-subpage.active {
                display: block;
            }

            .settings-main-grid {
                display: none;
            }

            .settings-main-grid.active {
                display: block;
            }

            /* Settings subpage content styling */
            .settings-subpage-content {
                margin-top: 10px;
            }

            .settings-subpage h2 {
                font-size: 1.5rem;
                margin: 0 0 15px 0;
                letter-spacing: 1px;
                color: var(--lcars-orange);
            }

            .settings-subpage .lcars-form-group {
                margin-bottom: 15px;
            }

            /* Theme selector layout */
            .js-theme-controls-container {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .js-theme-controls-container .lcars-settings-action {
                min-width: 140px;
                justify-content: center;
            }

            .js-theme-controls-container .lcars-settings-action.theme-active {
                background-color: var(--theme-main, var(--lcars-beige));
                color: var(--lcars-black);
                box-shadow: 0 0 0 2px var(--lcars-white);
            }

            /* Footer Actions: LCARS buttons with footer-specific layout */
            .lcars-footer-bar-button {
                /* Rely on lcars-button for core shape/typography */
                display: inline-flex;
                align-items: center;
                justify-content: flex-end;
                min-height: 40px;
                padding: 0 15px;
                width: 150px;
                white-space: nowrap;

                /* Footer-specific colors */
                --lcars-button-bg: var(
                    --theme-secondary,
                    color-mix(
                        in srgb,
                        var(--shape-color) 30%,
                        var(--lcars-white) 70%
                    )
                );
                --lcars-button-fg: var(--lcars-black);
                background-color: var(--lcars-button-bg);
                color: var(--lcars-button-fg);
            }

            .lcars-footer-bar-button:hover {
                background-color: var(--lcars-white);
            }

            .lcars-action-btn--small {
                height: 32px;
                font-size: 0.9rem;
                padding: 0 10px;
                width: 100%;
                justify-content: center;
            }

            .lcars-footer-bar-button:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            .js-about-btn {
                border-right: 5px solid var(--lcars-black);
            }

            /* Borg green footer buttons when SEVEN OF NINE theme is active */
            body[data-theme="seven"] .lcars-action-btn {
                background-color: var(--theme-secondary);
            }

            /* Settings Menu */
            .lcars-settings-wrapper {
                display: flex;
                align-items: center;
                height: 40px;
            }

            /* ==============================================
               DIALOGS
               Dialogs use native <dialog> which renders at document root.
               We use .lcars-dialog class for scoping rather than element selector.
               ============================================== */
            .lcars-dialog-container {
                background-color: var(--lcars-black);
                color: var(--lcars-orange);
                font-family: var(--lcars-font);
                border: 2px solid var(--shape-color);
                border-radius: var(--lcars-radius-md);
                padding: 0;
                max-width: 540px;
                width: 90%;
            }

            .lcars-dialog-container::backdrop {
                background-color: rgba(0, 0, 0, 0.8);
            }

            .lcars-dialog {
                display: flex;
                flex-direction: column;
                border-radius: var(--lcars-radius-md);
                overflow: hidden;
            }

            /* Color picker specific overlay */
            /* Color picker uses slightly larger radius for visual distinction */
            .js-color-picker-dialog {
                max-width: 520px;
                border-radius: calc(var(--lcars-radius-md) + 6px);
                border-color: var(--shape-color);
            }

            .js-color-picker-dialog .lcars-dialog-header {
                background-color: var(--shape-color);
                color: var(--lcars-black);
            }

            .js-color-picker-dialog .lcars-dialog-body {
                padding: 20px;
                background-color: var(--lcars-black);
            }

            .js-color-picker-dialog .lcars-dialog-footer {
                display: flex;
                justify-content: flex-end;
                padding: 10px 20px 18px 20px;
                background-color: var(--lcars-black);
            }

            .lcars-dialog-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: var(--shape-color);
                color: var(--lcars-black);
                padding: 10px 16px;
            }

            .lcars-dialog-title {
                font-size: 1.2rem;
                font-weight: bold;
                letter-spacing: 1px;
            }

            .lcars-dialog-meta {
                font-size: 0.75rem;
                opacity: 0.8;
                cursor: help;
            }

            .lcars-dialog-body {
                padding: 16px 16px 8px 16px;
                background-color: var(--lcars-black);
            }

            .lcars-dialog-footer {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding: 8px 16px 16px 16px;
                background-color: var(--lcars-black);
            }

            .lcars-form-group {
                margin-bottom: 15px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(153, 153, 204, 0.3);
            }

            .lcars-form-group:last-of-type {
                border-bottom: none;
                padding-bottom: 0;
            }

            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }

            /* ==============================================
               LCARS FORM PRIMITIVES
               Namespaced form controls for design system extraction.
               Apply these classes explicitly to form elements.
               ============================================== */
            .lcars-input,
            .lcars-select,
            .lcars-textarea {
                width: 100%;
                padding: 10px;
                background-color: var(--lcars-dark-2);
                border: 1px solid var(--theme-main);
                color: var(--lcars-beige);
                border-radius: var(--lcars-radius-xs);
                border-width: 3px;
                font-family: var(--lcars-font);
            }

            .lcars-textarea {
                resize: vertical;
                min-height: 60px;
                max-height: 150px;
            }

            /* URL protocol select styled as compact LCARS control */
            .js-url-protocol {
                max-width: 140px;
                border-radius: var(--lcars-radius-md);
                text-transform: uppercase;
                font-weight: bold;
                letter-spacing: 1px;
                padding: 8px 12px;
            }

            .dialog-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
            }

            .category-config-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 6px;
                overflow-y: auto;
                border: 1px solid var(--lcars-blue);
                padding: 10px 10px 6px 10px;
                border-radius: 0px;
                border-style: none;
                background-color: var(--lcars-black);
            }

            .category-config-row {
                display: grid;
                grid-template-columns: 70px 1fr auto;
                gap: 8px;
                align-items: center;
                padding: 6px 8px;
                border-radius: var(--lcars-radius-md);
                background-color: var(--lcars-dark-1);
            }

            .category-config-row-controls {
                display: inline-grid;
                grid-auto-flow: column;
                grid-auto-columns: 40px;
                gap: 8px;
            }

            .category-color-swatch {
                width: 100%;
                height: 40px;
                border: none;
                border-radius: var(--lcars-radius-md) 0 0 var(--lcars-radius-md);
                cursor: pointer;
                box-shadow: inset 0 0 0 2px var(--lcars-black);
            }

            .color-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
                margin-top: 6px;
            }

            .color-option {
                width: 100%;
                aspect-ratio: 1.3;
                border: none;
                border-radius: var(--lcars-radius-sm);
                cursor: pointer;
                box-shadow: inset 0 0 0 2px var(--lcars-black);
            }

            .color-option:hover {
                filter: brightness(1.15);
                outline: 2px solid var(--lcars-white);
                outline-offset: 2px;
            }

            /* ==============================================
               LCARS PIN PRIMITIVE
               Unified circular action control with size/color variants.
               Replaces: .lcars-tile-pin, .category-config-btn
               ============================================== */

            .lcars-pin {
                --lcars-pin-size: 20px;
                --lcars-pin-bg: var(--theme-secondary, var(--lcars-blue));
                --lcars-pin-fg: var(--lcars-black);

                width: var(--lcars-pin-size);
                height: var(--lcars-pin-size);
                border-radius: 50%;
                border: none;
                padding: 0;

                display: inline-flex;
                align-items: center;
                justify-content: center;

                background-color: var(--lcars-pin-bg);
                color: var(--lcars-pin-fg);
                font-family: var(--lcars-font);
                font-weight: bold;
                font-size: 1rem;
                line-height: 1;

                cursor: pointer;
                position: relative;
                transition:
                    transform var(--lcars-transition-normal),
                    filter var(--lcars-transition-normal);
            }

            .lcars-pin:hover {
                filter: brightness(1.1);
                transform: scale(1.1);
            }

            .lcars-pin:focus-visible {
                outline: var(--lcars-focus-outline-width) solid
                    var(--lcars-focus-outline-color);
                outline-offset: var(--lcars-focus-outline-offset);
            }

            /* --- Pin Size Modifiers --- */

            /* Small: 18px (for tile actions) */
            .lcars-pin--sm {
                --lcars-pin-size: 18px;
                font-size: 0.85rem;
            }

            /* Large: 40px (for config controls) */
            .lcars-pin--lg {
                --lcars-pin-size: 40px;
                font-size: 1.25rem;
                line-height: 1.1;
                letter-spacing: 0.03em;
            }

            /* --- Pin Color Variants --- */

            .lcars-pin--edit {
                --lcars-pin-bg: var(--lcars-orange);
            }

            .lcars-pin--url {
                --lcars-pin-bg: var(--theme-main);
            }

            .lcars-pin--open {
                --lcars-pin-bg: var(--lcars-blue);
            }

            .lcars-pin--delete {
                --lcars-pin-bg: var(--lcars-red);
            }

            /* --- Pin Style Modifiers --- */

            /* Bordered: adds inset border (for config buttons) */
            .lcars-pin--bordered {
                box-shadow: inset 0 0 0 2px var(--lcars-black);
            }

            /* --- Pin SVG Icon Support --- */

            .lcars-pin svg {
                width: 70%;
                height: 70%;
                display: block;
                margin: auto;
                fill: currentColor;
            }

            .lcars-pin[data-glyph="up"] svg {
                width: 87%;
                height: 87%;
                transform: translateY(-2px);
            }

            .lcars-pin[data-glyph="down"] svg {
                width: 87%;
                height: 87%;
                transform: translateY(2px);
            }

            .lcars-pin[data-glyph="plus"] svg {
                width: 90%;
                height: 90%;
            }

            .lcars-pin[data-glyph="delete"] svg {
                width: 80%;
                height: 80%;
                stroke: currentColor;
                stroke-width: 2.5;
                stroke-linecap: round;
                fill: none;
            }
        </style>
    </head>
    <body>
        <!-- ==============================================
             SVG ICON SPRITE
             Reusable icon definitions for the LCARS design system.
             Reference icons with: <svg><use href="#icon-name"></use></svg>
             ============================================== -->
        <svg xmlns="http://www.w3.org/2000/svg" style="display: none">
            <defs>
                <!-- Arrow Up (wide) - for scroll buttons -->
                <symbol id="icon-arrow-up-wide" viewBox="0 0 40 12">
                    <polygon points="20,0 40,12 0,12" />
                </symbol>
                <!-- Arrow Down (wide) - for scroll buttons -->
                <symbol id="icon-arrow-down-wide" viewBox="0 0 40 12">
                    <polygon points="0,0 40,0 20,12" />
                </symbol>
                <!-- Arrow Up (square) - for config buttons -->
                <symbol id="icon-arrow-up" viewBox="0 0 24 24">
                    <polygon points="12,6 6,18 18,18" />
                </symbol>
                <!-- Arrow Down (square) - for config buttons -->
                <symbol id="icon-arrow-down" viewBox="0 0 24 24">
                    <polygon points="6,6 18,6 12,18" />
                </symbol>
                <!-- X/Delete icon -->
                <symbol id="icon-delete" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </symbol>
            </defs>
        </svg>

        <div class="lcars-app lcars-app--fullpage js-lcars-app">
            <!-- Header Bar (Left) -->
            <div class="lcars-header-bar">
                <button
                    class="lcars-header-bar-home js-home-btn"
                    aria-label="Home - Bookmarks View"
                >
                    ZANDER
                </button>
                <div class="lcars-header-bar-fill"></div>
                <div class="lcars-header-bar-end-cap"></div>
            </div>

            <!-- Sidebar (Right - Full Height) -->
            <aside class="lcars-sidebar-bar">
                <!-- Top Elbow -->
                <div class="lcars-elbow lcars-sidebar-bar-top-cap"></div>

                <!-- Middle Track with Scroll Buttons -->
                <div class="lcars-sidebar-bar-track">
                    <div
                        class="lcars-arrow-btn sidebar-scroll-up js-sidebar-scroll-up"
                        aria-hidden="true"
                    >
                        <svg><use href="#icon-arrow-up-wide"></use></svg>
                    </div>
                    <div
                        class="lcars-scroll-container js-category-sidebar"
                        tabindex="-1"
                    >
                        <!-- Categories injected here -->
                    </div>
                    <div
                        class="lcars-arrow-btn sidebar-scroll-down js-sidebar-scroll-down"
                        aria-hidden="true"
                    >
                        <svg><use href="#icon-arrow-down-wide"></use></svg>
                    </div>
                    <div class="lcars-sidebar-bar-filler"></div>
                </div>

                <!-- Bottom Elbow -->
                <div class="lcars-elbow lcars-sidebar-bar-bottom-cap"></div>
            </aside>

            <main class="main-content">
                <div class="main-view active js-bookmarks-view">
                    <div
                        class="lcars-breadcrumb js-bookmark-location"
                        aria-live="polite"
                        aria-label="Current Category Location"
                    >
                        <span class="lcars-breadcrumb-label">LOCATION</span>
                        <nav
                            class="lcars-breadcrumb-path"
                            aria-label="Current location"
                        >
                            <!-- Segments injected via JS -->
                        </nav>
                    </div>
                    <ul class="bookmark-grid js-bookmark-grid">
                        <!-- Bookmarks injected here -->
                    </ul>
                    <div
                        class="empty-state js-empty-state"
                        style="display: none; text-align: center; padding: 50px"
                        role="status"
                        aria-live="assertive"
                    >
                        NO ENTRIES FOUND
                    </div>
                </div>
                <div
                    class="main-view js-settings-view"
                    style="padding: 20px; height: 100%"
                    role="region"
                    aria-label="Settings Panel"
                >
                    <div class="settings-panel">
                        <div class="settings-accent"></div>
                        <div class="settings-content">
                            <div class="settings-status">
                                <span>CONFIGURATION MODE</span>
                                <span class="js-settings-stardate"
                                    >STARDATE 0000000.0000</span
                                >
                            </div>

                            <h1>SETTINGS</h1>

                            <!-- Settings Breadcrumb -->
                            <nav
                                class="lcars-breadcrumb lcars-breadcrumb--settings js-settings-breadcrumb"
                                aria-label="Settings Navigation"
                            >
                                <span class="lcars-breadcrumb-label"
                                    >LOCATION:</span
                                >
                                <div
                                    class="lcars-breadcrumb-path js-settings-breadcrumb-path"
                                >
                                    <!-- Injected via JS -->
                                </div>
                            </nav>

                            <!-- Main Settings Grid (tile view) -->
                            <div
                                class="settings-main-grid active js-settings-main-grid"
                            >
                                <!-- Configuration Group -->
                                <div class="settings-tile-group">
                                    <div class="settings-tile-group-label">
                                        CONFIGURATION
                                    </div>
                                    <div class="settings-tile-grid">
                                        <button
                                            class="lcars-tile lcars-tile--settings"
                                            data-settings-page="categories"
                                            style="
                                                --tile-color: var(
                                                    --lcars-orange
                                                );
                                            "
                                        >
                                            <span class="lcars-tile-label"
                                                >Categories</span
                                            >
                                            <div class="lcars-tile-meta">
                                                <span
                                                    class="lcars-tile-meta-secondary"
                                                    >MANAGE CATEGORY
                                                    HIERARCHY</span
                                                >
                                            </div>
                                        </button>
                                        <button
                                            class="lcars-tile lcars-tile--settings"
                                            data-settings-page="home"
                                            style="
                                                --tile-color: var(
                                                    --lcars-beige
                                                );
                                            "
                                        >
                                            <span class="lcars-tile-label"
                                                >Home Category</span
                                            >
                                            <div class="lcars-tile-meta">
                                                <span
                                                    class="lcars-tile-meta-primary js-settings-home-category-name"
                                                    >CURRENT HOME CATEGORY</span
                                                >
                                                <span
                                                    class="lcars-tile-meta-secondary"
                                                    >SET LANDING
                                                    DESTINATION</span
                                                >
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                <!-- Appearance Group -->
                                <div class="settings-tile-group">
                                    <div class="settings-tile-group-label">
                                        APPEARANCE
                                    </div>
                                    <div class="settings-tile-grid">
                                        <button
                                            class="lcars-tile lcars-tile--settings"
                                            data-settings-page="themes"
                                            style="
                                                --tile-color: var(--theme-main);
                                            "
                                        >
                                            <span class="lcars-tile-label"
                                                >Themes</span
                                            >
                                            <div class="lcars-tile-meta">
                                                <span
                                                    class="lcars-tile-meta-primary js-settings-active-theme"
                                                    >LA'AN</span
                                                >
                                                <span
                                                    class="lcars-tile-meta-secondary"
                                                    >CHANGE THE COLOR
                                                    THEME</span
                                                >
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                <!-- Data Group -->
                                <div class="settings-tile-group">
                                    <div class="settings-tile-group-label">
                                        DATA MANAGEMENT
                                    </div>
                                    <div class="settings-tile-grid">
                                        <button
                                            class="lcars-tile lcars-tile--settings"
                                            data-settings-page="data"
                                            style="
                                                --tile-color: var(--lcars-blue);
                                            "
                                        >
                                            <span class="lcars-tile-label"
                                                >Import / Export</span
                                            >
                                            <div class="lcars-tile-meta">
                                                <span
                                                    class="lcars-tile-meta-secondary"
                                                    >BACKUP & RESTORE DATA</span
                                                >
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                <!-- System Group -->
                                <div class="settings-tile-group">
                                    <div class="settings-tile-group-label">
                                        SYSTEM
                                    </div>
                                    <div class="settings-tile-grid">
                                        <button
                                            class="lcars-tile lcars-tile--settings lcars-tile--danger"
                                            data-settings-page="reset"
                                        >
                                            <span class="lcars-tile-label"
                                                >System Reset</span
                                            >
                                            <div class="lcars-tile-meta">
                                                <span
                                                    class="lcars-tile-meta-primary"
                                                    >DANGER ZONE</span
                                                >
                                                <span
                                                    class="lcars-tile-meta-secondary"
                                                    >RESTORE DEFAULT STATE</span
                                                >
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Categories Sub-page -->
                            <div
                                class="settings-subpage js-settings-page-categories"
                            >
                                <div class="settings-subpage-content">
                                    <h2>CATEGORY CONFIGURATION</h2>
                                    <div
                                        class="js-settings-category-section-main"
                                    >
                                        <div
                                            class="category-config-list js-category-config-list"
                                        >
                                            <!-- Rows injected via JS -->
                                        </div>
                                        <button
                                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-settings-action lcars-action-btn lcars-action-btn--small js-add-category-btn-main"
                                            style="
                                                width: calc(100% - 20px);
                                                margin: 0 10px 20px 10px;
                                            "
                                        >
                                            ADD ROOT CATEGORY
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Home Category Sub-page -->
                            <div class="settings-subpage js-settings-page-home">
                                <div class="settings-subpage-content">
                                    <h2>HOME CATEGORY</h2>
                                    <div class="lcars-form-group">
                                        <label for="landingCategorySelect"
                                            >LANDING CATEGORY</label
                                        >
                                        <select
                                            id="landingCategorySelect"
                                            class="lcars-select js-landing-category-select"
                                            aria-label="Landing Category"
                                        ></select>
                                        <p
                                            style="
                                                font-size: 0.8rem;
                                                opacity: 0.8;
                                                margin-top: 6px;
                                            "
                                        >
                                            SELECT WHICH CATEGORY THE SYSTEM
                                            SHOULD LAND ON WHEN YOU PRESS HOME
                                            OR ACTIVATE THE ZANDER HEADER.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Themes Sub-page -->
                            <div
                                class="settings-subpage js-settings-page-themes"
                            >
                                <div class="settings-subpage-content">
                                    <h2>THEME SELECTION</h2>
                                    <div class="lcars-form-group">
                                        <div
                                            class="js-theme-controls-container"
                                            style="margin-bottom: 10px"
                                        ></div>
                                        <div
                                            class="js-theme-status-readout"
                                            style="
                                                font-size: 0.85rem;
                                                opacity: 0.8;
                                                letter-spacing: 1px;
                                            "
                                        >
                                            ACTIVE THEME: LA'AN
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Management Sub-page -->
                            <div class="settings-subpage js-settings-page-data">
                                <div class="settings-subpage-content">
                                    <h2>IMPORT / EXPORT</h2>
                                    <div class="lcars-form-group">
                                        <button
                                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-settings-action lcars-action-btn lcars-action-btn--small js-export-btn-main"
                                            style="
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            EXPORT DATABASE
                                        </button>
                                        <button
                                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-settings-action lcars-action-btn lcars-action-btn--small js-import-btn-main"
                                            style="
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            IMPORT DATABASE
                                        </button>
                                        <input
                                            type="file"
                                            class="js-import-input"
                                            accept=".json"
                                            style="display: none"
                                            aria-label="Import Bookmarks from JSON File"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- System Reset Sub-page -->
                            <div
                                class="settings-subpage js-settings-page-reset"
                            >
                                <div class="settings-subpage-content">
                                    <h2>SYSTEM RESET</h2>
                                    <p
                                        style="
                                            font-size: 0.9rem;
                                            opacity: 0.9;
                                            margin-bottom: 15px;
                                            line-height: 1.5;
                                        "
                                    >
                                        WARNING: THIS ACTION WILL PERMANENTLY
                                        DELETE ALL YOUR BOOKMARKS AND CATEGORIES
                                        AND RESTORE THE SYSTEM TO ITS DEFAULT
                                        STATE. THIS CANNOT BE UNDONE.
                                    </p>
                                    <div class="lcars-form-group">
                                        <button
                                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-danger lcars-settings-action reset js-reset-btn-main"
                                            style="width: 100%"
                                        >
                                            INITIATE SYSTEM RESET
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="main-view js-about-view"
                    style="padding: 20px"
                    role="region"
                    aria-label="About Zander"
                >
                    <div class="about-panel">
                        <h1>ABOUT ZANDER</h1>
                        <hr />
                        <p>
                            <strong>ZANDER BOOKMARK TECHNOLOGIES</strong><br />
                            UNITED FEDERATION OF PLANETS<br />
                        </p>
                        <hr />
                        <h2>SYSTEM INFO</h2>
                        <p>A SINGLE-FILE, OFFLINE-CAPABLE PERSONAL ARCHIVE.</p>
                        <p class="about-meta">VERSION: v1.0.0</p>
                        <hr />
                        <div
                            class="about-meta"
                            aria-labelledby="about-shortcuts-heading"
                        >
                            <h2 id="about-shortcuts-heading">
                                KEYBOARD SHORTCUTS
                            </h2>
                            <ul>
                                <li>ALT+H  HOME (BOOKMARKS VIEW)</li>
                                <li>ALT+B  NEW BOOKMARK</li>
                                <li>ALT+S  SETTINGS VIEW</li>
                                <li>ALT+C  NEW CATEGORY</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </main>

            <div
                class="lcars-footer-bar lcars-frame-segment lcars-frame-segment--horizontal lcars-frame-segment--left-rounded"
            >
                <div class="lcars-status-display js-system-status"></div>
                <div class="lcars-expandable">
                    <button
                        class="lcars-button lcars-color-orange lcars-footer-bar-button js-add-btn"
                        aria-label="Add Entry (Alt+N)"
                        aria-haspopup="true"
                        aria-expanded="false"
                    >
                        ADD ENTRY
                    </button>
                    <div
                        class="lcars-expandable-menu js-add-menu"
                        role="group"
                        aria-label="Add entry type"
                    >
                        <button
                            class="lcars-expandable-item js-add-bookmark-btn"
                        >
                            BOOKMARK
                        </button>
                        <button
                            class="lcars-expandable-item js-add-category-btn"
                        >
                            CATEGORY
                        </button>
                    </div>
                </div>
                <div class="lcars-settings-wrapper">
                    <button
                        class="lcars-button lcars-color-orange lcars-footer-bar-button js-settings-btn"
                        aria-label="Settings (Alt+S)"
                    >
                        SETTINGS
                    </button>
                </div>
                <button
                    class="lcars-button lcars-color-orange lcars-footer-bar-button js-about-btn"
                    aria-label="About Zander"
                >
                    ABOUT
                </button>
            </div>
        </div>

        <!-- Bookmark Dialog -->
        <dialog
            id="bookmarkDialog"
            class="lcars-dialog-container js-bookmark-dialog"
            aria-labelledby="dialogTitle"
        >
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <h2
                        class="lcars-dialog-title js-dialog-title"
                        id="dialogTitle"
                    >
                        NEW ENTRY
                    </h2>
                    <span
                        class="lcars-dialog-meta js-bookmark-stardate"
                        id="bookmarkStardate"
                    >
                        STARDATE 0000000.0000
                    </span>
                </div>
                <form class="js-bookmark-form">
                    <div class="lcars-dialog-body">
                        <input type="hidden" class="js-bookmark-id" />
                        <div class="lcars-form-group">
                            <label for="titleInput">TITLE</label>
                            <input
                                type="text"
                                id="titleInput"
                                class="lcars-input js-title-input"
                                required
                                aria-required="true"
                                maxlength="64"
                            />
                        </div>
                        <div class="lcars-form-group">
                            <label for="descriptionInput">DESCRIPTION</label>
                            <textarea
                                id="descriptionInput"
                                class="lcars-textarea js-description-input"
                                rows="3"
                                maxlength="512"
                                placeholder="Optional description..."
                                aria-label="Bookmark Description"
                            ></textarea>
                        </div>
                        <div class="lcars-form-group">
                            <label for="urlInput">URL</label>
                            <div style="display: flex; gap: 10px">
                                <label for="urlProtocol" style="display: none"
                                    >Protocol</label
                                >
                                <select
                                    id="urlProtocol"
                                    class="lcars-select js-url-protocol"
                                    style="width: 120px"
                                    aria-label="URL Protocol"
                                >
                                    <option value="https://">HTTPS://</option>
                                    <option value="http://">HTTP://</option>
                                </select>
                                <input
                                    type="text"
                                    id="urlInput"
                                    class="lcars-input js-url-input"
                                    required
                                    placeholder="example.com"
                                    style="flex: 1"
                                    aria-required="true"
                                />
                            </div>
                        </div>
                        <div class="lcars-form-group">
                            <label for="categoryInput">CATEGORY</label>
                            <select
                                id="categoryInput"
                                class="lcars-select js-category-input"
                                aria-label="Bookmark Category"
                            >
                                <!-- Options injected -->
                            </select>
                        </div>
                    </div>
                    <div class="lcars-dialog-footer">
                        <button
                            type="button"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-danger lcars-dialog-action delete js-delete-btn"
                            style="display: none"
                            aria-label="Delete Bookmark"
                        >
                            DELETE
                        </button>
                        <button
                            type="button"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-dark lcars-dialog-action js-bookmark-cancel-btn"
                            aria-label="Cancel"
                        >
                            CANCEL
                        </button>
                        <button
                            type="submit"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-dialog-action"
                            aria-label="Save Bookmark"
                        >
                            MAKE IT SO
                        </button>
                    </div>
                </form>
            </div>
        </dialog>

        <dialog
            id="categoryDialog"
            class="lcars-dialog-container js-category-dialog"
            aria-labelledby="categoryDialogTitle"
        >
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <h2
                        class="lcars-dialog-title js-category-dialog-title"
                        id="categoryDialogTitle"
                    >
                        NEW CATEGORY
                    </h2>
                    <span
                        class="lcars-dialog-meta js-category-stardate"
                        id="categoryStardate"
                    >
                        STARDATE 0000000.0000
                    </span>
                </div>
                <form class="js-category-form">
                    <div class="lcars-dialog-body">
                        <input type="hidden" class="js-category-id" />
                        <div class="lcars-form-group">
                            <label for="categoryNameInput">NAME</label>
                            <input
                                type="text"
                                id="categoryNameInput"
                                class="lcars-input js-category-name-input"
                                required
                                aria-required="true"
                                maxlength="32"
                                style="text-transform: uppercase"
                            />
                        </div>
                        <div class="lcars-form-group">
                            <label for="categoryParentInput"
                                >PARENT CATEGORY</label
                            >
                            <select
                                id="categoryParentInput"
                                class="lcars-select js-category-parent-input"
                                aria-label="Parent Category"
                            >
                                <option value="">(ROOT)</option>
                                <!-- Options injected -->
                            </select>
                        </div>
                        <div
                            class="lcars-form-group js-category-color-form-group"
                            id="categoryColorFormGroup"
                        >
                            <label>COLOR</label>
                            <div
                                class="color-grid js-category-color-grid"
                                id="categoryColorGrid"
                                style="
                                    display: grid;
                                    grid-template-columns: repeat(5, 1fr);
                                    gap: 5px;
                                "
                            >
                                <!-- Colors injected via JS -->
                            </div>
                            <input
                                type="hidden"
                                class="js-category-color-input"
                            />
                        </div>
                    </div>
                    <div class="lcars-dialog-footer">
                        <button
                            type="button"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-danger lcars-dialog-action delete js-category-delete-btn"
                            style="display: none"
                            aria-label="Delete Category"
                        >
                            DELETE
                        </button>
                        <button
                            type="button"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-dark lcars-dialog-action js-category-cancel-btn"
                            aria-label="Cancel"
                        >
                            CANCEL
                        </button>
                        <button
                            type="submit"
                            class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-dialog-action"
                            aria-label="Save Category"
                        >
                            MAKE IT SO
                        </button>
                    </div>
                </form>
            </div>
        </dialog>

        <!-- Settings Dialog (no longer used for full settings UI, kept for potential small overlays if needed) -->

        <dialog
            id="confirmDialog"
            class="lcars-dialog-container js-confirm-dialog"
            aria-labelledby="confirmTitle"
        >
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <h2
                        class="lcars-dialog-title js-confirm-title"
                        id="confirmTitle"
                    >
                        CONFIRM
                    </h2>
                </div>
                <div class="lcars-dialog-body">
                    <div
                        class="js-confirm-message"
                        style="margin: 10px 0 0 0; font-size: 1.2rem"
                        role="alert"
                    >
                        ARE YOU SURE?
                    </div>
                </div>
                <div class="lcars-dialog-footer">
                    <button
                        class="lcars-button lcars-pill lcars-focus-outline lcars-color-dark lcars-dialog-action js-confirm-cancel-btn"
                        aria-label="Cancel"
                    >
                        CANCEL
                    </button>
                    <button
                        class="lcars-button lcars-pill lcars-focus-outline lcars-color-orange lcars-dialog-action js-confirm-ok-btn"
                        aria-label="Proceed"
                    >
                        PROCEED
                    </button>
                </div>
            </div>
        </dialog>

        <dialog
            id="colorPickerDialog"
            class="lcars-dialog-container js-color-picker-dialog"
            aria-labelledby="colorPickerDialogTitle"
        >
            <div class="lcars-dialog">
                <div class="lcars-dialog-header">
                    <h2 class="lcars-dialog-title" id="colorPickerDialogTitle">
                        SELECT COLOR
                    </h2>
                </div>
                <div class="lcars-dialog-body">
                    <div
                        class="color-grid js-color-grid"
                        role="group"
                        aria-label="Color Palette"
                    ></div>
                </div>
            </div>
        </dialog>

        <script>
            const STORAGE_KEY = "zander-lcars:v1";
            const THEME_STORAGE_KEY = "zander-lcars-theme:v1";

            const THEMES = [
                { id: "laan", label: "LA'AN" },
                { id: "data", label: "DATA" },
                { id: "doctor", label: "THE DOCTOR" },
                { id: "chapel", label: "CHAPEL" },
                { id: "spock", label: "SPOCK" },
                { id: "mbenga", label: "M'BENGA" },
                { id: "seven", label: "SEVEN OF NINE" },
                { id: "shran", label: "SHRAN" },
            ];

            // Default Data
            const DEFAULT_CATEGORIES = [
                {
                    id: "cat-root-startrek",
                    name: "STAR TREK",
                    color: "var(--theme-main)",
                    createdAt: "2025352.1200",
                    children: [
                        {
                            id: "cat-tng",
                            name: "The Next Generation",
                            color: "var(--theme-secondary)",
                            createdAt: "2025352.1201",
                            children: [
                                {
                                    id: "cat-tng-s1",
                                    name: "Season 1",
                                    color: "var(--theme-secondary)",
                                    createdAt: "2025352.1202",
                                    children: [],
                                },
                                {
                                    id: "cat-tng-s2",
                                    name: "Season 2",
                                    color: "var(--theme-secondary)",
                                    createdAt: "2025352.1203",
                                    children: [],
                                },
                            ],
                        },
                        {
                            id: "cat-ds9",
                            name: "Deep Space Nine",
                            color: "var(--theme-secondary)",
                            createdAt: "2025352.1204",
                            children: [
                                {
                                    id: "cat-ds9-s1",
                                    name: "Season 1",
                                    color: "var(--theme-secondary)",
                                    createdAt: "2025352.1205",
                                    children: [],
                                },
                                {
                                    id: "cat-ds9-s2",
                                    name: "Season 2",
                                    color: "var(--theme-secondary)",
                                    createdAt: "2025352.1206",
                                    children: [],
                                },
                            ],
                        },
                    ],
                },
            ];

            const DEFAULT_BOOKMARKS = [
                // TNG Season 1
                {
                    id: "bm-tng-s1-captain",
                    title: "TNG S1  Captain Picard",
                    description:
                        "Captain of the USS Enterprise-D. A skilled diplomat and archaeologist who commands with wisdom and principle.",
                    url: "https://memory-alpha.fandom.com/wiki/Jean-Luc_Picard",
                    categoryId: "cat-tng-s1",
                    createdAt: "2025352.1300",
                },
                {
                    id: "bm-tng-s1-ship",
                    title: "TNG S1  USS Enterprise-D",
                    description:
                        "Galaxy-class starship, registry NCC-1701-D. Flagship of the Federation.",
                    url: "https://memory-alpha.fandom.com/wiki/USS_Enterprise_(NCC-1701-D)",
                    categoryId: "cat-tng-s1",
                    createdAt: "2025352.1301",
                },
                // TNG Season 2
                {
                    id: "bm-tng-s2-captain",
                    title: "TNG S2  Captain Picard",
                    description:
                        "Picard continues to lead the Enterprise through diplomatic and exploratory missions.",
                    url: "https://example.com/tng/season2/captain",
                    categoryId: "cat-tng-s2",
                    createdAt: "2025352.1302",
                },
                {
                    id: "bm-tng-s2-ship",
                    title: "TNG S2  USS Enterprise-D",
                    description:
                        "The Galaxy-class flagship continues its mission of exploration in its second year.",
                    url: "https://example.com/tng/season2/ship",
                    categoryId: "cat-tng-s2",
                    createdAt: "2025352.1303",
                },
                // DS9 Season 1
                {
                    id: "bm-ds9-s1-captain",
                    title: "DS9 S1  Commander Sisko",
                    description:
                        "Commanding officer of Deep Space 9 and the Emissary of the Prophets.",
                    url: "https://memory-alpha.fandom.com/wiki/Benjamin_Sisko",
                    categoryId: "cat-ds9-s1",
                    createdAt: "2025352.1304",
                },
                {
                    id: "bm-ds9-s1-ship",
                    title: "DS9 S1  Deep Space 9",
                    description:
                        "Former Cardassian mining station, now a key Federation outpost near the Bajoran wormhole.",
                    url: "https://memory-alpha.fandom.com/wiki/Deep_Space_9",
                    categoryId: "cat-ds9-s1",
                    createdAt: "2025352.1305",
                },
                // DS9 Season 2
                {
                    id: "bm-ds9-s2-captain",
                    title: "DS9 S2  Commander Sisko",
                    description:
                        "Continuing his role as station commander, Sisko faces new challenges in the Gamma Quadrant.",
                    url: "https://example.com/ds9/season2/captain",
                    categoryId: "cat-ds9-s2",
                    createdAt: "2025352.1306",
                },
                {
                    id: "bm-ds9-s2-ship",
                    title: "DS9 S2  USS Defiant",
                    description:
                        "The first Federation starship designed purely for combat, assigned to Deep Space 9.",
                    url: "https://example.com/ds9/season2/ship",
                    categoryId: "cat-ds9-s2",
                    createdAt: "2025352.1307",
                },
            ];
            const LCARS_PALETTE = [
                "#ff9900",
                "#ffcc00",
                "#ffcc99",
                "#cc9966",
                "#cc99cc",
                "#9999cc",
                "#99ccff",
                "#6699cc",
                "#40e0d0", // turquoise
                "#008080", // teal
                "#cc6666",
                "#ff6666",
                "#ff9966",
                "#ff6699",
                "#66cccc",
                "#999999",
                "#333333",
                "#663399",
                "#0066cc",
                "#ff9933",
            ];

            let state = {
                bookmarks: JSON.parse(JSON.stringify(DEFAULT_BOOKMARKS)),
                categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
                currentCategory: "cat-root-startrek",
                landingCategoryId: null,
            };

            // Theme state is intentionally separate from bookmark/category state
            // so we don't disturb the existing import/export format.
            let currentTheme = "laan";

            // Settings page navigation state
            // null = main settings grid, otherwise the sub-page id
            let currentSettingsPage = null;

            // Current main view state: "bookmarks", "settings", or "about"
            let currentView = "bookmarks";

            // Settings page name mapping for breadcrumb display
            const SETTINGS_PAGE_LABELS = {
                categories: "CATEGORIES",
                home: "HOME CATEGORY",
                themes: "THEMES",
                data: "IMPORT / EXPORT",
                reset: "SYSTEM RESET",
            };

            // ==============================================
            // ROOT CONTAINER PATTERN
            // Query all elements relative to a root container
            // to enable multiple instances on a single page.
            // ==============================================

            // Root container for the app (all non-dialog elements live here)
            const appRoot = document.querySelector(".js-lcars-app");

            // Helper to query within app root
            const $ = (selector) => appRoot.querySelector(selector);
            const $$ = (selector) => appRoot.querySelectorAll(selector);

            // Helper to query dialogs (which render at document root level)
            const $dialog = (selector) => document.querySelector(selector);

            // Main app elements (queried from app root)
            const grid = $(".js-bookmark-grid");
            const emptyState = $(".js-empty-state");
            const homeBtn = $(".js-home-btn");
            const sidebar = $(".js-category-sidebar");
            const bookmarksView = $(".js-bookmarks-view");
            const settingsView = $(".js-settings-view");
            const aboutView = $(".js-about-view");
            const landingCategorySelect = $(".js-landing-category-select");
            const settingsStardateEl = $(".js-settings-stardate");

            // Settings page elements
            const settingsMainGrid = $(".js-settings-main-grid");
            const settingsBreadcrumbPath = $(".js-settings-breadcrumb-path");
            const settingsPageCategories = $(".js-settings-page-categories");
            const settingsPageHome = $(".js-settings-page-home");
            const settingsPageThemes = $(".js-settings-page-themes");
            const settingsPageData = $(".js-settings-page-data");
            const settingsPageReset = $(".js-settings-page-reset");
            const categoryConfigList = $(".js-category-config-list");
            const importInput = $(".js-import-input");
            const aboutViewRoot = $(".js-about-view");
            const aboutStardateEl = aboutViewRoot
                ? aboutViewRoot.querySelector(".js-about-stardate")
                : null;

            // Dialogs (query from document since they render at root level)
            const bookmarkDialog = $dialog(".js-bookmark-dialog");
            const bookmarkForm =
                bookmarkDialog?.querySelector(".js-bookmark-form");
            const dialogTitle =
                bookmarkDialog?.querySelector(".js-dialog-title");
            const deleteBtn = bookmarkDialog?.querySelector(".js-delete-btn");
            const bookmarkIdInput =
                bookmarkDialog?.querySelector(".js-bookmark-id");
            const titleInput = bookmarkDialog?.querySelector(".js-title-input");
            const descriptionInput = bookmarkDialog?.querySelector(
                ".js-description-input",
            );
            const urlProtocolSelect =
                bookmarkDialog?.querySelector(".js-url-protocol");
            const urlInput = bookmarkDialog?.querySelector(".js-url-input");
            const categoryInput =
                bookmarkDialog?.querySelector(".js-category-input");
            const bookmarkStardateEl = bookmarkDialog?.querySelector(
                ".js-bookmark-stardate",
            );
            const bookmarkCancelBtn = bookmarkDialog?.querySelector(
                ".js-bookmark-cancel-btn",
            );

            const categoryDialog = $dialog(".js-category-dialog");
            const categoryForm =
                categoryDialog?.querySelector(".js-category-form");
            const categoryDialogTitle = categoryDialog?.querySelector(
                ".js-category-dialog-title",
            );
            const categoryStardateEl = categoryDialog?.querySelector(
                ".js-category-stardate",
            );
            const categoryIdInput =
                categoryDialog?.querySelector(".js-category-id");
            const categoryNameInput = categoryDialog?.querySelector(
                ".js-category-name-input",
            );
            const categoryParentInput = categoryDialog?.querySelector(
                ".js-category-parent-input",
            );
            const categoryColorGrid = categoryDialog?.querySelector(
                ".js-category-color-grid",
            );
            const categoryColorInput = categoryDialog?.querySelector(
                ".js-category-color-input",
            );
            const categoryColorFormGroup = categoryDialog?.querySelector(
                ".js-category-color-form-group",
            );
            const categoryDeleteBtn = categoryDialog?.querySelector(
                ".js-category-delete-btn",
            );
            const categoryCancelBtn = categoryDialog?.querySelector(
                ".js-category-cancel-btn",
            );

            const confirmDialog = $dialog(".js-confirm-dialog");
            const confirmTitle =
                confirmDialog?.querySelector(".js-confirm-title");
            const confirmMessage = confirmDialog?.querySelector(
                ".js-confirm-message",
            );
            const confirmOkBtn =
                confirmDialog?.querySelector(".js-confirm-ok-btn");
            const confirmCancelBtn = confirmDialog?.querySelector(
                ".js-confirm-cancel-btn",
            );

            const colorPickerDialog = $dialog(".js-color-picker-dialog");
            const colorGrid =
                colorPickerDialog?.querySelector(".js-color-grid");

            // --- Dialog focus management helper ---
            // Ensures focus is moved into the dialog on open, trapped while open,
            // and returned to the element that triggered the dialog on close.
            function openDialogWithFocusTrap(
                dialog,
                initialFocusSelector,
                triggerElement,
            ) {
                if (!dialog) return;

                const previouslyFocused =
                    triggerElement || document.activeElement;

                const getFocusableElements = () => {
                    return Array.from(
                        dialog.querySelectorAll(
                            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
                        ),
                    ).filter(
                        (el) =>
                            !el.hasAttribute("disabled") &&
                            !el.getAttribute("aria-hidden"),
                    );
                };

                const handleKeydown = (event) => {
                    if (event.key !== "Tab") return;

                    const focusable = getFocusableElements();
                    if (focusable.length === 0) return;

                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];
                    const current = document.activeElement;

                    if (event.shiftKey) {
                        // Shift+Tab
                        if (current === first || !dialog.contains(current)) {
                            event.preventDefault();
                            last.focus();
                        }
                    } else {
                        // Tab
                        if (current === last || !dialog.contains(current)) {
                            event.preventDefault();
                            first.focus();
                        }
                    }
                };

                const handleClose = () => {
                    dialog.removeEventListener("close", handleClose);
                    dialog.removeEventListener("keydown", handleKeydown);
                    if (previouslyFocused && previouslyFocused.focus) {
                        previouslyFocused.focus();
                    }
                };

                dialog.addEventListener("keydown", handleKeydown);
                dialog.addEventListener("close", handleClose);

                dialog.showModal();

                // After opening, move focus to the requested initial control or first focusable
                const desiredInitial =
                    (initialFocusSelector &&
                        dialog.querySelector(initialFocusSelector)) ||
                    getFocusableElements()[0];
                if (desiredInitial && desiredInitial.focus) {
                    desiredInitial.focus();
                }
            }

            function showConfirm(title, message, onOk) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;

                const handleOk = () => {
                    onOk();
                    cleanup();
                };

                const handleCancel = () => {
                    cleanup();
                };

                const cleanup = () => {
                    confirmOkBtn.removeEventListener("click", handleOk);
                    confirmCancelBtn.removeEventListener("click", handleCancel);
                    confirmDialog.close();
                };

                confirmOkBtn.addEventListener("click", handleOk);
                confirmCancelBtn.addEventListener("click", handleCancel);
                openDialogWithFocusTrap(
                    confirmDialog,
                    ".js-confirm-ok-btn",
                    document.activeElement,
                );
            }

            function openColorPicker(current, onSelect) {
                colorGrid.innerHTML = "";
                LCARS_PALETTE.forEach((color) => {
                    const btn = document.createElement("button");
                    btn.className = "color-option";
                    btn.style.backgroundColor = color;
                    btn.setAttribute("aria-label", `Color ${color}`);
                    if (color === current) {
                        btn.style.outline = "2px solid var(--lcars-white)";
                        btn.setAttribute("aria-current", "true");
                    }
                    btn.onclick = () => {
                        onSelect(color);
                        colorPickerDialog.close();
                    };
                    colorGrid.appendChild(btn);
                });
                openDialogWithFocusTrap(
                    colorPickerDialog,
                    ".color-option[aria-current='true']",
                    document.activeElement,
                );
            }

            function showAlert(title, message) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;

                // For alerts, we present a single-acknowledge LCARS dialog.
                const previousOkLabel = confirmOkBtn.textContent;
                const previousCancelDisplay = confirmCancelBtn.style.display;

                confirmOkBtn.textContent = "ACKNOWLEDGE";
                confirmCancelBtn.style.display = "none";

                const handleOk = () => {
                    confirmOkBtn.removeEventListener("click", handleOk);
                    confirmOkBtn.textContent = previousOkLabel;
                    confirmCancelBtn.style.display = previousCancelDisplay;
                    confirmDialog.close();
                };

                confirmOkBtn.addEventListener("click", handleOk);
                openDialogWithFocusTrap(
                    confirmDialog,
                    ".js-confirm-ok-btn",
                    document.activeElement,
                );
            }

            function init() {
                loadData();
                loadTheme();
                applyTheme(currentTheme);
                renderCategories();
                renderGrid();
                setupEventListeners();
                renderThemeControls();
                updateStardateDisplay(settingsStardateEl);
                updateSettingsTileMeta();
                renderSettingsBreadcrumb();

                // Apply restored view state
                applyViewState();
            }

            function applyViewState() {
                // Switch to the restored main view
                bookmarksView.classList.remove("active");
                settingsView.classList.remove("active");
                aboutView.classList.remove("active");

                switch (currentView) {
                    case "settings":
                        settingsView.classList.add("active");
                        renderSettingsView();
                        break;
                    case "about":
                        aboutView.classList.add("active");
                        break;
                    case "bookmarks":
                    default:
                        bookmarksView.classList.add("active");
                        break;
                }
            }

            function loadData() {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    try {
                        const data = JSON.parse(raw);
                        if (Array.isArray(data.bookmarks)) {
                            state.bookmarks = data.bookmarks;
                        }
                        if (
                            Array.isArray(data.categories) &&
                            data.categories.length > 0
                        ) {
                            state.categories = data.categories;
                        }
                        if (typeof data.landingCategoryId === "string") {
                            state.landingCategoryId = data.landingCategoryId;
                        }

                        // Restore current category if valid
                        if (typeof data.currentCategory === "string") {
                            state.currentCategory = data.currentCategory;
                        }

                        // Restore current view state
                        if (
                            ["bookmarks", "settings", "about"].includes(
                                data.currentView,
                            )
                        ) {
                            currentView = data.currentView;
                        }

                        // Restore settings sub-page state
                        if (
                            data.currentSettingsPage === null ||
                            [
                                "categories",
                                "home",
                                "themes",
                                "data",
                                "reset",
                            ].includes(data.currentSettingsPage)
                        ) {
                            currentSettingsPage = data.currentSettingsPage;
                        }

                        backfillBookmarkCreatedAt(state.bookmarks);
                        backfillCategoryCreatedAt(state.categories);
                    } catch (e) {
                        console.error("Data corruption detected", e);
                        // If stored data is corrupt, reset to defaults and notify the user.
                        showAlert(
                            "ERROR",
                            "STORED DATA IS CORRUPT. RESETTING TO DEFAULTS.",
                        );
                        const bundle = {
                            bookmarks: JSON.parse(
                                JSON.stringify(DEFAULT_BOOKMARKS),
                            ),
                            categories: JSON.parse(
                                JSON.stringify(DEFAULT_CATEGORIES),
                            ),
                        };
                        applyDataBundle(bundle);
                    }
                }

                // Ensure current category is valid (check nested categories too)
                const currentCategoryExists =
                    state.currentCategory &&
                    getCategoryPath(state.currentCategory, state.categories)
                        ?.length > 0;
                if (!currentCategoryExists) {
                    state.currentCategory = state.categories[0]?.id || null;
                }

                // Initialize landingCategoryId: default to first root if not set/invalid
                const hasValidLanding =
                    state.landingCategoryId &&
                    !!getCategoryPath(
                        state.landingCategoryId,
                        state.categories,
                    );
                if (!hasValidLanding) {
                    state.landingCategoryId = state.categories[0]?.id || null;
                }
            }

            function saveData() {
                localStorage.setItem(
                    STORAGE_KEY,
                    JSON.stringify({
                        bookmarks: state.bookmarks,
                        categories: state.categories,
                        landingCategoryId: state.landingCategoryId || null,
                        currentCategory: state.currentCategory || null,
                        currentView: currentView || "bookmarks",
                        currentSettingsPage: currentSettingsPage || null,
                    }),
                );
            }

            function backfillBookmarkCreatedAt(bookmarks) {
                bookmarks.forEach((b) => {
                    if (!b.createdAt) {
                        b.createdAt = calculateStardate();
                    }
                });
            }

            function backfillCategoryCreatedAt(categories) {
                categories.forEach((c) => {
                    if (!c.createdAt) {
                        c.createdAt = calculateStardate();
                    }
                    if (Array.isArray(c.children) && c.children.length > 0) {
                        backfillCategoryCreatedAt(c.children);
                    }
                });
            }

            function setTheme(themeId) {
                const theme =
                    THEMES.find((t) => t.id === themeId) ||
                    THEMES.find((t) => t.id === "laan");
                currentTheme = theme.id;
                document.body.setAttribute("data-theme", currentTheme);
                localStorage.setItem(THEME_STORAGE_KEY, currentTheme);
                updateThemeStatus();
            }

            function loadTheme() {
                const stored = localStorage.getItem(THEME_STORAGE_KEY);
                if (stored && THEMES.some((t) => t.id === stored)) {
                    setTheme(stored);
                } else {
                    setTheme("laan");
                }
            }

            function applyTheme(themeId) {
                setTheme(themeId);
            }

            function renderCategories() {
                sidebar.innerHTML = "";

                // Determine which root category should be marked active based on the current path
                const path = state.currentCategory
                    ? getCategoryPath(state.currentCategory, state.categories)
                    : null;
                const currentRootId = path && path.length ? path[0].id : null;

                // Determine effective tab target (roving tabindex)
                // If currentRootId is valid and exists in root categories, use it.
                // Otherwise default to the first category.
                const rootExists = state.categories.some(
                    (c) => c.id === currentRootId,
                );
                const tabTargetId = rootExists
                    ? currentRootId
                    : state.categories.length > 0
                      ? state.categories[0].id
                      : null;

                // Render only root categories in the sidebar
                state.categories.forEach((cat) => {
                    const btn = document.createElement("button");
                    btn.className =
                        "lcars-button lcars-sidebar-btn" +
                        (currentRootId === cat.id ? " active" : "");
                    btn.textContent = cat.name;
                    btn.style.setProperty("--cat-color", cat.color);
                    btn.dataset.id = cat.id;
                    btn.setAttribute("aria-label", `Category: ${cat.name}`);

                    // Roving tabindex
                    btn.tabIndex = cat.id === tabTargetId ? 0 : -1;

                    if (currentRootId === cat.id) {
                        btn.setAttribute("aria-current", "page");
                    }
                    sidebar.appendChild(btn);
                });

                // Update category select in the dialog using the full tree, with indentation
                categoryInput.innerHTML = "";
                walkCategories(state.categories, (cat, parent, depth) => {
                    const level = depth + 1;
                    const opt = document.createElement("option");
                    opt.value = cat.id;
                    let prefix = "";
                    for (let i = 1; i < level; i++) {
                        prefix += "\u00A0\u00A0"; // Non-breaking spaces
                    }
                    if (level > 1) prefix += " ";
                    opt.textContent = prefix + cat.name;
                    opt.setAttribute(
                        "aria-label",
                        `${cat.name}${level > 1 ? " (subcategory)" : ""}`,
                    );
                    categoryInput.appendChild(opt);
                });

                updateSystemStatus();
                updateSettingsTileMeta();
                updateBookmarkLocation();
            }

            function renderLandingCategoryOptions() {
                if (!landingCategorySelect) return;

                landingCategorySelect.innerHTML = "";

                walkCategories(state.categories, (cat, parent, depth) => {
                    const level = depth + 1;
                    // Only allow root categories as landing options for now
                    if (level !== 1) return;

                    const opt = document.createElement("option");
                    opt.value = cat.id;
                    opt.textContent = cat.name;
                    landingCategorySelect.appendChild(opt);
                });

                // Ensure a valid landingCategoryId exists
                const hasValidLanding =
                    state.landingCategoryId &&
                    !!getCategoryPath(
                        state.landingCategoryId,
                        state.categories,
                    );
                if (!hasValidLanding && state.categories.length > 0) {
                    state.landingCategoryId = state.categories[0].id;
                    saveData();
                }

                if (state.landingCategoryId) {
                    landingCategorySelect.value = state.landingCategoryId;
                }
            }

            function createBookmarkTile(bookmark) {
                const tile = document.createElement("li");
                tile.className = "lcars-tile lcars-tile--bookmark";
                tile.dataset.id = bookmark.id;

                // Use category color for tile if available

                const cat = walkCategories(state.categories, (c) => {
                    if (c.id === bookmark.categoryId) return c;
                    return undefined;
                });
                const catColor = cat ? cat.color : "var(--lcars-orange)";

                tile.style.setProperty("--tile-color", catColor);

                const descriptionHtml = bookmark.description
                    ? `<div class="lcars-tile-meta lcars-tile-meta--bookmark">${escapeHtml(bookmark.description)}</div>`
                    : '<div class="lcars-tile-meta lcars-tile-meta--bookmark"></div>';

                tile.innerHTML = `
                    <div class="lcars-tile-label lcars-tile-label--bookmark">${escapeHtml(bookmark.title)}</div>
                    ${descriptionHtml}
                    <div class="lcars-tile-footer">
                        <button class="lcars-pin lcars-pin--sm lcars-pin--edit" type="button" title="Edit Bookmark" aria-label="Edit Bookmark"></button>
                        <button class="lcars-pin lcars-pin--sm lcars-pin--url" type="button" title="${escapeHtml(bookmark.url)}" aria-label="Open Bookmark URL"></button>
                    </div>
                `;

                // Bookmark tiles are list items in the bookmark list
                tile.setAttribute(
                    "aria-label",
                    `Bookmark: ${escapeHtml(bookmark.title)} - ${escapeHtml(bookmark.url)}`,
                );

                return tile;
            }

            function createCategoryTile(category) {
                const tile = document.createElement("li");
                tile.className = "lcars-tile lcars-tile--category";
                tile.dataset.id = category.id;

                const color = category.color || "var(--theme-main)";
                tile.style.setProperty("--tile-color", color);

                let childCount = 0;
                if (Array.isArray(category.children)) {
                    childCount = category.children.length;
                }
                const bookmarkCount = state.bookmarks.filter(
                    (b) => b.categoryId === category.id,
                ).length;

                const primaryMetaParts = [];
                if (childCount > 0) {
                    primaryMetaParts.push(
                        `${childCount} FOLDER${childCount > 1 ? "S" : ""}`,
                    );
                }
                if (bookmarkCount > 0) {
                    primaryMetaParts.push(
                        `${bookmarkCount} LINK${bookmarkCount > 1 ? "S" : ""}`,
                    );
                }

                const primaryMeta =
                    primaryMetaParts.length > 0
                        ? primaryMetaParts.join("  ")
                        : "EMPTY";

                const createdAtLabel = category.createdAt
                    ? `CREATED ST: ${category.createdAt}`
                    : "";

                tile.innerHTML = `
                    <div class="lcars-tile-label">${escapeHtml(category.name)}</div>
                    <div class="lcars-tile-meta">
                        <div class="lcars-tile-meta-primary">${escapeHtml(primaryMeta)}</div>
                        <div class="lcars-tile-meta-secondary">${escapeHtml(createdAtLabel)}</div>
                    </div>
                    <div class="lcars-tile-footer">
                        <button class="lcars-pin lcars-pin--sm lcars-pin--edit" type="button" title="Edit Category" aria-label="Edit Category ${escapeHtml(category.name)}"></button>
                        <button class="lcars-pin lcars-pin--sm lcars-pin--open" type="button" title="Open Category" aria-label="Open Category ${escapeHtml(category.name)}"></button>
                    </div>
                `;

                // Category tiles are list items in the bookmark list
                tile.setAttribute(
                    "aria-label",
                    `Category: ${category.name}. ${primaryMeta}${
                        createdAtLabel ? ". " + createdAtLabel : ""
                    }`,
                );

                return tile;
            }

            function getCurrentCategory() {
                const id = state.currentCategory;
                if (!id) return null;

                return (
                    walkCategories(state.categories, (cat) => {
                        if (cat.id === id) return cat;
                        return undefined;
                    }) || null
                );
            }

            function renderGrid() {
                grid.innerHTML = "";

                const currentCategory = getCurrentCategory();

                // 1. Render child categories as LCARS category tiles
                const childCategories = currentCategory?.children || [];
                childCategories.forEach((cat) => {
                    const tile = createCategoryTile(cat);
                    grid.appendChild(tile);
                });

                // 2. Render bookmarks directly in the current category
                const filtered = state.bookmarks.filter((b) =>
                    currentCategory
                        ? b.categoryId === currentCategory.id
                        : true,
                );

                if (filtered.length === 0 && childCategories.length === 0) {
                    emptyState.style.display = "block";
                } else {
                    emptyState.style.display = "none";
                    filtered.forEach((b) => {
                        const tile = createBookmarkTile(b);
                        grid.appendChild(tile);
                    });
                }

                updateSystemStatus();
                updateSettingsTileMeta();
                updateBookmarkLocation();
            }

            function goHome() {
                // Ensure views are switched to Bookmarks
                bookmarksView.classList.add("active");
                settingsView.classList.remove("active");
                aboutView.classList.remove("active");
                currentView = "bookmarks";

                let targetCategoryId = null;

                // 1. Prefer configured landing category if it still exists
                if (state.landingCategoryId) {
                    const landingPath = getCategoryPath(
                        state.landingCategoryId,
                        state.categories,
                    );
                    if (landingPath && landingPath.length > 0) {
                        targetCategoryId = state.landingCategoryId;
                    }
                }

                // 2. If no valid landing category, use root of current category path
                if (!targetCategoryId && state.currentCategory) {
                    const path = getCategoryPath(
                        state.currentCategory,
                        state.categories,
                    );
                    if (path && path.length > 0) {
                        targetCategoryId = path[0].id;
                    }
                }

                // 3. Fallback to first root category
                if (!targetCategoryId && state.categories.length > 0) {
                    targetCategoryId = state.categories[0].id;
                }

                if (targetCategoryId) {
                    state.currentCategory = targetCategoryId;
                }

                // Always save to persist currentView change
                saveData();

                renderCategories();
                renderGrid();
            }

            function formatCurrentStardateDisplay() {
                const sd = calculateStardate();
                const date = parseStardate(sd);
                return {
                    stardate: sd,
                    label: `STARDATE ${sd}`,
                    tooltip: date ? date.toLocaleString() : "",
                };
            }

            function updateStardateDisplay(el) {
                if (!el) return;
                const info = formatCurrentStardateDisplay();
                el.textContent = info.label;
                el.title = info.tooltip;
            }

            function updateSystemStatus() {
                const statusEl = $(".js-system-status");
                if (statusEl) {
                    let catCount = 0;
                    walkCategories(state.categories, () => {
                        catCount++;
                    });
                    const bmCount = state.bookmarks.length;
                    statusEl.innerHTML = `
                        <span class="lcars-status-text">STATUS:</span>
                        <div class="lcars-status-info" aria-live="polite" aria-label="System Status">
                            <span>CT: ${catCount}</span>
                            <span></span>
                            <span>BM: ${bmCount}</span>
                        </div>
                    `;
                }
            }

            function updateThemeStatus() {
                const themeStatusEl = $(".js-theme-status-readout");
                if (!themeStatusEl) return;
                const current =
                    THEMES.find((t) => t.id === currentTheme) || THEMES[0];
                themeStatusEl.textContent = `ACTIVE THEME: ${current.label}`;
            }

            // ==============================================
            // SETTINGS PAGE NAVIGATION
            // ==============================================

            function navigateToSettingsPage(pageId) {
                currentSettingsPage = pageId;
                saveData();
                renderSettingsView();
            }

            function navigateToSettingsMain() {
                currentSettingsPage = null;
                saveData();
                renderSettingsView();
            }

            function renderSettingsBreadcrumb() {
                if (!settingsBreadcrumbPath) return;
                settingsBreadcrumbPath.innerHTML = "";

                // Root segment (always present)
                const rootBtn = document.createElement("button");
                rootBtn.type = "button";
                rootBtn.className = "lcars-breadcrumb-segment is-root";
                if (!currentSettingsPage) {
                    rootBtn.classList.add("is-current");
                    rootBtn.setAttribute("aria-current", "page");
                }
                rootBtn.textContent = "SETTINGS";
                rootBtn.addEventListener("click", () => {
                    if (currentSettingsPage) {
                        navigateToSettingsMain();
                    }
                });
                settingsBreadcrumbPath.appendChild(rootBtn);

                // Sub-page segment (if on a sub-page)
                if (currentSettingsPage) {
                    const sep = document.createElement("span");
                    sep.className = "lcars-breadcrumb-separator";
                    sep.textContent = "";
                    settingsBreadcrumbPath.appendChild(sep);

                    const pageSpan = document.createElement("span");
                    pageSpan.className = "lcars-breadcrumb-segment is-current";
                    pageSpan.textContent =
                        SETTINGS_PAGE_LABELS[currentSettingsPage] ||
                        currentSettingsPage.toUpperCase();
                    pageSpan.setAttribute("aria-current", "page");
                    settingsBreadcrumbPath.appendChild(pageSpan);
                }
            }

            function renderSettingsView() {
                // Hide all sub-pages
                const subpages = [
                    settingsPageCategories,
                    settingsPageHome,
                    settingsPageThemes,
                    settingsPageData,
                    settingsPageReset,
                ];
                subpages.forEach((page) => {
                    if (page) page.classList.remove("active");
                });

                // Show main grid or sub-page
                if (!currentSettingsPage) {
                    if (settingsMainGrid)
                        settingsMainGrid.classList.add("active");
                    updateSettingsTileMeta();
                } else {
                    if (settingsMainGrid)
                        settingsMainGrid.classList.remove("active");

                    // Show the appropriate sub-page
                    switch (currentSettingsPage) {
                        case "categories":
                            if (settingsPageCategories)
                                settingsPageCategories.classList.add("active");
                            renderCategoryConfig();
                            break;
                        case "home":
                            if (settingsPageHome)
                                settingsPageHome.classList.add("active");
                            renderLandingCategoryOptions();
                            break;
                        case "themes":
                            if (settingsPageThemes)
                                settingsPageThemes.classList.add("active");
                            renderThemeControls();
                            updateThemeStatus();
                            break;
                        case "data":
                            if (settingsPageData)
                                settingsPageData.classList.add("active");
                            break;
                        case "reset":
                            if (settingsPageReset)
                                settingsPageReset.classList.add("active");
                            break;
                    }
                }

                renderSettingsBreadcrumb();
            }

            function updateSettingsTileMeta() {
                // Update category count (element removed from settings tile)
                // Keeping function structure for future use

                // Update home category name
                const homeCategoryNameEl = $(".js-settings-home-category-name");
                if (homeCategoryNameEl) {
                    let landingCat = null;
                    if (state.landingCategoryId) {
                        landingCat = walkCategories(state.categories, (cat) => {
                            if (cat.id === state.landingCategoryId) return cat;
                            return undefined;
                        });
                    }
                    // Fallback to first category if no valid landing category
                    if (!landingCat && state.categories.length > 0) {
                        landingCat = state.categories[0];
                    }
                    homeCategoryNameEl.textContent =
                        "LANDING CATEGORY: " +
                        (landingCat ? landingCat.name : "NO CATEGORIES");
                }

                // Update active theme
                const activeThemeEl = $(".js-settings-active-theme");
                if (activeThemeEl) {
                    const current =
                        THEMES.find((t) => t.id === currentTheme) || THEMES[0];
                    activeThemeEl.textContent =
                        "CURRENT THEME: " + current.label;
                }
            }

            function calculateStardate(date = new Date()) {
                const start = new Date(date.getFullYear(), 0, 0);
                const diff = date - start;
                const oneDay = 1000 * 60 * 60 * 24;
                const day = Math.floor(diff / oneDay);
                const minutes = date.getHours() * 60 + date.getMinutes();

                // Format: YYYYDDD.MMMM (Year + DayOfYear . TotalMinutes)
                return `${date.getFullYear()}${day.toString().padStart(3, "0")}.${minutes.toString().padStart(4, "0")}`;
            }

            function parseStardate(stardate) {
                if (!stardate || typeof stardate !== "string") return null;
                const year = parseInt(stardate.substring(0, 4));
                const dayOfYear = parseInt(stardate.substring(4, 7));
                const minutes = parseInt(stardate.substring(8));

                if (isNaN(year) || isNaN(dayOfYear) || isNaN(minutes))
                    return null;

                const date = new Date(year, 0, dayOfYear);
                date.setHours(Math.floor(minutes / 60));
                date.setMinutes(minutes % 60);
                return date;
            }

            // Generic category tree walker used by config, lookups, etc.
            // visitor(cat, parent, depth, index, siblings) can return a non-undefined
            // value to short-circuit traversal with that value.
            function walkCategories(
                rootCategories,
                visitor,
                parent = null,
                depth = 0,
            ) {
                for (let i = 0; i < rootCategories.length; i++) {
                    const cat = rootCategories[i];
                    const result = visitor(
                        cat,
                        parent,
                        depth,
                        i,
                        rootCategories,
                    );
                    if (result !== undefined) {
                        return result;
                    }
                    if (cat.children && cat.children.length > 0) {
                        const childResult = walkCategories(
                            cat.children,
                            visitor,
                            cat,
                            depth + 1,
                        );
                        if (childResult !== undefined) {
                            return childResult;
                        }
                    }
                }
                return undefined;
            }

            function getCategoryPath(id, cats) {
                // Returns an array of category objects from root to the category with the given id,
                // or null if no such category exists.
                function helper(nodes, path) {
                    for (const cat of nodes) {
                        const newPath = [...path, cat];
                        if (cat.id === id) {
                            return newPath;
                        }
                        if (cat.children && cat.children.length > 0) {
                            const childPath = helper(cat.children, newPath);
                            if (childPath) return childPath;
                        }
                    }
                    return null;
                }
                return helper(cats, []);
            }

            function updateBookmarkLocation() {
                const container = $(".js-bookmark-location");
                if (!container) return;

                const pathEl = container.querySelector(
                    ".lcars-breadcrumb-path",
                );
                if (!pathEl) return;

                pathEl.innerHTML = "";

                if (!state.currentCategory) {
                    const seg = document.createElement("span");
                    seg.className = "lcars-breadcrumb-segment is-current";
                    seg.textContent = "ALL BOOKMARKS";
                    seg.setAttribute("aria-current", "location");
                    pathEl.appendChild(seg);
                    return;
                }

                const path = getCategoryPath(
                    state.currentCategory,
                    state.categories,
                );
                if (!path || path.length === 0) {
                    const seg = document.createElement("span");
                    seg.className = "lcars-breadcrumb-segment is-current";
                    seg.textContent = "UNKNOWN";
                    seg.setAttribute("aria-current", "location");
                    pathEl.appendChild(seg);
                    return;
                }

                path.forEach((cat, index) => {
                    const isLast = index === path.length - 1;
                    const isFirst = index === 0;

                    if (index > 0) {
                        const sep = document.createElement("span");
                        sep.className = "lcars-breadcrumb-separator";
                        sep.textContent = "";
                        pathEl.appendChild(sep);
                    }

                    if (isLast) {
                        const span = document.createElement("span");
                        span.className = "lcars-breadcrumb-segment is-current";
                        span.textContent = cat.name;
                        span.setAttribute("aria-current", "location");
                        pathEl.appendChild(span);
                    } else {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "lcars-breadcrumb-segment";
                        if (isFirst) btn.classList.add("is-root");
                        btn.textContent = cat.name;
                        btn.dataset.categoryId = cat.id;
                        btn.addEventListener("click", () => {
                            state.currentCategory = cat.id;
                            saveData();
                            renderGrid();
                            renderCategories();
                        });
                        pathEl.appendChild(btn);
                    }
                });
            }

            function generateUUID() {
                if (typeof crypto !== "undefined" && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                    /[xy]/g,
                    function (c) {
                        var r = (Math.random() * 16) | 0,
                            v = c == "x" ? r : (r & 0x3) | 0x8;
                        return v.toString(16);
                    },
                );
            }

            function escapeHtml(str) {
                if (!str) return "";
                return str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function normalizeUrl(s, defaultProtocol = "https://") {
                const trimmed = String(s || "").trim();
                if (!trimmed) return "";
                // If it doesn't start with a scheme like http:, https:, ftp:, mailto:, etc.,
                // assume the provided default protocol (normally https:// or http://)
                if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmed)) {
                    // Strip any leading slashes so we don't end up with https:////example.com
                    const withoutSlashes = trimmed.replace(/^\/+/, "");
                    return `${defaultProtocol}${withoutSlashes}`;
                }
                return trimmed;
            }

            function isProbablyUrl(s) {
                try {
                    const url = new URL(s);
                    if (!["http:", "https:"].includes(url.protocol))
                        return false;

                    const host = url.hostname;
                    if (!host) return false;

                    // Allow localhost explicitly
                    if (host === "localhost") return true;

                    // Allow IPv4 addresses
                    if (/^\d{1,3}(\.\d{1,3}){3}$/.test(host)) return true;

                    // Require at least one dot for normal hostnames (e.g., example.com)
                    if (host.includes(".")) return true;

                    return false;
                } catch {
                    return false;
                }
            }

            function openAddDialog() {
                dialogTitle.textContent = "ADD ENTRY";

                const info = formatCurrentStardateDisplay();
                if (bookmarkStardateEl) {
                    bookmarkStardateEl.textContent = info.label;
                    bookmarkStardateEl.title = info.tooltip;
                }

                bookmarkForm.reset();
                bookmarkIdInput.value = "";
                urlProtocolSelect.value = "https://";
                categoryInput.value = state.currentCategory;
                deleteBtn.style.display = "none";
                openDialogWithFocusTrap(
                    bookmarkDialog,
                    "#titleInput",
                    document.activeElement,
                );
            }

            function openEditDialog(bookmark) {
                dialogTitle.textContent = "EDIT ENTRY";

                if (bookmarkStardateEl) {
                    if (bookmark.createdAt) {
                        bookmarkStardateEl.textContent = `STARDATE ${bookmark.createdAt}`;
                        const date = parseStardate(bookmark.createdAt);
                        bookmarkStardateEl.title = date
                            ? date.toLocaleString()
                            : "";
                    } else {
                        bookmarkStardateEl.textContent = "";
                        bookmarkStardateEl.title = "";
                    }
                }

                bookmarkIdInput.value = bookmark.id;
                titleInput.value = bookmark.title;
                descriptionInput.value = bookmark.description || "";

                let url = bookmark.url;
                let protocol = "https://";
                if (url.startsWith("http://")) {
                    protocol = "http://";
                    url = url.substring(7);
                } else if (url.startsWith("https://")) {
                    protocol = "https://";
                    url = url.substring(8);
                }

                urlProtocolSelect.value = protocol;
                urlInput.value = url;

                categoryInput.value =
                    bookmark.categoryId || state.categories[0].id;
                deleteBtn.style.display = "inline-block";
                deleteBtn.onclick = () => deleteBookmark(bookmark.id);
                openDialogWithFocusTrap(
                    bookmarkDialog,
                    "#titleInput",
                    document.activeElement,
                );
            }

            function saveBookmark(e) {
                e.preventDefault(); // Prevent default form submission

                const id = bookmarkIdInput.value;
                const title = titleInput.value;
                const description = descriptionInput.value.trim();
                const protocol =
                    (urlProtocolSelect && urlProtocolSelect.value) ||
                    "https://";
                const rawUrl = urlInput.value.trim();

                const categoryId = categoryInput.value;

                if (!title.trim()) {
                    showAlert("ERROR", "TITLE IS REQUIRED.");
                    return;
                }

                if (!rawUrl) {
                    showAlert("ERROR", "URL IS REQUIRED.");
                    return;
                }

                // Normalize URL using selected protocol as default, but still respect
                // full URLs the user may have pasted (http/https and other schemes)
                const url = normalizeUrl(rawUrl, protocol);

                if (!isProbablyUrl(url)) {
                    showAlert(
                        "ERROR",
                        "URL DOES NOT APPEAR TO BE VALID (MUST BE HTTP OR HTTPS).",
                    );
                    return;
                }

                if (id) {
                    // Edit
                    const idx = state.bookmarks.findIndex((b) => b.id === id);
                    if (idx !== -1) {
                        state.bookmarks[idx].title = title;
                        state.bookmarks[idx].description = description;
                        state.bookmarks[idx].url = url;
                        state.bookmarks[idx].categoryId = categoryId;
                    }
                } else {
                    // Add
                    const newBookmark = {
                        id: generateUUID(),
                        title,
                        description,
                        url,
                        categoryId,
                        createdAt: calculateStardate(),
                    };
                    state.bookmarks.push(newBookmark);
                }

                saveData();
                renderGrid();
                bookmarkDialog.close();
            }

            function openAddCategoryDialog() {
                categoryForm.reset();
                categoryIdInput.value = "";
                categoryDialogTitle.textContent = "NEW CATEGORY";
                categoryDeleteBtn.style.display = "none";

                // Show current stardate in the category dialog meta
                updateStardateDisplay(categoryStardateEl);

                // This dialog only creates sub-categories; no ROOT option
                categoryParentInput.innerHTML = "";
                walkCategories(state.categories, (cat) => {
                    const opt = document.createElement("option");
                    opt.value = cat.id;
                    opt.textContent = cat.name;
                    categoryParentInput.appendChild(opt);
                });

                function updateColorPickerVisibility() {
                    const isSubCat = categoryParentInput.value !== "";
                    if (isSubCat) {
                        categoryColorFormGroup.style.display = "none";
                        categoryColorInput.value = "var(--theme-secondary)";
                    } else {
                        categoryColorFormGroup.style.display = "block";
                        const defaultColor =
                            getDefaultCategoryColor(currentTheme);
                        categoryColorInput.value = defaultColor;
                        Array.from(categoryColorGrid.children).forEach((c) => {
                            c.style.border =
                                c.style.backgroundColor === defaultColor
                                    ? "2px solid white"
                                    : "none";
                        });
                    }
                }

                // Populate Colors
                categoryColorGrid.innerHTML = "";
                const defaultColor = getDefaultCategoryColor(currentTheme);
                categoryColorInput.value = defaultColor;

                LCARS_PALETTE.forEach((color) => {
                    const div = document.createElement("div");
                    div.className = "color-option";
                    div.style.backgroundColor = color;
                    div.style.height = "30px";
                    div.style.cursor = "pointer";
                    if (color === defaultColor) {
                        div.style.border = "2px solid white";
                    }
                    div.onclick = () => {
                        categoryColorInput.value = color;
                        Array.from(categoryColorGrid.children).forEach(
                            (c) => (c.style.border = "none"),
                        );
                        div.style.border = "2px solid white";
                    };
                    categoryColorGrid.appendChild(div);
                });

                categoryParentInput.onchange = updateColorPickerVisibility;
                updateColorPickerVisibility();

                openDialogWithFocusTrap(
                    categoryDialog,
                    "#categoryNameInput",
                    document.activeElement,
                );
            }

            function openEditCategoryDialog(category) {
                categoryForm.reset();
                categoryIdInput.value = category.id;
                categoryDialogTitle.textContent = "EDIT CATEGORY";
                categoryDeleteBtn.style.display = "inline-block";
                categoryDeleteBtn.onclick = () => {
                    categoryDialog.close();
                    deleteCategory(category.id);
                };

                // Show stardate from category creation
                if (category.createdAt) {
                    const date = parseStardate(category.createdAt);
                    const dateLabel = date
                        ? date.toLocaleDateString("en-US", {
                              year: "numeric",
                              month: "short",
                              day: "numeric",
                          })
                        : "";
                    categoryStardateEl.textContent = `CREATED ST: ${category.createdAt}${dateLabel ? " (" + dateLabel + ")" : ""}`;
                    categoryStardateEl.title = dateLabel;
                } else {
                    updateStardateDisplay(categoryStardateEl);
                }

                // Populate name
                categoryNameInput.value = category.name;

                // Find current parent
                const result = findCategoryAndParent(
                    category.id,
                    state.categories,
                    null,
                );
                const currentParentId =
                    result && result.parent ? result.parent.id : "";

                // Populate Parent Options (excluding self and descendants)
                categoryParentInput.innerHTML =
                    '<option value="">(ROOT)</option>';

                function getDescendantIds(cat) {
                    let ids = [cat.id];
                    if (cat.children) {
                        cat.children.forEach((child) => {
                            ids = ids.concat(getDescendantIds(child));
                        });
                    }
                    return ids;
                }
                const excludeIds = getDescendantIds(category);

                function renderOptions(cats, level = 0) {
                    cats.forEach((cat) => {
                        if (excludeIds.includes(cat.id)) return; // Can't be parent of self or descendant

                        const opt = document.createElement("option");
                        opt.value = cat.id;
                        opt.textContent = "- ".repeat(level) + cat.name;

                        if (cat.id === currentParentId) {
                            opt.selected = true;
                        }

                        categoryParentInput.appendChild(opt);
                        if (cat.children) {
                            renderOptions(cat.children, level + 1);
                        }
                    });
                }
                renderOptions(state.categories);

                // Helper to update color picker visibility based on parent selection
                const isSubCategory = currentParentId !== "";
                function updateColorPickerVisibility() {
                    const isSubCat = categoryParentInput.value !== "";
                    if (isSubCat) {
                        categoryColorFormGroup.style.display = "none";
                        categoryColorInput.value = "var(--theme-secondary)";
                    } else {
                        categoryColorFormGroup.style.display = "block";
                        // Reset to default color for root categories
                        const defaultColor =
                            getDefaultCategoryColor(currentTheme);
                        categoryColorInput.value = defaultColor;
                        // Update visual selection
                        Array.from(categoryColorGrid.children).forEach((c) => {
                            c.style.border =
                                c.style.backgroundColor === defaultColor
                                    ? "2px solid white"
                                    : "none";
                        });
                    }
                }

                // Populate Colors
                categoryColorGrid.innerHTML = "";
                const selectedColor =
                    category.color || getDefaultCategoryColor(currentTheme);
                categoryColorInput.value = isSubCategory
                    ? "var(--theme-secondary)"
                    : selectedColor;

                LCARS_PALETTE.forEach((color) => {
                    const div = document.createElement("div");
                    div.className = "color-option";
                    div.style.backgroundColor = color;
                    div.style.height = "30px";
                    div.style.cursor = "pointer";
                    if (color === selectedColor) {
                        div.style.border = "2px solid white";
                    }
                    div.onclick = () => {
                        categoryColorInput.value = color;
                        Array.from(categoryColorGrid.children).forEach(
                            (c) => (c.style.border = "none"),
                        );
                        div.style.border = "2px solid white";
                    };
                    categoryColorGrid.appendChild(div);
                });

                // Add change listener for parent selection
                categoryParentInput.onchange = updateColorPickerVisibility;

                // Set initial visibility
                categoryColorFormGroup.style.display = isSubCategory
                    ? "none"
                    : "block";

                openDialogWithFocusTrap(
                    categoryDialog,
                    "#categoryNameInput",
                    document.activeElement,
                );
            }

            function findCategoryAndParent(id, cats, parent) {
                return (
                    walkCategories(
                        cats,
                        (cat, parentNode, depth, index, siblings) => {
                            if (cat.id === id) {
                                return {
                                    category: cat,
                                    parent: parentNode,
                                    siblings,
                                    index,
                                };
                            }
                            return undefined;
                        },
                        parent,
                    ) || null
                );
            }

            function saveCategory(e) {
                e.preventDefault();

                const id = categoryIdInput.value;
                const name = categoryNameInput.value.trim().toUpperCase();
                const newParentId = categoryParentInput.value || null;
                const color = categoryColorInput.value;

                if (!name) return;

                if (id) {
                    // Edit existing category
                    const result = findCategoryAndParent(
                        id,
                        state.categories,
                        null,
                    );
                    if (!result || !result.category) {
                        categoryDialog.close();
                        return;
                    }

                    const category = result.category;
                    const oldParent = result.parent;
                    const oldParentId = oldParent ? oldParent.id : null;

                    // Update category properties
                    category.name = name;
                    category.color = color;

                    // Handle parent change (move category)
                    if (newParentId !== oldParentId) {
                        // Remove from old parent
                        if (oldParent) {
                            oldParent.children = oldParent.children.filter(
                                (c) => c.id !== id,
                            );
                        } else {
                            state.categories = state.categories.filter(
                                (c) => c.id !== id,
                            );
                        }

                        // Add to new parent
                        if (newParentId) {
                            const newParentResult = findCategoryAndParent(
                                newParentId,
                                state.categories,
                                null,
                            );
                            if (newParentResult && newParentResult.category) {
                                if (!newParentResult.category.children)
                                    newParentResult.category.children = [];
                                newParentResult.category.children.push(
                                    category,
                                );
                            }
                        } else {
                            state.categories.push(category);
                        }
                    }
                } else {
                    // Add new category
                    const newCat = {
                        id: generateUUID(),
                        name: name,
                        color: color,
                        createdAt: calculateStardate(),
                        children: [],
                    };

                    if (newParentId) {
                        const result = findCategoryAndParent(
                            newParentId,
                            state.categories,
                            null,
                        );
                        if (result) {
                            if (!result.category.children)
                                result.category.children = [];
                            result.category.children.push(newCat);
                        }
                    } else {
                        state.categories.push(newCat);
                    }
                }

                saveData();
                renderCategories();
                renderCategoryConfig();
                renderGrid();
                categoryDialog.close();
            }

            function addCategory(parentId = null) {
                const name = "NEW CATEGORY";
                const color = getDefaultCategoryColor();
                const createdAt = calculateStardate();

                const newCategory = {
                    id: "cat-" + Date.now().toString(36),
                    name,
                    color,
                    createdAt,
                    children: [],
                };

                if (parentId) {
                    const result = findCategoryAndParent(
                        parentId,
                        state.categories,
                        null,
                    );
                    if (!result) return;
                    result.category.children = result.category.children || [];
                    result.category.children.push(newCategory);
                } else {
                    state.categories.push(newCategory);
                }

                saveData();
                renderCategories();
                renderCategoryConfig();
            }

            function moveCategory(id, direction) {
                const result = findCategoryAndParent(
                    id,
                    state.categories,
                    null,
                );
                if (!result) return;

                const { siblings, index } = result;
                const newIndex = index + direction;

                if (newIndex >= 0 && newIndex < siblings.length) {
                    const temp = siblings[index];
                    siblings[index] = siblings[newIndex];
                    siblings[newIndex] = temp;
                    saveData();
                    renderCategories();
                    renderCategoryConfig();
                }
            }

            function renderCategoryConfig() {
                if (!categoryConfigList) return;

                categoryConfigList.innerHTML = "";

                // Only render root categories in the configuration list for now
                state.categories.forEach((cat, index) => {
                    const row = document.createElement("div");
                    row.className = "category-config-row";
                    row.dataset.id = cat.id;

                    // Color swatch button
                    const swatchBtn = document.createElement("button");
                    swatchBtn.type = "button";
                    swatchBtn.className = "category-color-swatch";
                    swatchBtn.style.backgroundColor =
                        cat.color || getDefaultCategoryColor();
                    swatchBtn.setAttribute(
                        "aria-label",
                        `Change color for category ${cat.name}`,
                    );
                    swatchBtn.addEventListener("click", () => {
                        openColorPicker(
                            cat.color || getDefaultCategoryColor(),
                            (newColor) => {
                                cat.color = newColor;
                                swatchBtn.style.backgroundColor = newColor;
                                saveData();
                                renderCategories();
                                renderGrid();
                            },
                        );
                    });

                    // Name input
                    const nameInput = document.createElement("input");
                    nameInput.type = "text";
                    nameInput.className = "lcars-input";
                    nameInput.value = cat.name;
                    nameInput.maxLength = 32;
                    nameInput.style.textTransform = "uppercase";
                    nameInput.setAttribute(
                        "aria-label",
                        `Category name for ${cat.name}`,
                    );
                    nameInput.addEventListener("change", () => {
                        const value = nameInput.value.trim();
                        if (!value) return;
                        cat.name = value.toUpperCase();
                        saveData();
                        renderCategories();
                        renderGrid();
                        updateSettingsTileMeta();
                    });

                    // Controls: up, down, delete
                    const controls = document.createElement("div");
                    controls.className = "category-config-row-controls";

                    const upBtn = document.createElement("button");
                    upBtn.type = "button";
                    upBtn.className =
                        "lcars-pin lcars-pin--lg lcars-pin--bordered lcars-pin--edit";
                    upBtn.setAttribute("data-glyph", "up");
                    upBtn.setAttribute(
                        "aria-label",
                        `Move category ${cat.name} up`,
                    );
                    upBtn.innerHTML =
                        '<svg><use href="#icon-arrow-up"></use></svg>';
                    upBtn.addEventListener("click", () => {
                        moveCategory(cat.id, -1);
                    });

                    const downBtn = document.createElement("button");
                    downBtn.type = "button";
                    downBtn.className =
                        "lcars-pin lcars-pin--lg lcars-pin--bordered lcars-pin--edit";
                    downBtn.setAttribute("data-glyph", "down");
                    downBtn.setAttribute(
                        "aria-label",
                        `Move category ${cat.name} down`,
                    );
                    downBtn.innerHTML =
                        '<svg><use href="#icon-arrow-down"></use></svg>';
                    downBtn.addEventListener("click", () => {
                        moveCategory(cat.id, 1);
                    });

                    const deleteBtn = document.createElement("button");
                    deleteBtn.type = "button";
                    deleteBtn.className =
                        "lcars-pin lcars-pin--lg lcars-pin--bordered lcars-pin--delete";
                    deleteBtn.setAttribute("data-glyph", "delete");
                    deleteBtn.setAttribute(
                        "aria-label",
                        `Delete category ${cat.name}`,
                    );
                    deleteBtn.innerHTML =
                        '<svg><use href="#icon-delete"></use></svg>';
                    deleteBtn.addEventListener("click", () => {
                        deleteCategory(cat.id);
                    });

                    controls.appendChild(upBtn);
                    controls.appendChild(downBtn);
                    controls.appendChild(deleteBtn);

                    row.appendChild(swatchBtn);
                    row.appendChild(nameInput);
                    row.appendChild(controls);

                    categoryConfigList.appendChild(row);
                });
            }

            function deleteCategory(id) {
                const result = findCategoryAndParent(
                    id,
                    state.categories,
                    null,
                );
                if (!result) return;

                const cat = result.category;

                // Collect full subtree for accurate counts and deletion
                const subtreeCategories = [];
                walkCategories([cat], (node) => {
                    subtreeCategories.push(node);
                    return undefined;
                });

                const subtreeIds = new Set(subtreeCategories.map((c) => c.id));

                // Count bookmarks across entire subtree
                const totalBookmarksInSubtree = state.bookmarks.filter((b) =>
                    subtreeIds.has(b.categoryId),
                ).length;

                const subCategoryCount = subtreeCategories.length - 1; // exclude root

                let msg = `Delete category "${cat.name}"?`;
                if (totalBookmarksInSubtree > 0) {
                    msg += `\nThis will delete ${totalBookmarksInSubtree} bookmark(s).`;
                }
                if (subCategoryCount > 0) {
                    msg += `\nThis will delete ${subCategoryCount} sub-categories.`;
                }

                showConfirm("DELETE CATEGORY", msg, () => {
                    // Remove all bookmarks in the subtree in a single pass
                    state.bookmarks = state.bookmarks.filter(
                        (b) => !subtreeIds.has(b.categoryId),
                    );

                    // Remove category
                    const { siblings, index } = result;
                    siblings.splice(index, 1);

                    // If current category was deleted or inside deleted tree, reset to first available
                    const currentExists = findCategoryAndParent(
                        state.currentCategory,
                        state.categories,
                        null,
                    );
                    if (!currentExists && state.categories.length > 0) {
                        state.currentCategory = state.categories[0].id;
                    } else if (state.categories.length === 0) {
                        // Create default if all deleted
                        state.categories.push({
                            id: "cat-default",
                            name: "DEFAULT",
                            color: "#ff9900",
                            createdAt: calculateStardate(),
                            children: [],
                        });
                        state.currentCategory = "cat-default";
                    }

                    saveData();
                    renderCategories();
                    renderGrid();
                    renderCategoryConfig();
                });
            }

            function getDataBundle() {
                return {
                    bookmarks: state.bookmarks,
                    categories: state.categories,
                };
            }

            function getDefaultCategoryColor() {
                const theme =
                    document.body.getAttribute("data-theme") || "pickard";

                // Map themes to preferred LCARS_PALETTE entries, falling back safely
                const colorByTheme = {
                    pickard: "#ff9900", // classic LCARS orange
                    data: "#9999cc", // cooler operations/science tone
                    doctor: "#ffcc99", // clinical beige
                    spock: "#9999cc", // science blue
                    seven: "#40e0d0", // turquoise / Borg-adjacent accent
                };

                const preferred = colorByTheme[theme] || colorByTheme.pickard;

                // If the preferred color isn't in the palette (future edits), fall back
                if (
                    Array.isArray(LCARS_PALETTE) &&
                    LCARS_PALETTE.includes(preferred)
                ) {
                    return preferred;
                }

                // Last resort: first palette color or a safe orange
                if (Array.isArray(LCARS_PALETTE) && LCARS_PALETTE.length > 0) {
                    return LCARS_PALETTE[0];
                }

                return "#ff9900";
            }

            function isValidCategoryColor(color) {
                if (typeof color !== "string" || !color.trim()) return false;
                // Allow CSS variable references (e.g., var(--theme-secondary))
                if (color.startsWith("var(--") && color.endsWith(")"))
                    return true;
                // Allow palette hex colors
                return LCARS_PALETTE.includes(color);
            }

            function applyDataBundle(bundle) {
                const originalBookmarkCount = Array.isArray(bundle.bookmarks)
                    ? bundle.bookmarks.length
                    : 0;
                const originalCategoryCount = Array.isArray(bundle.categories)
                    ? bundle.categories.length
                    : 0;

                // Validate and filter bookmarks: ensure URLs and required fields are valid
                const validBookmarks = Array.isArray(bundle.bookmarks)
                    ? bundle.bookmarks.filter((b) => {
                          if (!b || typeof b !== "object") return false;
                          if (typeof b.url !== "string" || !b.url.trim())
                              return false;
                          if (typeof b.id !== "string" || !b.id.trim())
                              return false;
                          if (typeof b.title !== "string" || !b.title.trim())
                              return false;

                          const normalized = normalizeUrl(b.url);
                          return isProbablyUrl(normalized);
                      })
                    : [];
                const failedBookmarks =
                    originalBookmarkCount - validBookmarks.length;

                // Categories: keep structurally valid categories, override bad colors to theme default
                const defaultColor = getDefaultCategoryColor();
                let overriddenColorCount = 0;

                function normalizeCategoryTree(nodes) {
                    if (!Array.isArray(nodes)) return [];

                    return nodes
                        .filter((c) => {
                            if (!c || typeof c !== "object") return false;
                            if (typeof c.id !== "string" || !c.id.trim())
                                return false;
                            if (typeof c.name !== "string" || !c.name.trim())
                                return false;
                            return true;
                        })
                        .map((c) => {
                            const clone = { ...c };

                            if (!isValidCategoryColor(clone.color)) {
                                clone.color = defaultColor;
                                overriddenColorCount++;
                            }

                            clone.children = normalizeCategoryTree(
                                clone.children || [],
                            );

                            return clone;
                        });
                }

                const normalizedCategories = normalizeCategoryTree(
                    Array.isArray(bundle.categories) ? bundle.categories : [],
                );
                const failedCategories =
                    originalCategoryCount - normalizedCategories.length;

                state.bookmarks = validBookmarks;
                state.categories = normalizedCategories;

                // Reset currentCategory to first root category if it no longer exists
                if (state.currentCategory) {
                    const currentExists = walkCategories(
                        state.categories,
                        (cat) => {
                            if (cat.id === state.currentCategory) return cat;
                            return undefined;
                        },
                    );
                    if (!currentExists) {
                        state.currentCategory =
                            state.categories.length > 0
                                ? state.categories[0].id
                                : null;
                    }
                } else if (state.categories.length > 0) {
                    state.currentCategory = state.categories[0].id;
                }

                // Reset landingCategoryId if it no longer exists
                if (state.landingCategoryId) {
                    const landingExists = walkCategories(
                        state.categories,
                        (cat) => {
                            if (cat.id === state.landingCategoryId) return cat;
                            return undefined;
                        },
                    );
                    if (!landingExists) {
                        state.landingCategoryId = null;
                    }
                }

                // Backfill createdAt fields on imported data
                backfillBookmarkCreatedAt(state.bookmarks);
                backfillCategoryCreatedAt(state.categories);

                saveData();
                renderCategories();
                renderLandingCategoryOptions();
                renderGrid();
                updateStardateDisplay(aboutStardateEl);
                updateStardateDisplay(settingsStardateEl);

                const lines = [];
                lines.push(
                    `IMPORTED ${validBookmarks.length} / ${originalBookmarkCount} BOOKMARK(S).`,
                );
                lines.push(
                    `IMPORTED ${normalizedCategories.length} / ${originalCategoryCount} CATEGOR(IES).`,
                );

                if (failedBookmarks > 0 || failedCategories > 0) {
                    lines.push(
                        `DISCARDED ${failedBookmarks} BOOKMARK(S) AND ${failedCategories} CATEGOR(IES) WITH INVALID OR MISSING REQUIRED FIELDS.`,
                    );
                }

                if (overriddenColorCount > 0) {
                    lines.push(
                        `RESET ${overriddenColorCount} CATEGORY COLOR(S) TO THE CURRENT THEME DEFAULT.`,
                    );
                }

                showAlert("IMPORT RESULT", lines.join(" "));
            }

            function exportData() {
                const dataStr = JSON.stringify(getDataBundle(), null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `lcars-bookmarks-${new Date().toISOString().split("T")[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function triggerImport() {
                importInput.click();
            }

            function handleImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Basic structure validation
                        if (typeof data !== "object" || data === null) {
                            showAlert(
                                "ERROR",
                                "INVALID DATA FORMAT (expected an object).",
                            );
                            return;
                        }

                        const bookmarks = Array.isArray(data.bookmarks)
                            ? data.bookmarks
                            : [];
                        const categories = Array.isArray(data.categories)
                            ? data.categories
                            : [];

                        if (
                            !Array.isArray(data.bookmarks) &&
                            !Array.isArray(data.categories)
                        ) {
                            showAlert(
                                "ERROR",
                                "INVALID DATA FORMAT (missing bookmarks and categories arrays).",
                            );
                            return;
                        }

                        const count = bookmarks.length;

                        showConfirm(
                            "IMPORT DATA",
                            `IMPORT ${count} ENTRIES? THIS WILL OVERWRITE CURRENT DATA.`,
                            () => {
                                const bundle = {
                                    bookmarks,
                                    categories,
                                };
                                applyDataBundle(bundle);
                            },
                        );
                    } catch (err) {
                        showAlert(
                            "ERROR",
                            "INVALID DATA FORMAT (could not parse JSON).",
                        );
                    }
                };
                reader.readAsText(file);
                e.target.value = ""; // Reset
            }

            function resetSystem() {
                showConfirm(
                    "SYSTEM RESET",
                    "WARNING: SYSTEM RESET WILL ERASE ALL DATA. PROCEED?",
                    () => {
                        localStorage.removeItem(STORAGE_KEY);
                        const bundle = {
                            bookmarks: JSON.parse(
                                JSON.stringify(DEFAULT_BOOKMARKS),
                            ),
                            categories: JSON.parse(
                                JSON.stringify(DEFAULT_CATEGORIES),
                            ),
                        };
                        applyDataBundle(bundle);
                        // Do not reset theme on system reset; theme is a UI preference.
                    },
                );
            }

            function renderThemeControls() {
                const container = $(".js-theme-controls-container");
                if (!container) return;
                container.innerHTML = "";

                THEMES.forEach((theme) => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className =
                        "lcars-button lcars-pill lcars-focus-outline lcars-color-dark lcars-settings-action";
                    if (theme.id === currentTheme) {
                        btn.classList.add("theme-active");
                    }
                    btn.textContent = theme.label;
                    btn.onclick = () => {
                        applyTheme(theme.id);
                        renderThemeControls();
                        updateSettingsTileMeta();
                    };
                    container.appendChild(btn);
                });

                updateThemeStatus();
            }

            // Helper to bind click handlers to elements by class selector
            function onClick(selector, handler) {
                const el = $(selector);
                if (el) {
                    el.addEventListener("click", handler);
                }
            }

            // Helper to bind change handlers to elements by class selector
            function onChange(selector, handler) {
                const el = $(selector);
                if (el) {
                    el.addEventListener("change", handler);
                }
            }

            // --- Event Listeners ---
            // Sidebar scroll button functionality
            // Sidebar scroll elements (queried from app root)
            const sidebarScrollUp = $(".js-sidebar-scroll-up");
            const sidebarScrollDown = $(".js-sidebar-scroll-down");
            const sidebarCategories = $(".js-category-sidebar");

            function updateScrollButtons() {
                if (!sidebarCategories) return;
                const { scrollTop, scrollHeight, clientHeight } =
                    sidebarCategories;
                const canScrollUp = scrollTop > 0;
                const canScrollDown =
                    scrollTop + clientHeight < scrollHeight - 1;

                if (sidebarScrollUp)
                    sidebarScrollUp.classList.toggle("disabled", !canScrollUp);
                if (sidebarScrollDown)
                    sidebarScrollDown.classList.toggle(
                        "disabled",
                        !canScrollDown,
                    );
            }

            function scrollSidebar(direction) {
                if (!sidebarCategories) return;
                const scrollAmount = 55; // Approximate height of one category button
                sidebarCategories.scrollBy({
                    top: direction * scrollAmount,
                    behavior: "smooth",
                });
            }

            if (sidebarScrollUp) {
                sidebarScrollUp.addEventListener("click", () =>
                    scrollSidebar(-1),
                );
            }
            if (sidebarScrollDown) {
                sidebarScrollDown.addEventListener("click", () =>
                    scrollSidebar(1),
                );
            }
            if (sidebarCategories) {
                sidebarCategories.addEventListener(
                    "scroll",
                    updateScrollButtons,
                );
                // Initial state
                updateScrollButtons();
                // Update after categories render
                const observer = new MutationObserver(updateScrollButtons);
                observer.observe(sidebarCategories, {
                    childList: true,
                    subtree: true,
                });

                // Keyboard navigation for category buttons
                sidebarCategories.addEventListener("keydown", (e) => {
                    const focusedBtn = document.activeElement;
                    if (
                        !focusedBtn ||
                        !focusedBtn.classList.contains("lcars-sidebar-btn")
                    )
                        return;

                    // Handle Enter/Space to activate category (explicit keyboard activation)
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        focusedBtn.click();
                        return;
                    }

                    // Handle arrow key navigation
                    if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;

                    e.preventDefault();

                    // Get all visible category buttons (flattened)
                    const allButtons = Array.from(
                        sidebarCategories.querySelectorAll(
                            ".lcars-sidebar-btn",
                        ),
                    );
                    const currentIndex = allButtons.indexOf(focusedBtn);

                    let nextIndex;
                    if (e.key === "ArrowUp") {
                        nextIndex =
                            currentIndex <= 0
                                ? allButtons.length - 1
                                : currentIndex - 1;
                    } else {
                        nextIndex =
                            currentIndex >= allButtons.length - 1
                                ? 0
                                : currentIndex + 1;
                    }

                    const nextBtn = allButtons[nextIndex];
                    if (nextBtn) {
                        // Roving tabindex update
                        focusedBtn.tabIndex = -1;
                        nextBtn.tabIndex = 0;

                        nextBtn.focus();
                        // Scroll the button into view
                        nextBtn.scrollIntoView({
                            block: "nearest",
                            behavior: "smooth",
                        });
                    }
                });
            }

            function setupEventListeners() {
                // Category Sidebar Delegation
                if (sidebar) {
                    sidebar.addEventListener("click", (e) => {
                        const btn = e.target.closest(".lcars-sidebar-btn");
                        if (btn && btn.dataset.id) {
                            // Ensure main view is bookmarks when switching category
                            bookmarksView.classList.add("active");
                            settingsView.classList.remove("active");
                            aboutView.classList.remove("active");
                            currentView = "bookmarks";

                            state.currentCategory = btn.dataset.id;
                            saveData();
                            renderCategories();
                            renderGrid();
                        }
                    });
                }

                // Bookmark Grid Delegation
                if (grid) {
                    grid.addEventListener("click", (e) => {
                        // Handle category tile clicks
                        const categoryTile = e.target.closest(
                            ".lcars-tile--category",
                        );
                        if (categoryTile) {
                            // Check if edit pin was clicked
                            if (e.target.closest(".lcars-pin--edit")) {
                                e.preventDefault();
                                e.stopPropagation();
                                const id = categoryTile.dataset.id;
                                const category = walkCategories(
                                    state.categories,
                                    (cat) => {
                                        if (cat.id === id) return cat;
                                        return undefined;
                                    },
                                );
                                if (category) openEditCategoryDialog(category);
                                return;
                            }

                            // Check if open pin was clicked
                            if (e.target.closest(".lcars-pin--open")) {
                                e.preventDefault();
                                e.stopPropagation();
                                state.currentCategory = categoryTile.dataset.id;
                                saveData();
                                renderGrid();
                                renderCategories();
                                return;
                            }

                            // Clicks on tile body do nothing; use footer buttons
                            return;
                        }

                        // Handle bookmark tile clicks
                        const tile = e.target.closest(".lcars-tile--bookmark");
                        if (!tile) return;

                        // Check if edit pin was clicked
                        if (e.target.closest(".lcars-pin--edit")) {
                            e.preventDefault();
                            e.stopPropagation();
                            const id = tile.dataset.id;
                            const bookmark = state.bookmarks.find(
                                (b) => b.id === id,
                            );
                            if (bookmark) openEditDialog(bookmark);
                            return;
                        }

                        // Check if URL pin was clicked
                        if (e.target.closest(".lcars-pin--url")) {
                            e.preventDefault();
                            e.stopPropagation();
                            const id = tile.dataset.id;
                            const bookmark = state.bookmarks.find(
                                (b) => b.id === id,
                            );
                            if (bookmark?.url) {
                                window.open(
                                    bookmark.url,
                                    "_blank",
                                    "noopener,noreferrer",
                                );
                            }
                            return;
                        }

                        // Clicks on the tile body do not trigger open/edit; pins are the only controls
                    });
                }

                if (homeBtn) {
                    homeBtn.addEventListener("click", () => {
                        goHome();
                    });
                }

                onClick(".js-settings-btn", () => {
                    // Switch to settings main view
                    bookmarksView.classList.remove("active");
                    aboutView.classList.remove("active");
                    settingsView.classList.add("active");
                    currentView = "settings";
                    currentSettingsPage = null; // Reset to main settings grid
                    saveData();
                    renderSettingsView();
                    updateStardateDisplay(settingsStardateEl);
                });

                // Settings tile navigation delegation
                if (settingsMainGrid) {
                    settingsMainGrid.addEventListener("click", (e) => {
                        const tile = e.target.closest(".lcars-tile--settings");
                        if (tile && tile.dataset.settingsPage) {
                            navigateToSettingsPage(tile.dataset.settingsPage);
                        }
                    });
                }

                onClick(".js-add-bookmark-btn", () => {
                    bookmarksView.classList.add("active");
                    settingsView.classList.remove("active");
                    aboutView.classList.remove("active");
                    currentView = "bookmarks";
                    saveData();
                    openAddDialog();
                });

                onClick(".js-add-category-btn", () => {
                    bookmarksView.classList.add("active");
                    settingsView.classList.remove("active");
                    aboutView.classList.remove("active");
                    currentView = "bookmarks";
                    saveData();
                    openAddCategoryDialog();
                });

                // Add Entry button: toggle aria-expanded and manage focus
                // Uses JS-controlled .is-open class for keyboard interaction (not CSS :focus-within)
                const addBtn = $(".js-add-btn");
                const addMenu = $(".js-add-menu");
                if (addBtn && addMenu) {
                    const expandable = addBtn.closest(".lcars-expandable");

                    function openMenu() {
                        if (expandable) expandable.classList.add("is-open");
                        addBtn.setAttribute("aria-expanded", "true");
                    }

                    function closeMenu() {
                        if (expandable) expandable.classList.remove("is-open");
                        addBtn.setAttribute("aria-expanded", "false");
                    }

                    function isMenuOpen() {
                        return (
                            expandable &&
                            expandable.classList.contains("is-open")
                        );
                    }

                    // Update aria-expanded based on visual state (for hover)
                    function updateAddMenuExpanded() {
                        const isVisible =
                            window.getComputedStyle(addMenu).display !== "none";
                        addBtn.setAttribute(
                            "aria-expanded",
                            isVisible ? "true" : "false",
                        );
                    }

                    // Monitor hover changes on the expandable container
                    if (expandable) {
                        expandable.addEventListener("mouseenter", () => {
                            requestAnimationFrame(updateAddMenuExpanded);
                        });
                        expandable.addEventListener("mouseleave", () => {
                            // Only close if not explicitly opened via keyboard
                            if (!isMenuOpen()) {
                                requestAnimationFrame(updateAddMenuExpanded);
                            }
                        });
                    }

                    // Click on button opens menu and focuses first item
                    addBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        openMenu();
                        const firstItem = $(".js-add-bookmark-btn");
                        if (firstItem) firstItem.focus();
                    });

                    // Keyboard: Enter/Space opens menu and moves focus to first item
                    addBtn.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            openMenu();
                            const firstItem = $(".js-add-bookmark-btn");
                            if (firstItem) firstItem.focus();
                        }
                    });

                    // Escape closes the menu and returns focus to trigger
                    if (expandable) {
                        expandable.addEventListener("keydown", (e) => {
                            if (e.key === "Escape" && isMenuOpen()) {
                                e.preventDefault();
                                e.stopPropagation();
                                closeMenu();
                                addBtn.focus();
                            }
                        });

                        // Close menu when focus leaves the expandable entirely
                        expandable.addEventListener("focusout", (e) => {
                            // Use setTimeout to allow focus to settle on the new element
                            setTimeout(() => {
                                if (
                                    !expandable.contains(document.activeElement)
                                ) {
                                    closeMenu();
                                }
                            }, 0);
                        });
                    }
                }

                onClick(".js-about-btn", () => {
                    bookmarksView.classList.remove("active");
                    settingsView.classList.remove("active");
                    aboutView.classList.add("active");
                    currentView = "about";
                    saveData();
                    updateStardateDisplay(aboutStardateEl);
                });

                bookmarkForm.addEventListener("submit", saveBookmark);
                categoryForm.addEventListener("submit", saveCategory);

                // Cancel button event listeners for dialogs
                if (bookmarkCancelBtn) {
                    bookmarkCancelBtn.addEventListener("click", () =>
                        bookmarkDialog.close(),
                    );
                }
                if (categoryCancelBtn) {
                    categoryCancelBtn.addEventListener("click", () =>
                        categoryDialog.close(),
                    );
                }

                // Keyboard Shortcuts
                document.addEventListener("keydown", (e) => {
                    if (e.altKey) {
                        switch (e.key.toLowerCase()) {
                            case "b":
                                e.preventDefault();
                                // Alt+B: add bookmark directly
                                $(".js-add-bookmark-btn")?.click();
                                break;
                            case "s":
                                e.preventDefault();
                                // Switch to settings main view via keyboard
                                bookmarksView.classList.remove("active");
                                aboutView.classList.remove("active");
                                settingsView.classList.add("active");
                                currentView = "settings";
                                currentSettingsPage = null; // Reset to main settings grid
                                saveData();
                                renderSettingsView();
                                updateStardateDisplay(settingsStardateEl);
                                break;
                            case "c":
                                e.preventDefault();
                                // Alt+C: open add category dialog
                                openAddCategoryDialog();
                                break;
                            case "h":
                                e.preventDefault();
                                goHome();
                                break;
                        }
                    }
                });

                // Settings data actions
                onClick(".js-export-btn-main", exportData);
                onClick(".js-import-btn-main", triggerImport);
                onClick(".js-reset-btn-main", resetSystem);
                onClick(".js-add-category-btn-main", () => {
                    addCategory(null);
                });
                onChange(".js-import-input", handleImport);

                // Theme controls
                renderThemeControls();

                // Landing category select
                if (landingCategorySelect) {
                    landingCategorySelect.addEventListener("change", (e) => {
                        const value = e.target.value;
                        if (value) {
                            state.landingCategoryId = value;
                            saveData();
                            updateSettingsTileMeta();
                        }
                    });
                }
                renderLandingCategoryOptions();

                // Dialog close on ESC
                bookmarkDialog.addEventListener("cancel", (e) => {
                    e.preventDefault();
                    bookmarkDialog.close();
                });

                categoryDialog.addEventListener("cancel", (e) => {
                    e.preventDefault();
                    categoryDialog.close();
                });
            }

            // Start
            init();
        </script>
    </body>
</html>
